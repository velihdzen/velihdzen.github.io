{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"source/CNAME","path":"CNAME","modified":0,"renderable":0},{"_id":"source/downloads/code/echo_server.rs","path":"downloads/code/echo_server.rs","modified":0,"renderable":0},{"_id":"themes/hiker/source/css/archive.css","path":"css/archive.css","modified":0,"renderable":1},{"_id":"themes/hiker/source/css/dialog.css","path":"css/dialog.css","modified":0,"renderable":1},{"_id":"themes/hiker/source/css/header-post.css","path":"css/header-post.css","modified":0,"renderable":1},{"_id":"themes/hiker/source/css/home.css","path":"css/home.css","modified":0,"renderable":1},{"_id":"themes/hiker/source/css/style.styl","path":"css/style.styl","modified":0,"renderable":1},{"_id":"themes/hiker/source/css/vdonate.css","path":"css/vdonate.css","modified":0,"renderable":1},{"_id":"themes/hiker/source/fancybox/fancybox_loading.gif","path":"fancybox/fancybox_loading.gif","modified":0,"renderable":1},{"_id":"themes/hiker/source/fancybox/blank.gif","path":"fancybox/blank.gif","modified":0,"renderable":1},{"_id":"themes/hiker/source/fancybox/fancybox_loading@2x.gif","path":"fancybox/fancybox_loading@2x.gif","modified":0,"renderable":1},{"_id":"themes/hiker/source/fancybox/fancybox_overlay.png","path":"fancybox/fancybox_overlay.png","modified":0,"renderable":1},{"_id":"themes/hiker/source/fancybox/fancybox_sprite.png","path":"fancybox/fancybox_sprite.png","modified":0,"renderable":1},{"_id":"themes/hiker/source/fancybox/fancybox_sprite@2x.png","path":"fancybox/fancybox_sprite@2x.png","modified":0,"renderable":1},{"_id":"themes/hiker/source/fancybox/jquery.fancybox.css","path":"fancybox/jquery.fancybox.css","modified":0,"renderable":1},{"_id":"themes/hiker/source/fancybox/jquery.fancybox.js","path":"fancybox/jquery.fancybox.js","modified":0,"renderable":1},{"_id":"themes/hiker/source/fancybox/jquery.fancybox.pack.js","path":"fancybox/jquery.fancybox.pack.js","modified":0,"renderable":1},{"_id":"themes/hiker/source/js/dialog.js","path":"js/dialog.js","modified":0,"renderable":1},{"_id":"themes/hiker/source/js/home.js","path":"js/home.js","modified":0,"renderable":1},{"_id":"themes/hiker/source/js/insight.js","path":"js/insight.js","modified":0,"renderable":1},{"_id":"themes/hiker/source/js/scripts.js","path":"js/scripts.js","modified":0,"renderable":1},{"_id":"themes/hiker/source/js/totop.js","path":"js/totop.js","modified":0,"renderable":1},{"_id":"themes/hiker/source/js/vdonate.js","path":"js/vdonate.js","modified":0,"renderable":1},{"_id":"themes/hiker/source/preview/browser-support.png","path":"preview/browser-support.png","modified":0,"renderable":1},{"_id":"themes/hiker/source/preview/donation-btn.png","path":"preview/donation-btn.png","modified":0,"renderable":1},{"_id":"themes/hiker/source/preview/preview-abstract.png","path":"preview/preview-abstract.png","modified":0,"renderable":1},{"_id":"themes/hiker/source/preview/theme-color.png","path":"preview/theme-color.png","modified":0,"renderable":1},{"_id":"themes/hiker/source/css/bootstrap.css","path":"css/bootstrap.css","modified":0,"renderable":1},{"_id":"themes/hiker/source/js/bootstrap.js","path":"js/bootstrap.js","modified":0,"renderable":1},{"_id":"themes/hiker/source/js/jquery-3.1.1.min.js","path":"js/jquery-3.1.1.min.js","modified":0,"renderable":1},{"_id":"themes/hiker/source/css/fonts/fontawesome-webfont.eot","path":"css/fonts/fontawesome-webfont.eot","modified":0,"renderable":1},{"_id":"themes/hiker/source/css/fonts/fontawesome-webfont.woff","path":"css/fonts/fontawesome-webfont.woff","modified":0,"renderable":1},{"_id":"themes/hiker/source/css/images/avatar.jpg","path":"css/images/avatar.jpg","modified":0,"renderable":1},{"_id":"themes/hiker/source/css/images/homelogo.jpg","path":"css/images/homelogo.jpg","modified":0,"renderable":1},{"_id":"themes/hiker/source/css/images/mylogo.jpg","path":"css/images/mylogo.jpg","modified":0,"renderable":1},{"_id":"themes/hiker/source/css/images/mylogo.png","path":"css/images/mylogo.png","modified":0,"renderable":1},{"_id":"themes/hiker/source/css/images/rocket.png","path":"css/images/rocket.png","modified":0,"renderable":1},{"_id":"themes/hiker/source/fancybox/helpers/fancybox_buttons.png","path":"fancybox/helpers/fancybox_buttons.png","modified":0,"renderable":1},{"_id":"themes/hiker/source/fancybox/helpers/jquery.fancybox-buttons.css","path":"fancybox/helpers/jquery.fancybox-buttons.css","modified":0,"renderable":1},{"_id":"themes/hiker/source/fancybox/helpers/jquery.fancybox-buttons.js","path":"fancybox/helpers/jquery.fancybox-buttons.js","modified":0,"renderable":1},{"_id":"themes/hiker/source/fancybox/helpers/jquery.fancybox-media.js","path":"fancybox/helpers/jquery.fancybox-media.js","modified":0,"renderable":1},{"_id":"themes/hiker/source/fancybox/helpers/jquery.fancybox-thumbs.css","path":"fancybox/helpers/jquery.fancybox-thumbs.css","modified":0,"renderable":1},{"_id":"themes/hiker/source/fancybox/helpers/jquery.fancybox-thumbs.js","path":"fancybox/helpers/jquery.fancybox-thumbs.js","modified":0,"renderable":1},{"_id":"themes/hiker/source/css/fonts/FontAwesome.otf","path":"css/fonts/FontAwesome.otf","modified":0,"renderable":1},{"_id":"themes/hiker/source/css/fonts/fontawesome-webfont.ttf","path":"css/fonts/fontawesome-webfont.ttf","modified":0,"renderable":1},{"_id":"themes/hiker/source/css/images/sample.jpg","path":"css/images/sample.jpg","modified":0,"renderable":1},{"_id":"themes/hiker/source/css/fonts/fontawesome-webfont.svg","path":"css/fonts/fontawesome-webfont.svg","modified":0,"renderable":1},{"_id":"themes/hiker/source/preview/preview-mobile.png","path":"preview/preview-mobile.png","modified":0,"renderable":1},{"_id":"themes/hiker/source/css/images/pose.jpg","path":"css/images/pose.jpg","modified":0,"renderable":1},{"_id":"themes/hiker/source/css/images/home-bg.jpg","path":"css/images/home-bg.jpg","modified":0,"renderable":1},{"_id":"themes/hiker/source/preview/code-theme.jpg","path":"preview/code-theme.jpg","modified":0,"renderable":1},{"_id":"themes/hiker/source/css/images/Windmills.jpg","path":"css/images/Windmills.jpg","modified":0,"renderable":1},{"_id":"themes/hiker/source/preview/preview-pc.png","path":"preview/preview-pc.png","modified":0,"renderable":1}],"Cache":[{"_id":"source/CNAME","hash":"a431652667c5c250f5d6cfd58f36ee4b743e1a40","modified":1531833699049},{"_id":"themes/hiker/.git","hash":"138ad5311d62fbf6d9d029c9d94d997fb191138d","modified":1531829339696},{"_id":"themes/hiker/.gitignore","hash":"58d26d4b5f2f94c2d02a4e4a448088e4a2527c77","modified":1531818064000},{"_id":"themes/hiker/.travis.yml","hash":"24851843a40973daaee47b2697e8b0dc4e6556b3","modified":1531818064000},{"_id":"themes/hiker/Gruntfile.js","hash":"71adaeaac1f3cc56e36c49d549b8d8a72235c9b9","modified":1531818064000},{"_id":"themes/hiker/LICENSE","hash":"4ea4173f28adf2f688a59e3c5e6fa833bcdf7ced","modified":1531818064000},{"_id":"themes/hiker/README.cn.md","hash":"e87c3744f1fe3edeaad479a90e7e1aa66bbf6fd2","modified":1531818064000},{"_id":"themes/hiker/README.md","hash":"4973def0c3cb2ac856071de479d11ff76087b8c6","modified":1531818064000},{"_id":"themes/hiker/_config.yml","hash":"e660ce9d61f97a183d4df5adc92f63e903d17b48","modified":1533888752614},{"_id":"themes/hiker/package.json","hash":"ac7430d36de467f41a686fb716c8538c52f0e206","modified":1531818064000},{"_id":"source/_drafts/bt.md","hash":"176253bd36e93aec4973a2d0e09b70721d76434b","modified":1533889245859},{"_id":"source/_posts/blockchain.md","hash":"3c562fcc002da5e8bc64d281e6a67d90c4ca5b5f","modified":1533889279649},{"_id":"source/_posts/hello-world.md","hash":"8caa744b7d8b222158dab08e9e7990c33050933c","modified":1531833699049},{"_id":"source/_posts/tcp.md","hash":"602a232c9625aef5816e670781f5009254a64f59","modified":1533889360596},{"_id":"source/_posts/µtp.md","hash":"31d4e28dbeb5a84494d14a5169bf585c81549030","modified":1533889274033},{"_id":"source/about/index.md","hash":"9fa61ee360e96cb902169640084f3a8d358b333d","modified":1533382173608},{"_id":"source/tags/index.md","hash":"2f7d5e58da960f1aeeeaf8bf12f9d5e38c39ea73","modified":1531833699049},{"_id":"themes/hiker/languages/de.yml","hash":"3e244f9c48b641edd821bdeb743bdbcd0919685f","modified":1531818064000},{"_id":"themes/hiker/languages/default.yml","hash":"b43df4b426335107d87fe27bb0a8279ec83a4272","modified":1531818064000},{"_id":"themes/hiker/languages/en.yml","hash":"b43df4b426335107d87fe27bb0a8279ec83a4272","modified":1531818064000},{"_id":"themes/hiker/languages/es.yml","hash":"76edb1171b86532ef12cfd15f5f2c1ac3949f061","modified":1531818064000},{"_id":"themes/hiker/languages/fr.yml","hash":"f5ec801074df04e1e1fd097fa7cbdf7f57330374","modified":1531818064000},{"_id":"themes/hiker/languages/nl.yml","hash":"12ed59faba1fc4e8cdd1d42ab55ef518dde8039c","modified":1531818064000},{"_id":"themes/hiker/languages/no.yml","hash":"965a171e70347215ec726952e63f5b47930931ef","modified":1531818064000},{"_id":"themes/hiker/languages/pt.yml","hash":"46bd5f121f4704e2cd6c0950ec18b549f03bfe5c","modified":1531818064000},{"_id":"themes/hiker/languages/ru.yml","hash":"4fda301bbd8b39f2c714e2c934eccc4b27c0a2b0","modified":1531818064000},{"_id":"themes/hiker/languages/zh-CN.yml","hash":"24c12fc7e4ff83ee3fa4dff17ce961bb5fb1a393","modified":1531818064000},{"_id":"themes/hiker/languages/zh-TW.yml","hash":"5e641b8a83a89d5ef12dfc008d2e75adbea0e24b","modified":1531818064000},{"_id":"themes/hiker/layout/archive.ejs","hash":"877ed5677c6fc12a3050843dd3d97cb6b53caceb","modified":1531818064000},{"_id":"themes/hiker/layout/categories.ejs","hash":"ac33c728b49863d3ca961547d33209618f591e4f","modified":1531818064000},{"_id":"themes/hiker/layout/category.ejs","hash":"765426a9c8236828dc34759e604cc2c52292835a","modified":1531818064000},{"_id":"themes/hiker/layout/index.ejs","hash":"aa1b4456907bdb43e629be3931547e2d29ac58c8","modified":1531818064000},{"_id":"themes/hiker/layout/layout.ejs","hash":"aa685e9762a356f9b677e6f9d17e04694492fb83","modified":1531818064000},{"_id":"themes/hiker/layout/page.ejs","hash":"7d80e4e36b14d30a7cd2ac1f61376d9ebf264e8b","modified":1531818064000},{"_id":"themes/hiker/layout/post.ejs","hash":"7d80e4e36b14d30a7cd2ac1f61376d9ebf264e8b","modified":1531818064000},{"_id":"themes/hiker/layout/tag.ejs","hash":"eaa7b4ccb2ca7befb90142e4e68995fb1ea68b2e","modified":1531818064000},{"_id":"themes/hiker/layout/tags.ejs","hash":"340ded907f5f52ef73c50bb9f1f27bf2f5de3fa7","modified":1531818064000},{"_id":"themes/hiker/scripts/fancybox.js","hash":"aa411cd072399df1ddc8e2181a3204678a5177d9","modified":1531818064000},{"_id":"source/_posts/tcp/todo.mdx","hash":"90d7ea919af484e49846964c1a2edf3d88720ee2","modified":1532931829016},{"_id":"source/downloads/code/echo_server.rs","hash":"72bc85f2231a41ed51f82848e3c22382d85e32ff","modified":1533382579951},{"_id":"source/downloads/code/utp_header_format.html","hash":"3cd1268fc5232749c6269a51af79f85df232957e","modified":1533397987636},{"_id":"themes/hiker/layout/_partial/after-footer.ejs","hash":"cf844d9dda22b63e990c2b9e5c8bee82c41fd3aa","modified":1531818064000},{"_id":"themes/hiker/layout/_partial/archive-post.ejs","hash":"55d661b63ffe41489bffe4d0570af50a1b952d63","modified":1531818064000},{"_id":"themes/hiker/layout/_partial/article.ejs","hash":"5221db20b992f85f125f4babf37a08c180eb1d0b","modified":1531818064000},{"_id":"themes/hiker/layout/_partial/baidu-analytics.ejs","hash":"5776714a003d2b96b04b5399f67e0899d821247e","modified":1531818064000},{"_id":"themes/hiker/layout/_partial/archive.ejs","hash":"538346df9267cb701bb985faf0d5de2fa4c1e4e7","modified":1531818064000},{"_id":"themes/hiker/layout/_partial/cnzz-analytics.ejs","hash":"87410fedf15383f119706c96f71552be14248d57","modified":1531818064000},{"_id":"themes/hiker/layout/_partial/copyright.ejs","hash":"e5283a10763a6c279b8221a56a5e8845fdd6d725","modified":1531818064000},{"_id":"themes/hiker/layout/_partial/dialog.ejs","hash":"453934257d0efa8124afc686f299e7a21e7a1c4d","modified":1531818064000},{"_id":"themes/hiker/layout/_partial/comment.ejs","hash":"1471bafc3e1b348cdd081ad8f79e6656323ec04b","modified":1531818064000},{"_id":"themes/hiker/layout/_partial/donate.ejs","hash":"046e168c6aad9889199c9a48b57dc973b4f46dab","modified":1531818064000},{"_id":"themes/hiker/layout/_partial/facebook-sdk.ejs","hash":"06038db50d2e1febdefa3f8e1512b332c7da5a17","modified":1531818064000},{"_id":"themes/hiker/layout/_partial/footer.ejs","hash":"dfbfe362953c8d44c875554f55fad74bd80b2afb","modified":1531818064000},{"_id":"themes/hiker/layout/_partial/gauges-analytics.ejs","hash":"aad6312ac197d6c5aaf2104ac863d7eba46b772a","modified":1531818064000},{"_id":"themes/hiker/layout/_partial/google-analytics.ejs","hash":"f921e7f9223d7c95165e0f835f353b2938e40c45","modified":1531818064000},{"_id":"themes/hiker/layout/_partial/head.ejs","hash":"e2c9ac22c97944c9c25a8feb6d2ff712b07e6ce7","modified":1532275284455},{"_id":"themes/hiker/layout/_partial/header-post.ejs","hash":"f30b6833bdb54e5446a2078a792e4d9ef4551c24","modified":1531818064000},{"_id":"themes/hiker/layout/_partial/header.ejs","hash":"09b8060c37b578785efdd8e06fa1388b816d44ca","modified":1531818064000},{"_id":"themes/hiker/layout/_partial/mobile-nav.ejs","hash":"e952a532dfc583930a666b9d4479c32d4a84b44e","modified":1531818064000},{"_id":"themes/hiker/layout/_partial/tencent-analytics.ejs","hash":"93120ad06c5d73ca777470faf570e993a805e049","modified":1531818064000},{"_id":"themes/hiker/layout/_partial/sidebar.ejs","hash":"930da35cc2d447a92e5ee8f835735e6fd2232469","modified":1531818064000},{"_id":"themes/hiker/layout/_widget/archive.ejs","hash":"9fffde4e794b35f07c96eaec6d9373a40014da8f","modified":1531818064000},{"_id":"themes/hiker/layout/_widget/category.ejs","hash":"dd1e5af3c6af3f5d6c85dfd5ca1766faed6a0b05","modified":1531818064000},{"_id":"themes/hiker/layout/_partial/busuanzi-analytics.ejs","hash":"7de568681c315e88127bec120b8100ce6640210f","modified":1531818064000},{"_id":"themes/hiker/layout/_widget/recent_posts.ejs","hash":"0d4f064733f8b9e45c0ce131fe4a689d570c883a","modified":1531818064000},{"_id":"themes/hiker/layout/_widget/social.ejs","hash":"013beb5d78dfe34507b766f551b4a43ff628a5fe","modified":1531818064000},{"_id":"themes/hiker/layout/_widget/tag.ejs","hash":"2de380865df9ab5f577f7d3bcadf44261eb5faae","modified":1531818064000},{"_id":"themes/hiker/layout/_widget/tagcloud.ejs","hash":"b4a2079101643f63993dcdb32925c9b071763b46","modified":1531818064000},{"_id":"themes/hiker/layout/search/index-mobile.ejs","hash":"50a727ac1dfe3073eb6fa6699ba01e66f4ac41c0","modified":1531818064000},{"_id":"themes/hiker/layout/search/baidu.ejs","hash":"3e603a702d20c53fd3bcbeb570a16a86d54781ce","modified":1531818064000},{"_id":"themes/hiker/layout/search/index.ejs","hash":"a027a663baaffa212f5eb4947d43008419376177","modified":1531818064000},{"_id":"themes/hiker/layout/search/insight.ejs","hash":"c97ef6478f8cd45458614cd78511c23cbd4e7a28","modified":1531818064000},{"_id":"themes/hiker/layout/search/swiftype.ejs","hash":"379e66d2c13526e72e4120c443f95fccf4edef71","modified":1531818064000},{"_id":"themes/hiker/source/css/_extend.styl","hash":"5a2b18b03c18c92f130771aa97737e100202d21b","modified":1531818064000},{"_id":"themes/hiker/source/css/_variables.styl","hash":"fa78bacee554503760d9309b3ed10ec85dfcead1","modified":1532258721350},{"_id":"themes/hiker/source/css/archive.css","hash":"17cc72203cad1b0be66008d662c7494507aaee8b","modified":1531818064000},{"_id":"themes/hiker/source/css/dialog.css","hash":"5e0333adf3f496e0d443767fe228a1d4b1a2bafc","modified":1531818064000},{"_id":"themes/hiker/source/css/header-post.css","hash":"3f6d1f5593a353b4b05a67ee14e04ec9c986db21","modified":1531818064000},{"_id":"themes/hiker/source/css/home.css","hash":"2a7bfef438468b5b8be3f84ea6818156d371077d","modified":1531818064000},{"_id":"themes/hiker/source/css/style.styl","hash":"cbf244726bf1fde4d278b4d3768e289f9f64ae35","modified":1532258770257},{"_id":"themes/hiker/source/css/vdonate.css","hash":"bca2d291a71e7358654c51f23e8bfb467b2bc8b2","modified":1531818064000},{"_id":"themes/hiker/source/fancybox/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1531818064000},{"_id":"themes/hiker/source/fancybox/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1531818064000},{"_id":"themes/hiker/source/fancybox/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1531818064000},{"_id":"themes/hiker/source/fancybox/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1531818064000},{"_id":"themes/hiker/source/fancybox/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1531818064000},{"_id":"themes/hiker/source/fancybox/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1531818064000},{"_id":"themes/hiker/source/fancybox/jquery.fancybox.css","hash":"aaa582fb9eb4b7092dc69fcb2d5b1c20cca58ab6","modified":1531818064000},{"_id":"themes/hiker/source/fancybox/jquery.fancybox.js","hash":"d08b03a42d5c4ba456ef8ba33116fdbb7a9cabed","modified":1531818064000},{"_id":"themes/hiker/source/fancybox/jquery.fancybox.pack.js","hash":"9e0d51ca1dbe66f6c0c7aefd552dc8122e694a6e","modified":1531818064000},{"_id":"themes/hiker/source/js/dialog.js","hash":"01e8b337c1721e0486fd5044f98b233e84ba1985","modified":1531818064000},{"_id":"themes/hiker/source/js/home.js","hash":"e403c3290d76c5f58571cbfe4414236e41a7ac94","modified":1531818064000},{"_id":"themes/hiker/source/js/insight.js","hash":"f79ab175d1c8c4fb59328ee4fd9eb95808eb0be5","modified":1531818064000},{"_id":"themes/hiker/source/js/scripts.js","hash":"e06a8948375df71cbf77abf8617db438ece811b3","modified":1531818064000},{"_id":"themes/hiker/source/js/totop.js","hash":"29bb40144ac238d22b25d59df465aff8dc38bfd0","modified":1531818064000},{"_id":"themes/hiker/source/js/vdonate.js","hash":"5738414c642d30e43943a69287b3d25a0b6be135","modified":1531818064000},{"_id":"themes/hiker/source/preview/browser-support.png","hash":"a6d8498553550c6b18a8f22bcd2f53c993c7d677","modified":1531818064000},{"_id":"themes/hiker/source/preview/donation-btn.png","hash":"ad78b1605b162e2399a1cdc5232f6a44298dba6c","modified":1531818064000},{"_id":"themes/hiker/source/preview/preview-abstract.png","hash":"3d18ad9ba38fe24770ba6758d8f1bb242f669ce3","modified":1531818064000},{"_id":"themes/hiker/source/preview/theme-color.png","hash":"725130ceea5e41bb2cc60b31e45275b4b0cc77b3","modified":1531818064000},{"_id":"source/_posts/µtp/udp_utp_header.png","hash":"c5f80e8516d5c7f55244a105e973e9cd4f27f070","modified":1533398087000},{"_id":"source/_posts/tcp/tcp_header.png","hash":"69d8d319c43fa7ce0be86f378572c8ee05e9c605","modified":1532088268872},{"_id":"themes/hiker/layout/_widget/curtains.ejs","hash":"630c11a237602b478df5215982face6681943f21","modified":1531818064000},{"_id":"themes/hiker/source/css/bootstrap.css","hash":"64fdc2e7c3f8a164d21c5632b5adbbb9990ea802","modified":1531818064000},{"_id":"themes/hiker/source/js/bootstrap.js","hash":"3b965a36a6b08854ad6eddedf85c5319fd392b4a","modified":1531818064000},{"_id":"themes/hiker/source/js/jquery-3.1.1.min.js","hash":"f647a6d37dc4ca055ced3cf64bbc1f490070acba","modified":1531818064000},{"_id":"source/_posts/tcp/congestion_control_example.png","hash":"02433df0635516013be7c5d96affa7d20cc883e7","modified":1533478758000},{"_id":"source/_posts/tcp/tcp_connection.png","hash":"987f536dca3acefdde97178c2087276fb69c41e1","modified":1532241966764},{"_id":"source/_posts/tcp/sliding_window.png","hash":"27e68439f11775d0816b712605458a940ad255bf","modified":1532857309241},{"_id":"themes/hiker/layout/_partial/post/busuanzi-analytics.ejs","hash":"4ef5022062c8ee59f3413bc92e6b3ae0d5020738","modified":1531818064000},{"_id":"themes/hiker/layout/_partial/post/category.ejs","hash":"877a164bb13b46756eb111ec7bfe338a1eb36ad1","modified":1531818064000},{"_id":"themes/hiker/layout/_partial/post/mathjax.ejs","hash":"571c19f57c2b38ac5cd9b8f811cfad53b38616cf","modified":1531818064000},{"_id":"themes/hiker/layout/_partial/post/date.ejs","hash":"380985bb414f9a0d517834f65cce57bc0b493d8c","modified":1531818064000},{"_id":"themes/hiker/layout/_partial/post/nav.ejs","hash":"16a904de7bceccbb36b4267565f2215704db2880","modified":1531818064000},{"_id":"themes/hiker/layout/_partial/post/tag.ejs","hash":"2fcb0bf9c8847a644167a27824c9bb19ac74dd14","modified":1531818064000},{"_id":"themes/hiker/layout/_partial/post/title.ejs","hash":"a61267f27f2148321e549344be91dbc4e22e1a48","modified":1531818064000},{"_id":"themes/hiker/layout/_partial/post/urlconvert.ejs","hash":"2133f1029632417f9043b9d4749d580ed0c75db0","modified":1531818064000},{"_id":"themes/hiker/source/css/_util/grid.styl","hash":"0bf55ee5d09f193e249083602ac5fcdb1e571aed","modified":1531818064000},{"_id":"themes/hiker/source/css/_util/mixin.styl","hash":"44f32767d9fd3c1c08a60d91f181ee53c8f0dbb3","modified":1531818064000},{"_id":"themes/hiker/source/css/_partial/archive.styl","hash":"28e78ec6e703417c50447c4710ad4bcf6cf48008","modified":1531818064000},{"_id":"themes/hiker/source/css/_partial/article.styl","hash":"854aa3b19edcc82fcfd2d85af49bf867f4b14a45","modified":1531818064000},{"_id":"themes/hiker/source/css/_partial/comment.styl","hash":"f23dbf9c1224559314f7d10b7fee030a9ffab58a","modified":1531818064000},{"_id":"themes/hiker/source/css/_partial/footer.styl","hash":"ce9f600140d5cd246b59374f615c8a512bc5ecab","modified":1531818064000},{"_id":"themes/hiker/source/css/_partial/header-post.styl","hash":"e95431443eb28d45390de733068f87134e5780da","modified":1531818064000},{"_id":"themes/hiker/source/css/_partial/header.styl","hash":"4bbc6be125b55de743ad00a5ddf751eba1f617c4","modified":1531818064000},{"_id":"themes/hiker/source/css/_partial/highlight.styl","hash":"86aa65cbefd4ac7e1bd5b56872af3c34f2b98463","modified":1532261713763},{"_id":"themes/hiker/source/css/_partial/insight.styl","hash":"8cd23d8f0ce2d083dd7409a1a95315029070cbb8","modified":1531818064000},{"_id":"themes/hiker/source/css/_partial/mobile.styl","hash":"fcfbaf24634519063af46953e0eb733a8ada5556","modified":1531818064000},{"_id":"themes/hiker/source/css/_partial/sidebar-aside.styl","hash":"1b4caeb15892b2c34cc063065b9c408eb00216a6","modified":1531818064000},{"_id":"themes/hiker/source/css/_partial/sidebar-bottom.styl","hash":"36886d5436bfafbf980539be8dbc419631b8b6ee","modified":1531818064000},{"_id":"themes/hiker/source/css/_partial/sidebar.styl","hash":"e93ca6bb5b709accd667b939980ad39582fe062b","modified":1531818064000},{"_id":"themes/hiker/source/css/fonts/fontawesome-webfont.eot","hash":"7619748fe34c64fb157a57f6d4ef3678f63a8f5e","modified":1531818064000},{"_id":"themes/hiker/source/css/fonts/fontawesome-webfont.woff","hash":"04c3bf56d87a0828935bd6b4aee859995f321693","modified":1531818064000},{"_id":"themes/hiker/source/css/images/avatar.jpg","hash":"d685c61842df6ff3f44a96ba4ac15117502168ee","modified":1531818411000},{"_id":"themes/hiker/source/css/images/homelogo.jpg","hash":"4bfc9650c4fd6e60b09ae29f888a819cdf88e9fe","modified":1531818412000},{"_id":"themes/hiker/source/css/images/mylogo.jpg","hash":"8a890ea06da34c2be81ca28d96f3d44a2d7fcdd7","modified":1531818412000},{"_id":"themes/hiker/source/css/images/mylogo.png","hash":"6c6233232a427cd33129e2ea6268e878a57e9ac7","modified":1531818412000},{"_id":"themes/hiker/source/css/images/rocket.png","hash":"6dee0406955aa9b7a261161d30f2538a671e806b","modified":1531818413000},{"_id":"themes/hiker/source/fancybox/helpers/fancybox_buttons.png","hash":"e385b139516c6813dcd64b8fc431c364ceafe5f3","modified":1531818064000},{"_id":"themes/hiker/source/fancybox/helpers/jquery.fancybox-buttons.css","hash":"1a9d8e5c22b371fcc69d4dbbb823d9c39f04c0c8","modified":1531818064000},{"_id":"themes/hiker/source/fancybox/helpers/jquery.fancybox-buttons.js","hash":"dc3645529a4bf72983a39fa34c1eb9146e082019","modified":1531818064000},{"_id":"themes/hiker/source/fancybox/helpers/jquery.fancybox-media.js","hash":"294420f9ff20f4e3584d212b0c262a00a96ecdb3","modified":1531818064000},{"_id":"themes/hiker/source/fancybox/helpers/jquery.fancybox-thumbs.css","hash":"4ac329c16a5277592fc12a37cca3d72ca4ec292f","modified":1531818064000},{"_id":"themes/hiker/source/fancybox/helpers/jquery.fancybox-thumbs.js","hash":"47da1ae5401c24b5c17cc18e2730780f5c1a7a0c","modified":1531818064000},{"_id":"themes/hiker/layout/_partial/post/gallery.ejs","hash":"30028f10a4f03561e53da323d06b292e1ae7990c","modified":1531818064000},{"_id":"themes/hiker/source/css/fonts/FontAwesome.otf","hash":"b5b4f9be85f91f10799e87a083da1d050f842734","modified":1531818064000},{"_id":"themes/hiker/source/css/fonts/fontawesome-webfont.ttf","hash":"7f09c97f333917034ad08fa7295e916c9f72fd3f","modified":1531818064000},{"_id":"source/_posts/tcp/wireshark.png","hash":"14661db4e3571db5e1315f221773ec37e6f67b6b","modified":1532264688005},{"_id":"themes/hiker/source/css/images/sample.jpg","hash":"36b49a2f0183ac20207c44a8172e410e4d6865e6","modified":1531818413000},{"_id":"themes/hiker/source/css/fonts/fontawesome-webfont.svg","hash":"46fcc0194d75a0ddac0a038aee41b23456784814","modified":1531818064000},{"_id":"source/_posts/µtp/wireshark.png","hash":"f8da641e627808d136eeb69f7abdb497008b2c75","modified":1533472159000},{"_id":"themes/hiker/source/preview/preview-mobile.png","hash":"7679a50aef93fc364cbcee4a52cd84604bf741b1","modified":1531818064000},{"_id":"themes/hiker/source/css/images/pose.jpg","hash":"4d394a662e7d6d2de6a4598688c7cd3dba5c2fa3","modified":1531818412000},{"_id":"themes/hiker/source/css/images/home-bg.jpg","hash":"e8dcdb6e03bd02d831bae593feccb7028c9dc5e9","modified":1531818411000},{"_id":"themes/hiker/source/preview/code-theme.jpg","hash":"8c8512fd04e6106033656d10e92d51de76cca6d8","modified":1531818064000},{"_id":"themes/hiker/source/css/images/Windmills.jpg","hash":"19e411118d22c321710c1f2aeca14e27678e369e","modified":1531818413000},{"_id":"themes/hiker/source/preview/preview-pc.png","hash":"2471e0697938721e4c5d7c66940e165c59a31a0f","modified":1531818064000},{"_id":"public/content.json","hash":"001859f9a6f57f693f2776a812000b43a9e34732","modified":1533889379120},{"_id":"public/about/index.html","hash":"6499cfd96992d18fe0a11242650350d63d8e792b","modified":1533889379217},{"_id":"public/tags/index.html","hash":"533852d5ed3c695285f854b3c467bfb35b243e83","modified":1533889379217},{"_id":"public/2018/07/17/hello-world/index.html","hash":"53e273ce78b41a7e2445d3a18800e71df1c4275e","modified":1533889379217},{"_id":"public/archives/index.html","hash":"c4e45b94241a4c73190ab8fb9676d51432b02afc","modified":1533889379217},{"_id":"public/archives/2018/index.html","hash":"909a4df5febfbf186f2db22fe0ab5d446276321b","modified":1533889379217},{"_id":"public/archives/2018/07/index.html","hash":"0a8623cd6dd48c8131392db80a4b933a7a1f5c0f","modified":1533889379217},{"_id":"public/archives/2018/08/index.html","hash":"fd0d011dfaca71ed7206d21dcb3977e327ba917d","modified":1533889379217},{"_id":"public/tags/BlockChain/index.html","hash":"df051fdd5ecbb0cb14be8f4d05d8c8fb558549f1","modified":1533889379218},{"_id":"public/tags/Essay/index.html","hash":"947449721aae3415f10dc1b4a38cc263417f3037","modified":1533889379218},{"_id":"public/tags/Network/index.html","hash":"10b7f17b99daa230574cee54c15d29c416ab4624","modified":1533889379218},{"_id":"public/tags/BT/index.html","hash":"f36cf46eaf6bab2252fe73a542e7d23059d6f624","modified":1533889379218},{"_id":"public/downloads/code/utp_header_format.html","hash":"4a240788d23af0fbdb3dd44120a88346f0002b16","modified":1533889379218},{"_id":"public/2018/08/04/µtp/index.html","hash":"17d4501d0220b2b34f57937e3a6adfec051509d1","modified":1533889379218},{"_id":"public/2018/08/04/blockchain/index.html","hash":"312e2757f233ab71a535b5d02abc4d7a203af4c1","modified":1533889379218},{"_id":"public/2018/07/20/tcp/index.html","hash":"b6520c3a1af38c72f6d63f9be33ac05d61531095","modified":1533889379218},{"_id":"public/index.html","hash":"a7eb730b4208298869b4e9f7cd7460cac5f94c6b","modified":1533889379218},{"_id":"public/CNAME","hash":"a431652667c5c250f5d6cfd58f36ee4b743e1a40","modified":1533889379229},{"_id":"public/downloads/code/echo_server.rs","hash":"72bc85f2231a41ed51f82848e3c22382d85e32ff","modified":1533889379229},{"_id":"public/fancybox/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1533889379230},{"_id":"public/fancybox/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1533889379230},{"_id":"public/fancybox/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1533889379230},{"_id":"public/fancybox/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1533889379230},{"_id":"public/fancybox/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1533889379230},{"_id":"public/fancybox/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1533889379231},{"_id":"public/preview/browser-support.png","hash":"a6d8498553550c6b18a8f22bcd2f53c993c7d677","modified":1533889379231},{"_id":"public/preview/donation-btn.png","hash":"ad78b1605b162e2399a1cdc5232f6a44298dba6c","modified":1533889379231},{"_id":"public/preview/preview-abstract.png","hash":"3d18ad9ba38fe24770ba6758d8f1bb242f669ce3","modified":1533889379231},{"_id":"public/preview/theme-color.png","hash":"725130ceea5e41bb2cc60b31e45275b4b0cc77b3","modified":1533889379231},{"_id":"public/css/fonts/fontawesome-webfont.eot","hash":"7619748fe34c64fb157a57f6d4ef3678f63a8f5e","modified":1533889379231},{"_id":"public/css/fonts/fontawesome-webfont.woff","hash":"04c3bf56d87a0828935bd6b4aee859995f321693","modified":1533889379231},{"_id":"public/css/images/avatar.jpg","hash":"d685c61842df6ff3f44a96ba4ac15117502168ee","modified":1533889379231},{"_id":"public/css/images/homelogo.jpg","hash":"4bfc9650c4fd6e60b09ae29f888a819cdf88e9fe","modified":1533889379231},{"_id":"public/css/images/mylogo.jpg","hash":"8a890ea06da34c2be81ca28d96f3d44a2d7fcdd7","modified":1533889379231},{"_id":"public/css/images/mylogo.png","hash":"6c6233232a427cd33129e2ea6268e878a57e9ac7","modified":1533889379231},{"_id":"public/css/images/rocket.png","hash":"6dee0406955aa9b7a261161d30f2538a671e806b","modified":1533889379231},{"_id":"public/fancybox/helpers/fancybox_buttons.png","hash":"e385b139516c6813dcd64b8fc431c364ceafe5f3","modified":1533889379231},{"_id":"public/css/fonts/FontAwesome.otf","hash":"b5b4f9be85f91f10799e87a083da1d050f842734","modified":1533889379232},{"_id":"public/2018/07/20/tcp/todo.mdx","hash":"90d7ea919af484e49846964c1a2edf3d88720ee2","modified":1533889379232},{"_id":"public/css/fonts/fontawesome-webfont.ttf","hash":"7f09c97f333917034ad08fa7295e916c9f72fd3f","modified":1533889379723},{"_id":"public/2018/08/04/µtp/udp_utp_header.png","hash":"c5f80e8516d5c7f55244a105e973e9cd4f27f070","modified":1533889379723},{"_id":"public/2018/07/20/tcp/tcp_header.png","hash":"69d8d319c43fa7ce0be86f378572c8ee05e9c605","modified":1533889379724},{"_id":"public/css/archive.css","hash":"17cc72203cad1b0be66008d662c7494507aaee8b","modified":1533889379730},{"_id":"public/css/dialog.css","hash":"5e0333adf3f496e0d443767fe228a1d4b1a2bafc","modified":1533889379731},{"_id":"public/css/header-post.css","hash":"3f6d1f5593a353b4b05a67ee14e04ec9c986db21","modified":1533889379731},{"_id":"public/css/home.css","hash":"2a7bfef438468b5b8be3f84ea6818156d371077d","modified":1533889379731},{"_id":"public/css/vdonate.css","hash":"bca2d291a71e7358654c51f23e8bfb467b2bc8b2","modified":1533889379731},{"_id":"public/fancybox/jquery.fancybox.css","hash":"aaa582fb9eb4b7092dc69fcb2d5b1c20cca58ab6","modified":1533889379731},{"_id":"public/js/dialog.js","hash":"01e8b337c1721e0486fd5044f98b233e84ba1985","modified":1533889379732},{"_id":"public/js/home.js","hash":"e403c3290d76c5f58571cbfe4414236e41a7ac94","modified":1533889379733},{"_id":"public/js/scripts.js","hash":"e06a8948375df71cbf77abf8617db438ece811b3","modified":1533889379733},{"_id":"public/js/totop.js","hash":"29bb40144ac238d22b25d59df465aff8dc38bfd0","modified":1533889379733},{"_id":"public/fancybox/helpers/jquery.fancybox-buttons.css","hash":"1a9d8e5c22b371fcc69d4dbbb823d9c39f04c0c8","modified":1533889379734},{"_id":"public/fancybox/helpers/jquery.fancybox-buttons.js","hash":"dc3645529a4bf72983a39fa34c1eb9146e082019","modified":1533889379734},{"_id":"public/fancybox/helpers/jquery.fancybox-media.js","hash":"294420f9ff20f4e3584d212b0c262a00a96ecdb3","modified":1533889379734},{"_id":"public/fancybox/helpers/jquery.fancybox-thumbs.css","hash":"4ac329c16a5277592fc12a37cca3d72ca4ec292f","modified":1533889379734},{"_id":"public/fancybox/helpers/jquery.fancybox-thumbs.js","hash":"47da1ae5401c24b5c17cc18e2730780f5c1a7a0c","modified":1533889379734},{"_id":"public/css/style.css","hash":"329ea60711f90adfdb30697da9b92a3d7498e39a","modified":1533889379734},{"_id":"public/2018/07/20/tcp/congestion_control_example.png","hash":"02433df0635516013be7c5d96affa7d20cc883e7","modified":1533889379735},{"_id":"public/2018/07/20/tcp/sliding_window.png","hash":"27e68439f11775d0816b712605458a940ad255bf","modified":1533889379735},{"_id":"public/2018/07/20/tcp/tcp_connection.png","hash":"987f536dca3acefdde97178c2087276fb69c41e1","modified":1533889379736},{"_id":"public/js/insight.js","hash":"f79ab175d1c8c4fb59328ee4fd9eb95808eb0be5","modified":1533889379746},{"_id":"public/js/vdonate.js","hash":"5738414c642d30e43943a69287b3d25a0b6be135","modified":1533889379746},{"_id":"public/css/fonts/fontawesome-webfont.svg","hash":"46fcc0194d75a0ddac0a038aee41b23456784814","modified":1533889379746},{"_id":"public/fancybox/jquery.fancybox.pack.js","hash":"9e0d51ca1dbe66f6c0c7aefd552dc8122e694a6e","modified":1533889379752},{"_id":"public/css/images/sample.jpg","hash":"36b49a2f0183ac20207c44a8172e410e4d6865e6","modified":1533889379753},{"_id":"public/2018/07/20/tcp/wireshark.png","hash":"14661db4e3571db5e1315f221773ec37e6f67b6b","modified":1533889379753},{"_id":"public/preview/preview-mobile.png","hash":"7679a50aef93fc364cbcee4a52cd84604bf741b1","modified":1533889379761},{"_id":"public/2018/08/04/µtp/wireshark.png","hash":"f8da641e627808d136eeb69f7abdb497008b2c75","modified":1533889379762},{"_id":"public/fancybox/jquery.fancybox.js","hash":"d08b03a42d5c4ba456ef8ba33116fdbb7a9cabed","modified":1533889379767},{"_id":"public/css/images/pose.jpg","hash":"4d394a662e7d6d2de6a4598688c7cd3dba5c2fa3","modified":1533889379767},{"_id":"public/css/images/home-bg.jpg","hash":"e8dcdb6e03bd02d831bae593feccb7028c9dc5e9","modified":1533889379773},{"_id":"public/css/images/Windmills.jpg","hash":"19e411118d22c321710c1f2aeca14e27678e369e","modified":1533889379773},{"_id":"public/js/bootstrap.js","hash":"3b965a36a6b08854ad6eddedf85c5319fd392b4a","modified":1533889379777},{"_id":"public/js/jquery-3.1.1.min.js","hash":"f647a6d37dc4ca055ced3cf64bbc1f490070acba","modified":1533889379781},{"_id":"public/preview/code-theme.jpg","hash":"8c8512fd04e6106033656d10e92d51de76cca6d8","modified":1533889379783},{"_id":"public/preview/preview-pc.png","hash":"2471e0697938721e4c5d7c66940e165c59a31a0f","modified":1533889379784},{"_id":"public/css/bootstrap.css","hash":"64fdc2e7c3f8a164d21c5632b5adbbb9990ea802","modified":1533889379786}],"Category":[],"Data":[],"Page":[{"title":"关于凌然葭","_content":" - 子在川上：逝者如斯夫！不舍晝夜。\n - \"Computers are useless. They can only give you answers.\"\n\n## Find Me\n[Email](mailto:zjharpoonman@gmail.com) | [Github](https://github.com/0ranga) | [Douban](https://www.douban.com/people/69104080/) | [NeteaseMusic](http://music.163.com/#/user/home?id=1352908)\n\n\n--- \n<!-- netease music -->\n<div  style=\" text-align: center;\">\n{% iframe //music.163.com/outchain/player?type=0&id=2172521085&auto=1&height=430 330 330 %}\n</div>","source":"about/index.md","raw":"---\ntitle: 关于凌然葭\n---\n - 子在川上：逝者如斯夫！不舍晝夜。\n - \"Computers are useless. They can only give you answers.\"\n\n## Find Me\n[Email](mailto:zjharpoonman@gmail.com) | [Github](https://github.com/0ranga) | [Douban](https://www.douban.com/people/69104080/) | [NeteaseMusic](http://music.163.com/#/user/home?id=1352908)\n\n\n--- \n<!-- netease music -->\n<div  style=\" text-align: center;\">\n{% iframe //music.163.com/outchain/player?type=0&id=2172521085&auto=1&height=430 330 330 %}\n</div>","date":"2018-08-04T11:29:33.608Z","updated":"2018-08-04T11:29:33.608Z","path":"about/index.html","comments":1,"layout":"page","_id":"cjknq4rf500012ofn8w7jtgxw","content":"<ul>\n<li>子在川上：逝者如斯夫！不舍晝夜。</li>\n<li>“Computers are useless. They can only give you answers.”</li>\n</ul>\n<h2 id=\"Find-Me\"><a href=\"#Find-Me\" class=\"headerlink\" title=\"Find Me\"></a>Find Me</h2><p><a href=\"mailto:zjharpoonman@gmail.com\" target=\"_blank\" rel=\"noopener\">Email</a> | <a href=\"https://github.com/0ranga\" target=\"_blank\" rel=\"noopener\">Github</a> | <a href=\"https://www.douban.com/people/69104080/\" target=\"_blank\" rel=\"noopener\">Douban</a> | <a href=\"http://music.163.com/#/user/home?id=1352908\" target=\"_blank\" rel=\"noopener\">NeteaseMusic</a></p>\n<hr>\n<!-- netease music -->\n<div style=\" text-align: center;\"><br><iframe src=\"//music.163.com/outchain/player?type=0&id=2172521085&auto=1&height=430\" width=\"330\" height=\"330\" frameborder=\"0\" allowfullscreen></iframe><br></div>","site":{"data":{}},"excerpt":"","more":"<ul>\n<li>子在川上：逝者如斯夫！不舍晝夜。</li>\n<li>“Computers are useless. They can only give you answers.”</li>\n</ul>\n<h2 id=\"Find-Me\"><a href=\"#Find-Me\" class=\"headerlink\" title=\"Find Me\"></a>Find Me</h2><p><a href=\"mailto:zjharpoonman@gmail.com\" target=\"_blank\" rel=\"noopener\">Email</a> | <a href=\"https://github.com/0ranga\" target=\"_blank\" rel=\"noopener\">Github</a> | <a href=\"https://www.douban.com/people/69104080/\" target=\"_blank\" rel=\"noopener\">Douban</a> | <a href=\"http://music.163.com/#/user/home?id=1352908\" target=\"_blank\" rel=\"noopener\">NeteaseMusic</a></p>\n<hr>\n<!-- netease music -->\n<div style=\" text-align: center;\"><br><iframe src=\"//music.163.com/outchain/player?type=0&id=2172521085&auto=1&height=430\" width=\"330\" height=\"330\" frameborder=\"0\" allowfullscreen></iframe><br></div>"},{"title":"tags","date":"2018-04-04T14:58:50.000Z","type":"tags","_content":"","source":"tags/index.md","raw":"---\ntitle: tags\ndate: 2018-04-04 22:58:50\ntype: \"tags\"\n---\n","updated":"2018-07-17T13:21:39.049Z","path":"tags/index.html","comments":1,"layout":"page","_id":"cjknq4rf700032ofn1dqczcgt","content":"","site":{"data":{}},"excerpt":"","more":""},{"_content":"<tbody>\n    <tr>\n        <th style=\"border-bottom:none; border-right:none;\"><i>Offsets</i>\n        </th>\n        <th style=\"border-left:none;\"><a href=\"/wiki/Octet_(computing)\" title=\"Octet (computing)\">Octet</a>\n        </th>\n        <th colspan=\"8\">0\n        </th>\n        <th colspan=\"8\">1\n        </th>\n        <th colspan=\"8\">2\n        </th>\n        <th colspan=\"8\">3\n        </th>\n    </tr>\n    <tr>\n        <th style=\"border-top: none\"><a href=\"/wiki/Octet_(computing)\" title=\"Octet (computing)\">Octet</a>\n        </th>\n        <th>\n            <style data-mw-deduplicate=\"TemplateStyles:r853376051\">\n                .mw-parser-output .monospaced {\n                    font-family: monospace, monospace\n                }\n                \n                .mw-parser-output .monospaced-bold {\n                    font-weight: bold\n                }\n            </style><span class=\"monospaced\"><a href=\"/wiki/Bit\" title=\"Bit\">Bit</a></span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;0</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;1</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;2</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;3</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;4</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;5</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;6</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;7</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;8</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;9</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">10</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">11</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">12</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">13</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">14</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">15</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">16</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">17</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">18</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">19</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">20</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">21</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">22</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">23</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">24</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">25</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">26</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">27</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">28</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">29</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">30</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">31</span>\n        </th>\n    </tr>\n    <tr>\n        <th>0\n        </th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;0</span>\n        </th>\n        <td colspan=\"16\" style=\"background:#fdd;\">Source port</td>\n        <td colspan=\"16\">Destination port\n        </td>\n    </tr>\n    <tr>\n        <th>4\n        </th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">32</span>\n        </th>\n        <td colspan=\"16\">Length</td>\n        <td colspan=\"16\" style=\"background:#fdd;\">Checksum\n        </td>\n    </tr>\n    <tr>\n        <th>8\n        </th>\n        <th><tt>64</tt>\n        </th>\n        <td colspan=\"4\">type</td>\n        <td colspan=\"4\">ver</td>\n        <td colspan=\"8\">extension</td>\n        <td colspan=\"16\">connection_id</td>\n    </tr>\n    <tr>\n        <th>12\n        </th>\n        <th><tt>96</tt>\n        </th>\n        <td colspan=\"32\">timestamp_microseconds</td>\n    </tr>\n    <tr>\n        <th>16\n        </th>\n        <th><tt>128</tt>\n        </th>\n        <td colspan=\"32\">timestamp_difference_microseconds</td>\n    </tr>\n    <tr>\n        <th>20\n        </th>\n        <th><tt>160</tt>\n        </th>\n        <td colspan=\"32\">wnd_size</td>\n    </tr>\n    <tr>\n        <th>24\n        </th>\n        <th><tt>192</tt>\n        </th>\n        <td colspan=\"16\">seq_nr</td>\n        <td colspan=\"16\">ack_nr</td>\n    </tr>\n    <tr>\n        <th>28<br>...\n        </th>\n        <th><tt>224<br>...</tt>\n        </th>\n        <td colspan=\"32\" style=\"background:#ffd0d0;\">extensions<br>...\n        </td></tr>\n</tbody>","source":"downloads/code/utp_header_format.html","raw":"<tbody>\n    <tr>\n        <th style=\"border-bottom:none; border-right:none;\"><i>Offsets</i>\n        </th>\n        <th style=\"border-left:none;\"><a href=\"/wiki/Octet_(computing)\" title=\"Octet (computing)\">Octet</a>\n        </th>\n        <th colspan=\"8\">0\n        </th>\n        <th colspan=\"8\">1\n        </th>\n        <th colspan=\"8\">2\n        </th>\n        <th colspan=\"8\">3\n        </th>\n    </tr>\n    <tr>\n        <th style=\"border-top: none\"><a href=\"/wiki/Octet_(computing)\" title=\"Octet (computing)\">Octet</a>\n        </th>\n        <th>\n            <style data-mw-deduplicate=\"TemplateStyles:r853376051\">\n                .mw-parser-output .monospaced {\n                    font-family: monospace, monospace\n                }\n                \n                .mw-parser-output .monospaced-bold {\n                    font-weight: bold\n                }\n            </style><span class=\"monospaced\"><a href=\"/wiki/Bit\" title=\"Bit\">Bit</a></span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;0</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;1</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;2</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;3</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;4</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;5</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;6</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;7</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;8</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;9</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">10</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">11</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">12</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">13</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">14</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">15</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">16</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">17</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">18</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">19</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">20</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">21</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">22</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">23</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">24</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">25</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">26</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">27</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">28</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">29</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">30</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">31</span>\n        </th>\n    </tr>\n    <tr>\n        <th>0\n        </th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;0</span>\n        </th>\n        <td colspan=\"16\" style=\"background:#fdd;\">Source port</td>\n        <td colspan=\"16\">Destination port\n        </td>\n    </tr>\n    <tr>\n        <th>4\n        </th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">32</span>\n        </th>\n        <td colspan=\"16\">Length</td>\n        <td colspan=\"16\" style=\"background:#fdd;\">Checksum\n        </td>\n    </tr>\n    <tr>\n        <th>8\n        </th>\n        <th><tt>64</tt>\n        </th>\n        <td colspan=\"4\">type</td>\n        <td colspan=\"4\">ver</td>\n        <td colspan=\"8\">extension</td>\n        <td colspan=\"16\">connection_id</td>\n    </tr>\n    <tr>\n        <th>12\n        </th>\n        <th><tt>96</tt>\n        </th>\n        <td colspan=\"32\">timestamp_microseconds</td>\n    </tr>\n    <tr>\n        <th>16\n        </th>\n        <th><tt>128</tt>\n        </th>\n        <td colspan=\"32\">timestamp_difference_microseconds</td>\n    </tr>\n    <tr>\n        <th>20\n        </th>\n        <th><tt>160</tt>\n        </th>\n        <td colspan=\"32\">wnd_size</td>\n    </tr>\n    <tr>\n        <th>24\n        </th>\n        <th><tt>192</tt>\n        </th>\n        <td colspan=\"16\">seq_nr</td>\n        <td colspan=\"16\">ack_nr</td>\n    </tr>\n    <tr>\n        <th>28<br>...\n        </th>\n        <th><tt>224<br>...</tt>\n        </th>\n        <td colspan=\"32\" style=\"background:#ffd0d0;\">extensions<br>...\n        </td></tr>\n</tbody>","date":"2018-08-04T15:53:07.636Z","updated":"2018-08-04T15:53:07.636Z","path":"downloads/code/utp_header_format.html","title":"","comments":1,"layout":"page","_id":"cjknq4rgb000h2ofn0302a8ft","content":"<tbody>\n    <tr>\n        <th style=\"border-bottom:none; border-right:none;\"><i>Offsets</i>\n        </th>\n        <th style=\"border-left:none;\"><a href=\"/wiki/Octet_(computing)\" title=\"Octet (computing)\">Octet</a>\n        </th>\n        <th colspan=\"8\">0\n        </th>\n        <th colspan=\"8\">1\n        </th>\n        <th colspan=\"8\">2\n        </th>\n        <th colspan=\"8\">3\n        </th>\n    </tr>\n    <tr>\n        <th style=\"border-top: none\"><a href=\"/wiki/Octet_(computing)\" title=\"Octet (computing)\">Octet</a>\n        </th>\n        <th>\n            <style data-mw-deduplicate=\"TemplateStyles:r853376051\">\n                .mw-parser-output .monospaced {\n                    font-family: monospace, monospace\n                }\n                \n                .mw-parser-output .monospaced-bold {\n                    font-weight: bold\n                }\n            </style><span class=\"monospaced\"><a href=\"/wiki/Bit\" title=\"Bit\">Bit</a></span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;0</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;1</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;2</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;3</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;4</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;5</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;6</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;7</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;8</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;9</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">10</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">11</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">12</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">13</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">14</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">15</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">16</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">17</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">18</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">19</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">20</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">21</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">22</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">23</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">24</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">25</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">26</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">27</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">28</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">29</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">30</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">31</span>\n        </th>\n    </tr>\n    <tr>\n        <th>0\n        </th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;0</span>\n        </th>\n        <td colspan=\"16\" style=\"background:#fdd;\">Source port</td>\n        <td colspan=\"16\">Destination port\n        </td>\n    </tr>\n    <tr>\n        <th>4\n        </th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">32</span>\n        </th>\n        <td colspan=\"16\">Length</td>\n        <td colspan=\"16\" style=\"background:#fdd;\">Checksum\n        </td>\n    </tr>\n    <tr>\n        <th>8\n        </th>\n        <th><tt>64</tt>\n        </th>\n        <td colspan=\"4\">type</td>\n        <td colspan=\"4\">ver</td>\n        <td colspan=\"8\">extension</td>\n        <td colspan=\"16\">connection_id</td>\n    </tr>\n    <tr>\n        <th>12\n        </th>\n        <th><tt>96</tt>\n        </th>\n        <td colspan=\"32\">timestamp_microseconds</td>\n    </tr>\n    <tr>\n        <th>16\n        </th>\n        <th><tt>128</tt>\n        </th>\n        <td colspan=\"32\">timestamp_difference_microseconds</td>\n    </tr>\n    <tr>\n        <th>20\n        </th>\n        <th><tt>160</tt>\n        </th>\n        <td colspan=\"32\">wnd_size</td>\n    </tr>\n    <tr>\n        <th>24\n        </th>\n        <th><tt>192</tt>\n        </th>\n        <td colspan=\"16\">seq_nr</td>\n        <td colspan=\"16\">ack_nr</td>\n    </tr>\n    <tr>\n        <th>28<br>...\n        </th>\n        <th><tt>224<br>...</tt>\n        </th>\n        <td colspan=\"32\" style=\"background:#ffd0d0;\">extensions<br>...\n        </td></tr>\n</tbody>","site":{"data":{}},"excerpt":"","more":"<tbody>\n    <tr>\n        <th style=\"border-bottom:none; border-right:none;\"><i>Offsets</i>\n        </th>\n        <th style=\"border-left:none;\"><a href=\"/wiki/Octet_(computing)\" title=\"Octet (computing)\">Octet</a>\n        </th>\n        <th colspan=\"8\">0\n        </th>\n        <th colspan=\"8\">1\n        </th>\n        <th colspan=\"8\">2\n        </th>\n        <th colspan=\"8\">3\n        </th>\n    </tr>\n    <tr>\n        <th style=\"border-top: none\"><a href=\"/wiki/Octet_(computing)\" title=\"Octet (computing)\">Octet</a>\n        </th>\n        <th>\n            <style data-mw-deduplicate=\"TemplateStyles:r853376051\">\n                .mw-parser-output .monospaced {\n                    font-family: monospace, monospace\n                }\n                \n                .mw-parser-output .monospaced-bold {\n                    font-weight: bold\n                }\n            </style><span class=\"monospaced\"><a href=\"/wiki/Bit\" title=\"Bit\">Bit</a></span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;0</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;1</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;2</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;3</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;4</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;5</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;6</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;7</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;8</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;9</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">10</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">11</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">12</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">13</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">14</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">15</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">16</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">17</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">18</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">19</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">20</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">21</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">22</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">23</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">24</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">25</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">26</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">27</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">28</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">29</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">30</span></th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">31</span>\n        </th>\n    </tr>\n    <tr>\n        <th>0\n        </th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">&nbsp;0</span>\n        </th>\n        <td colspan=\"16\" style=\"background:#fdd;\">Source port</td>\n        <td colspan=\"16\">Destination port\n        </td>\n    </tr>\n    <tr>\n        <th>4\n        </th>\n        <th>\n            <link rel=\"mw-deduplicated-inline-style\" href=\"mw-data:TemplateStyles:r853376051\"><span class=\"monospaced\">32</span>\n        </th>\n        <td colspan=\"16\">Length</td>\n        <td colspan=\"16\" style=\"background:#fdd;\">Checksum\n        </td>\n    </tr>\n    <tr>\n        <th>8\n        </th>\n        <th><tt>64</tt>\n        </th>\n        <td colspan=\"4\">type</td>\n        <td colspan=\"4\">ver</td>\n        <td colspan=\"8\">extension</td>\n        <td colspan=\"16\">connection_id</td>\n    </tr>\n    <tr>\n        <th>12\n        </th>\n        <th><tt>96</tt>\n        </th>\n        <td colspan=\"32\">timestamp_microseconds</td>\n    </tr>\n    <tr>\n        <th>16\n        </th>\n        <th><tt>128</tt>\n        </th>\n        <td colspan=\"32\">timestamp_difference_microseconds</td>\n    </tr>\n    <tr>\n        <th>20\n        </th>\n        <th><tt>160</tt>\n        </th>\n        <td colspan=\"32\">wnd_size</td>\n    </tr>\n    <tr>\n        <th>24\n        </th>\n        <th><tt>192</tt>\n        </th>\n        <td colspan=\"16\">seq_nr</td>\n        <td colspan=\"16\">ack_nr</td>\n    </tr>\n    <tr>\n        <th>28<br>...\n        </th>\n        <th><tt>224<br>...</tt>\n        </th>\n        <td colspan=\"32\" style=\"background:#ffd0d0;\">extensions<br>...\n        </td></tr>\n</tbody>"}],"Post":[{"title":"bt","_content":"","source":"_drafts/bt.md","raw":"---\ntitle: bt\ntags:\n---\n","slug":"bt","published":0,"date":"2018-08-10T08:20:45.859Z","updated":"2018-08-10T08:20:45.859Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjknq4rez00002ofng986jy0i","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"探索 BlockChain","keywords":[],"date":"2018-08-04T09:00:00.000Z","_content":"Bitcoin 带来的 BlockChain 技术一往无前。计划从现在开始能够比较系统地学习与记录相关技术知识。这篇文章是个进度表也是一个目录。\n<!-- more -->\n## Bitcoin\nBitcoin 的文档非常丰富，之前我是结合 [Bitcoin Developer Reference](https://bitcoin.org/en/developer-reference) 与 [Bitcoin Developer Guide](https://bitcoin.org/en/developer-guide) 进行学习的，写得非常详细，而且比较容易理解。\n\n## IPFS：星际文件系统 \n> IPFS is the Distributed Web. \n> A peer-to-peer hypermedia protocol to make the web faster, safer, and more open.\n> IPFS aims to replace HTTP and build a better web for all of us.\n\nIPFS 的目标是取代 HTTP，看上去像很多白皮书项目一样牛逼轰轰，但是开发者确实在不断向这个目标推进。但在个人现在的认识中，IPFS 更像是他的字面意思 **星际文件系统** 所表达的一样，是数据的载体，而且是去中心化的。这很容易让人联想到 BitTorrent，而接下来对 IPFS 的探索也将从 BT 开始。\n\n### 博文计划\n - BT\n    - BT 概述\n    - {% post_link µtp %}\n    - DHT 网络\n - IPFS\n    - 白皮书翻译","source":"_posts/blockchain.md","raw":"---\ntitle: 探索 BlockChain\nkeywords: []\ndate: 2018/08/04 17:00:00\ntags: [BlockChain]\ncategories:\n---\nBitcoin 带来的 BlockChain 技术一往无前。计划从现在开始能够比较系统地学习与记录相关技术知识。这篇文章是个进度表也是一个目录。\n<!-- more -->\n## Bitcoin\nBitcoin 的文档非常丰富，之前我是结合 [Bitcoin Developer Reference](https://bitcoin.org/en/developer-reference) 与 [Bitcoin Developer Guide](https://bitcoin.org/en/developer-guide) 进行学习的，写得非常详细，而且比较容易理解。\n\n## IPFS：星际文件系统 \n> IPFS is the Distributed Web. \n> A peer-to-peer hypermedia protocol to make the web faster, safer, and more open.\n> IPFS aims to replace HTTP and build a better web for all of us.\n\nIPFS 的目标是取代 HTTP，看上去像很多白皮书项目一样牛逼轰轰，但是开发者确实在不断向这个目标推进。但在个人现在的认识中，IPFS 更像是他的字面意思 **星际文件系统** 所表达的一样，是数据的载体，而且是去中心化的。这很容易让人联想到 BitTorrent，而接下来对 IPFS 的探索也将从 BT 开始。\n\n### 博文计划\n - BT\n    - BT 概述\n    - {% post_link µtp %}\n    - DHT 网络\n - IPFS\n    - 白皮书翻译","slug":"blockchain","published":1,"updated":"2018-08-10T08:21:19.649Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjknq4rf600022ofns11gjbgw","content":"<p>Bitcoin 带来的 BlockChain 技术一往无前。计划从现在开始能够比较系统地学习与记录相关技术知识。这篇文章是个进度表也是一个目录。<br><a id=\"more\"></a></p>\n<h2 id=\"Bitcoin\"><a href=\"#Bitcoin\" class=\"headerlink\" title=\"Bitcoin\"></a>Bitcoin</h2><p>Bitcoin 的文档非常丰富，之前我是结合 <a href=\"https://bitcoin.org/en/developer-reference\" target=\"_blank\" rel=\"noopener\">Bitcoin Developer Reference</a> 与 <a href=\"https://bitcoin.org/en/developer-guide\" target=\"_blank\" rel=\"noopener\">Bitcoin Developer Guide</a> 进行学习的，写得非常详细，而且比较容易理解。</p>\n<h2 id=\"IPFS：星际文件系统\"><a href=\"#IPFS：星际文件系统\" class=\"headerlink\" title=\"IPFS：星际文件系统\"></a>IPFS：星际文件系统</h2><blockquote>\n<p>IPFS is the Distributed Web.<br>A peer-to-peer hypermedia protocol to make the web faster, safer, and more open.<br>IPFS aims to replace HTTP and build a better web for all of us.</p>\n</blockquote>\n<p>IPFS 的目标是取代 HTTP，看上去像很多白皮书项目一样牛逼轰轰，但是开发者确实在不断向这个目标推进。但在个人现在的认识中，IPFS 更像是他的字面意思 <strong>星际文件系统</strong> 所表达的一样，是数据的载体，而且是去中心化的。这很容易让人联想到 BitTorrent，而接下来对 IPFS 的探索也将从 BT 开始。</p>\n<h3 id=\"博文计划\"><a href=\"#博文计划\" class=\"headerlink\" title=\"博文计划\"></a>博文计划</h3><ul>\n<li>BT<ul>\n<li>BT 概述</li>\n<li><a href=\"/2018/08/04/µtp/\" title=\"µTP 协议 —— 对 BEP29 的简要理解\">µTP 协议 —— 对 BEP29 的简要理解</a></li>\n<li>DHT 网络</li>\n</ul>\n</li>\n<li>IPFS<ul>\n<li>白皮书翻译</li>\n</ul>\n</li>\n</ul>\n","site":{"data":{}},"excerpt":"<p>Bitcoin 带来的 BlockChain 技术一往无前。计划从现在开始能够比较系统地学习与记录相关技术知识。这篇文章是个进度表也是一个目录。<br>","more":"</p>\n<h2 id=\"Bitcoin\"><a href=\"#Bitcoin\" class=\"headerlink\" title=\"Bitcoin\"></a>Bitcoin</h2><p>Bitcoin 的文档非常丰富，之前我是结合 <a href=\"https://bitcoin.org/en/developer-reference\" target=\"_blank\" rel=\"noopener\">Bitcoin Developer Reference</a> 与 <a href=\"https://bitcoin.org/en/developer-guide\" target=\"_blank\" rel=\"noopener\">Bitcoin Developer Guide</a> 进行学习的，写得非常详细，而且比较容易理解。</p>\n<h2 id=\"IPFS：星际文件系统\"><a href=\"#IPFS：星际文件系统\" class=\"headerlink\" title=\"IPFS：星际文件系统\"></a>IPFS：星际文件系统</h2><blockquote>\n<p>IPFS is the Distributed Web.<br>A peer-to-peer hypermedia protocol to make the web faster, safer, and more open.<br>IPFS aims to replace HTTP and build a better web for all of us.</p>\n</blockquote>\n<p>IPFS 的目标是取代 HTTP，看上去像很多白皮书项目一样牛逼轰轰，但是开发者确实在不断向这个目标推进。但在个人现在的认识中，IPFS 更像是他的字面意思 <strong>星际文件系统</strong> 所表达的一样，是数据的载体，而且是去中心化的。这很容易让人联想到 BitTorrent，而接下来对 IPFS 的探索也将从 BT 开始。</p>\n<h3 id=\"博文计划\"><a href=\"#博文计划\" class=\"headerlink\" title=\"博文计划\"></a>博文计划</h3><ul>\n<li>BT<ul>\n<li>BT 概述</li>\n<li><a href=\"/2018/08/04/µtp/\" title=\"µTP 协议 —— 对 BEP29 的简要理解\">µTP 协议 —— 对 BEP29 的简要理解</a></li>\n<li>DHT 网络</li>\n</ul>\n</li>\n<li>IPFS<ul>\n<li>白皮书翻译</li>\n</ul>\n</li>\n</ul>"},{"title":"闲云孤鹤","_content":"``` java\npublic class Blog {\n    public static void main(String[] args) {\n        System.out.println(\"斯是陋室，惟吾德馨\");\n    }\n}\n```","source":"_posts/hello-world.md","raw":"---\ntitle: 闲云孤鹤\ntags:\n\t- Essay\n---\n``` java\npublic class Blog {\n    public static void main(String[] args) {\n        System.out.println(\"斯是陋室，惟吾德馨\");\n    }\n}\n```","slug":"hello-world","published":1,"date":"2018-07-17T13:21:39.049Z","updated":"2018-07-17T13:21:39.049Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjknq4rf800042ofnduiqlpkx","content":"<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Blog</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">\"斯是陋室，惟吾德馨\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Blog</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">\"斯是陋室，惟吾德馨\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>"},{"title":"TCP 温故知新","keywords":[],"date":"2018-07-19T16:00:00.000Z","_content":"生产环境遇到些网络问题，知对 TCP 协议还是有些生疏，在此复习记录。\n<!-- more -->\n## 协议\n### 报文段格式\nTCP 协议报文段主要由**首部（Header）** 与**数据（Data）** 两部分组成。在计算校验和是还会加上虚拟的伪首部。此处主要说明首部的组成。\n![图 1 TCP Header (From: WikiPedia)](tcp_header.png)\nTCP 在网络模型中属于运输层，用于提供进程与进程间的字节流通信服务，因此需要**源 / 目端口（Source / Destination port）** 以确定通信双方进程。使用**序号（Sequence number，seq）** 表明本报文段第一个数据字节的编号，初始序号由双方在 TCP 连接建立时随机生成。使用**确认号（Acknowledgment number，ack）** 表示接受方期望从发送方接受的字节编号。**数据偏移量（Data Offset）** 顾名思义报文段数据开始字节处的偏移量，即 TCP header 的长度，由于选项的存在，首部长度的范围是 20～60 Bytes，但是该字段只有 4 Bits，因此该字段指出首部长度有多少个 4 Bytes。接下来的 3 Bits 被**保留（Reserved）** 。随后会讨论 9 个**标志位（Flags）**。**窗口大小（Window Size）** 定义了接受方的接受窗口大小，由接受方决定，然后告知发送方。在计算**校验和（Checksum）** 时需要加上伪首部，伪首部的内容包括源目 IP 地址，TCP 报文段长度等。如果 URG 标志位被设定了，那**紧急指针（Urgent pointer）** 用于指示紧急数据最后一个字节在报文段数据部分中的偏移量。最后的 40 Bytes 留给**选项（Options）**。\n### Flags\n - **URG**：为 1 表示数据中有紧急数据。这个标记比较少见，可以找到的一些应用有：[FTP](https://stackoverflow.com/questions/24476458/understanding-tcp-urg-flag)，[Telnet](http://packetlife.net/blog/2011/mar/2/tcp-flags-psh-and-urg/)；\n - **ACK**：为 1 表示确认号字段有效；\n - **PSH**：为 1 表示有推送数据，这个字段主要完成[两个功能](http://packetlife.net/blog/2011/mar/2/tcp-flags-psh-and-urg/)：发送方应用层提醒 TCP 需要立即发送数据；接受方 TCP 需要将收到的数据立即提交给应用层；\n - **RST**：为 1 表示出现严重差错。可能需要重现创建 TCP 连接。还可以用于拒绝非法的报文段和拒绝连接请求；\n - **SYN**：为 1 表示这是连接请求或是连接接受请求，用于创建连接和使顺序号同步；\n - **FIN**：为 1 表示发送方没有数据要传输了，要求释放连接；\n\n## 阶段\nTCP 连接可以分为三个阶段：建立连接，传输数据，终止连接。可以用一个有限状态机表示：\n![图 2 TCP 连接 (From: Computer Networks)<br>图中（A/B）这样的文字表示“收到A后执行B，A与B可以是标志位或者指令”<br>深实线表示 Client 的行为，深虚线表示 Server 的行为，浅色线表示特殊行为](tcp_connection.png)\n下面结合一个用 Rust 写的 Echo Server 与抓包工具 Wireshark 来演示这三个过程。代码如下：\n{% include_code Echo Server lang:Rust echo_server.rs %}\nEcho Server 启动之后使用 telnet 工具连接至服务器，与服务器交互两次，即回显两次字符串，然后从退出 telnet。抓到的包截图如下：\n![图 3 Wireshark 抓包](wireshark.png)\n\n在下面的表述中，客户端表示在这一阶段先发起请求的一方，服务端表示在这一阶段先接受请求的一方。在 TCP 中，服务端和客户端之间可以进行双向通信，他们可以理解为对等的，在连接建立后，实际上没有服务端和客户端的区别。\n### 建立连接\n前三个包代表了建立连接的过程，分为三步，大多数情况下就如同抓包所示，称为**三次握手（3-way handshake）**。图 2 中还画出了双方同时打开连接与连接复位这两种比较少见的情景。\n1. 客户端发送给服务端一个 **SYN** 报文，用以告知服务端初始序号为 0（此处的 Seq 经过 Wireshark 的处理，变成了相对值），然后客户端进入 ***SYN_SENT*** 状态。\n2. 服务器收到 1 中报文后，发给客户端一个 **SYN + ACK** 报文，告知客户端初始序号为 0，且接下来期望从客户端收到的序号 Ack 为 1。服务端进入 ***SYN_RCVD*** 状态。可见 **SYN 报文消耗了一个序号**。\n3. 客户端给服务端回复 **ACK** 报文，进入 ***ESTABLISHED*** 状态，服务端在收到这个报文连接建立完成。可见 **ACK 报文在不携带数据的情况下不消耗序号**。\n\n### 传输数据\n图 3 中 P17～P20 与 P72～P74 分别展示了两次交互过程。以第二次交互为例：\n1. P72 中，客户端将想要回显字符串发送给服务端，告知服务器这个报文段的数据首字节序号为 8，并且希望从服务端收到的下一个序号是 8。\n2. 服务端将回显的字符串与对 P72 的确认一起发送给客户端。P72 的长度为 9，因此报文段中数据的序号范围为 [8,17)，因此在 P73 中 Ack 为 17。\n3. 客户端确认 P73。\n\n需要注意的是，这两次交互有所区别：第一次交互时，服务端先返回了一个确认给客户端，然后再额外发送一条携带回显内容的报文段。但是第二次交互时省略了单独的确认。\n### 终止连接\n根据“广大博主”写作的文章与[问答网站的讨论](https://www.zhihu.com/question/50646354)以及各种面经，基本一致认为，终止连接通常被成为**四次挥手（4-way termination）**，即通信双方会有四次交互，但是如图 2 所示，也存在**三次挥手**的可能性，且我本地的多次抓包也如图 3 一致——均为三次挥手，且无一例外。下面对四次挥手进行分析，三次挥手可以被其概括：\n1. 客户端发起终止连接，发出一个 **FIN** 报文给服务端，假设该报文的 Seq 为 X，Ack 为 Y。然后客户端进入 ***FIN_WAIT1*** 状态，除重传 FIN 报文与发送 ACK 确认之外，不再发送应用数据给服务端。\n2. 服务端收到 FIN 报文段后先回复一个 **ACK** 报文，进入 ***CLOSE_WAIT*** 状态，该报文的 Seq 为 Y，Ack 为 X+1。\n3. 客户端在收到 FIN 的 ACK 之后进入 ***FIN_WAIT2*** 状态。此时服务端还可以继续将未发送完的应用数据发送给客户端。\n4. 服务端发送完数据后发送一条 **FIN** 报文，进入 ***LAST_ACK*** 状态，该报文的 Seq 为 Y+K，Ack 为 X+1。\n5. 客户端收到服务端的 FIN 后，发送最后的 **ACK** 报文给服务器，然后进入 ***TIME_WAIT*** 状态。如果在 2MSL（最大报文段寿命，通常为30～60s）后客户端没再次收到 FIN 报文，则进入 ***CLOSED*** 状态，否则重发 ACK 报文进行重试。\n6. 服务端在收到 ACK 报文后进入 ***CLOSED*** 状态。\n\n三次挥手表现为步骤 2～4 合并为一步，即同时发送对客户端 FIN 的 ACK 报文与 服务端自己的 FIN 报文。这条 **FIN+ACK** 报文的 Seq 为 Y，Ack 为 X+1。\n\n至于在什么情景下出现三次握手或者四次握手，大多数的观点认为先收到 FIN 报文的一方还需要向上层应用询问是否仍然有数据需要发送，因为要等待上层的回复，所以“为何不早点把对 FIN 的 ACK 发出去呢？！”而且立即 Ack 能防止对方重传 FIN。但是有没有存在不需要询问上层或者不需要立即回复 Ack 的可能，就如同传输数据出现的情况一样，这些应该与 TCP 的具体实现相关，目前能力与精力有限，还有待对 [Linux TCP 实现源码](https://github.com/torvalds/linux/blob/master/net/ipv4/tcp_output.c)进行阅读。\n## 滑动窗口\n滑动窗口是 TCP 中用于实现诸如 ACK 确认、流量控制、拥塞控制的承载结构。如图所示:\n![图 4 滑动窗口](sliding_window.png)\n先将 TCP 看作是简单的单向通信，则发送方有一个发送窗口，接收方有一个接收窗口。正如图中所示，传输的是报文段，窗口大小的单位是字节。两个窗口中**白色区域**为空白位置，等待被应用层或者网络层填满；**灰色区域**是已经发送但是还没有接受到确认的字节；**粉色区域**在发送窗口中表示等待被发送的字节，在接收窗口汇总表示等待交付的字节。\n发送窗口的大小为接受方通过首部中窗口大小字段告知的接收窗口大小 rwnd 和之后会讲到的拥塞窗口的大小 cwnd 两者中的较小值，即 `min(rwnd , cwnd)`。接收窗口大小是接收方可用缓存空间大小，为 `rwnd = 缓存大小 - 准备交付的字节数`。\n\n## 流量控制\n流量控制用于平衡生产者产生数据与消费者消耗数据的速度。TCP 中的流量控制实现的主要途径是不断调整发送窗口的大小实现。发送 TCP 一旦发现发送发送窗口满了就会对发送进程进行反馈。接受方根据之前从发送方收到的数据量和服务器已经消耗的数据量得到自身接收窗口的大小，将这个值告知发送方，发送方根据收到的窗口大小调整自身窗口大小。\n还有正对通信双方产生数据小或者消费数据慢产生糊涂窗口综合征时，有其他方面的流量控制。当发送方数据量相对于首部小很多的报文很多时，可以使用 **Nagle 算法**减少这种小报文量。当接受方消耗数据很慢时，每次告知发送方的窗口大小会比较小，也可能产生很多小报文，此时可以使用 **Clark 解决方法**或者进行**推迟确认**。关于这几种方案的分析及具体的使用情景可以参考 dog520 大神的这篇文章——[再次谈谈 TCP 的 Nagle 算法与 TCP_CORK 选项](https://blog.csdn.net/dog250/article/details/21303679)。\n## 差错控制\n差错控制用于描述 TCP 在发送或者接受到报文段发生异常时的行为，其主要表现在如下几个方面：\n1. **校验和**：在接受方，如果收到的报文段未通过校验和校验，则立即丢弃，反之，则通过**确认规则**（下面马上提及）进行确认；\n2. **重传**：在发送方，如果一个报文段重传超时计时器（RTO）超时，即在 RTO 时间之后仍然未收到 ACK，则立即重传未被确认的最小的报文段；如果收到四个相同的的 ACK ，则立即重传下一个报文段；\n\n### 确认规则\n1. 当接受方向发送方发送数据报文段时，必须**捎带** ACK；\n2. 当接受方没有数据要发送时，但是收到一个**按序到达**的报文，同时前一个报文段也已经确认过了，那么接收方就推迟发送确认报文段，直到另一个报文段到达或者延迟一段时间以减少 ACK 报文量；\n3. 当所期望的报文段到达，且前一个**按序到达**的报文还未被确认，则立即 ACK（ACK 的序号仍然是下一个正常期望的序号，下同）；\n4. 当序号比期望的大的报文段（**失序**报文段）到达，则立即 ACK，且存储该报文段；\n5. 当**丢失**的报文段到达时，则立即 ACK；\n6. 当**重复**的报文段到达时，则丢弃，且立即 ACK；\n\n## 拥塞控制\n拥塞控制是为了避免因为网络受限导致网络不能按照发送方产生的数据的速度将报文段交付给接受方。与流量控制考察的对象是通信双方不同，拥塞控制的考察对象是通信双方间的网络。拥塞控制的方式表现在发送方的拥塞窗口的变化，从而控制发送方的数据发送快慢。TCP 最初使用的拥塞策略称为 **TCP Tahoe and Reno**。\n### Tahoe and Reno\n这个拥塞策略主要分为慢启动、拥塞避免、拥塞检测三个阶段。\n#### 慢启动\n假设接收窗口大小远大于拥塞窗口，且不考虑延迟确认。拥塞窗口大小从一个最大报文长度 MSS （连接建立时通过 TCP 选项告知）开始，之后每当有一个报文段被确认，拥塞窗口就增大一个 MSS。在这样的策略下，慢启动阶段的拥塞窗口大小呈指数增长。即从 `1 -> 2 -> 4 -> 8`。当到达慢启动门限时，就进入拥塞避免阶段。\n#### 拥塞避免\n拥塞避免阶段拥塞窗口大小继续增加，但是速度放慢，改成当整个窗口大小的报文段都被确认后，窗口大小才增加一个 MSS。表现为 `8 -> 9 -> 10 -> 11`，呈现线性增长。\n#### 拥塞检测\n如果拥塞发生了，因为发生在网络中路由器出现丢包现象，在接受方处的表现为出现以下两种情况，并做出对应的反应：\n1. RTO 计时器超时。这说明网络拥塞的可能性较大，TCP 做出较强烈的反应：\n    a. 把慢启动门限值调整为当前窗口大小的一半；\n    b. 把 cwnd 重新设置为 1 MSS；\n    c. 重新进入慢启动阶段；\n\n2. 收到四个相同的 ACK；说明出现拥塞的可能性较小，但是出现了丢包，TCP 做出较弱的反应，Reno 算法表现为快恢复（Fast recovery）：\n    a. 把慢启动门限值调整为当前窗口大小的一半；\n    b. 把 cwnd 重新设置为慢启动门限值；\n    c. 重新进入拥塞避免阶段；\n\n图示如下：\n![拥塞控制示例](congestion_control_example.png)\nTahoe 算法与 Reno （Tahoe 的改进版本）的区别在于收到四个相同 ACK 时，Tahoe 算法的策略和 RTO 计时器超时时一致。\n### 其他拥塞策略\n拥塞控制策略只需要在发送方实现即可，不需要接受方的参与，因此可以仅在发送方部署一套算法。现在 TCP 网络上的算法也在不断[改进](https://en.wikipedia.org/wiki/TCP_congestion_control)，涌现出诸如 [**TCP CUBIC**](http://www4.ncsu.edu/~rhee/export/bitcp/cubic-paper.pdf)、[**TCP BBR**](https://ai.google/research/pubs/pub45646) 这样的算法。\n\n## TCP 中的计时器\n### 重传计时器\n重传计时器的超时时间为 RTO，RTO 主要根据测量所得的报文段往返时间 RTTm计算而来，计算过程如下：\n\n首先计算平滑 RTT，即RTTs：\n```\nRTTs = RTTm // 第一次测量\nRTTs = (1 - α)RTTs + αRTTm // 随后的测量\n```\n然后计算 RTT 的偏差 RTTd：\n```\nRTTd = RTTm / 2 // 第一次测量\nRTTd = (1 - β)RTTd + β|RTTs - RTTm| // 随后的测量\n```\n重传超时 RTO 的计算如下：\n```\nRTO = 6s // 原始值\nRTO = RTTs + 4RTTd // 第一次测量后\n```\n任意时刻只有一个 RTT 在进行测量，当重传发生时会影响 RTT 的测量，根据 **Karn 算法**，TCP 忽略重传报文的 RTT，而对于重传的报文，RTO 值为原报文的两倍，如果发生第二次重传，则为四倍，以此类推。\n### 持续计时器\n当接受方发送窗口值为 0 的报文段之后，后来因为接收窗口增加需要通告接窗口为非 0，但是通告的 ACK 丢失，这会导致发送方一直等待非 0 窗口通告，导致死锁。持续计时器就是接受方在收到 0 窗口通告后启用，如果超时则发送探测报文，促使接受方重传 ACK。\n### Keep-Alive 计时器\nKeep-Alive 计时器用于防止 TCP 连接长时间空闲，每当收到对方的报文段，这个计时器就复位。这个计时器的超时时间通常可以通过接口进行设定。\n### Time-Wait 计时器\nTime-Wait 计时器对最后的 FIN 进行确认时启动的超时计时器。如果在时常为 2MSL 的计时器超时前再次收到 FIN，则重传 ACK，否则连接彻底关闭。\n\n## 传输层的[未来](https://blog.apnic.net/2017/12/12/internet-protocols-changing/)\n[QIUC](https://www.chromium.org/quic) 了解一下下？\n\n## 参考资料\n1. [TCP/IP 协议族 第四版](https://book.douban.com/subject/5386194/)\n2. [Andrew S.Tanenbaum - Computer Networks 5th](https://book.douban.com/subject/5344443/)\n3. [WikiPedia - Transmission Control Protocol](https://en.wikipedia.org/wiki/Transmission_Control_Protocol)\n4. [WikiPedia - TCP congestion control](https://en.wikipedia.org/wiki/TCP_congestion_contro)\n5. [TCP Flags: PSH and URG](http://packetlife.net/blog/2011/mar/2/tcp-flags-psh-and-urg/)\n6. [KTH - Internetworking Lecture 4](https://www.nada.kth.se/kurser/kth/2D1392/05/lectures/lecture_4.pdf)\n7. [一个 TCP FIN_WAIT2 状态细节引发的感慨](https://blog.csdn.net/dog250/article/details/81256550)","source":"_posts/tcp.md","raw":"---\ntitle: TCP 温故知新\nkeywords: []\ndate: 2018/7/20\ntags: [Network]\ncategories:\n---\n生产环境遇到些网络问题，知对 TCP 协议还是有些生疏，在此复习记录。\n<!-- more -->\n## 协议\n### 报文段格式\nTCP 协议报文段主要由**首部（Header）** 与**数据（Data）** 两部分组成。在计算校验和是还会加上虚拟的伪首部。此处主要说明首部的组成。\n![图 1 TCP Header (From: WikiPedia)](tcp_header.png)\nTCP 在网络模型中属于运输层，用于提供进程与进程间的字节流通信服务，因此需要**源 / 目端口（Source / Destination port）** 以确定通信双方进程。使用**序号（Sequence number，seq）** 表明本报文段第一个数据字节的编号，初始序号由双方在 TCP 连接建立时随机生成。使用**确认号（Acknowledgment number，ack）** 表示接受方期望从发送方接受的字节编号。**数据偏移量（Data Offset）** 顾名思义报文段数据开始字节处的偏移量，即 TCP header 的长度，由于选项的存在，首部长度的范围是 20～60 Bytes，但是该字段只有 4 Bits，因此该字段指出首部长度有多少个 4 Bytes。接下来的 3 Bits 被**保留（Reserved）** 。随后会讨论 9 个**标志位（Flags）**。**窗口大小（Window Size）** 定义了接受方的接受窗口大小，由接受方决定，然后告知发送方。在计算**校验和（Checksum）** 时需要加上伪首部，伪首部的内容包括源目 IP 地址，TCP 报文段长度等。如果 URG 标志位被设定了，那**紧急指针（Urgent pointer）** 用于指示紧急数据最后一个字节在报文段数据部分中的偏移量。最后的 40 Bytes 留给**选项（Options）**。\n### Flags\n - **URG**：为 1 表示数据中有紧急数据。这个标记比较少见，可以找到的一些应用有：[FTP](https://stackoverflow.com/questions/24476458/understanding-tcp-urg-flag)，[Telnet](http://packetlife.net/blog/2011/mar/2/tcp-flags-psh-and-urg/)；\n - **ACK**：为 1 表示确认号字段有效；\n - **PSH**：为 1 表示有推送数据，这个字段主要完成[两个功能](http://packetlife.net/blog/2011/mar/2/tcp-flags-psh-and-urg/)：发送方应用层提醒 TCP 需要立即发送数据；接受方 TCP 需要将收到的数据立即提交给应用层；\n - **RST**：为 1 表示出现严重差错。可能需要重现创建 TCP 连接。还可以用于拒绝非法的报文段和拒绝连接请求；\n - **SYN**：为 1 表示这是连接请求或是连接接受请求，用于创建连接和使顺序号同步；\n - **FIN**：为 1 表示发送方没有数据要传输了，要求释放连接；\n\n## 阶段\nTCP 连接可以分为三个阶段：建立连接，传输数据，终止连接。可以用一个有限状态机表示：\n![图 2 TCP 连接 (From: Computer Networks)<br>图中（A/B）这样的文字表示“收到A后执行B，A与B可以是标志位或者指令”<br>深实线表示 Client 的行为，深虚线表示 Server 的行为，浅色线表示特殊行为](tcp_connection.png)\n下面结合一个用 Rust 写的 Echo Server 与抓包工具 Wireshark 来演示这三个过程。代码如下：\n{% include_code Echo Server lang:Rust echo_server.rs %}\nEcho Server 启动之后使用 telnet 工具连接至服务器，与服务器交互两次，即回显两次字符串，然后从退出 telnet。抓到的包截图如下：\n![图 3 Wireshark 抓包](wireshark.png)\n\n在下面的表述中，客户端表示在这一阶段先发起请求的一方，服务端表示在这一阶段先接受请求的一方。在 TCP 中，服务端和客户端之间可以进行双向通信，他们可以理解为对等的，在连接建立后，实际上没有服务端和客户端的区别。\n### 建立连接\n前三个包代表了建立连接的过程，分为三步，大多数情况下就如同抓包所示，称为**三次握手（3-way handshake）**。图 2 中还画出了双方同时打开连接与连接复位这两种比较少见的情景。\n1. 客户端发送给服务端一个 **SYN** 报文，用以告知服务端初始序号为 0（此处的 Seq 经过 Wireshark 的处理，变成了相对值），然后客户端进入 ***SYN_SENT*** 状态。\n2. 服务器收到 1 中报文后，发给客户端一个 **SYN + ACK** 报文，告知客户端初始序号为 0，且接下来期望从客户端收到的序号 Ack 为 1。服务端进入 ***SYN_RCVD*** 状态。可见 **SYN 报文消耗了一个序号**。\n3. 客户端给服务端回复 **ACK** 报文，进入 ***ESTABLISHED*** 状态，服务端在收到这个报文连接建立完成。可见 **ACK 报文在不携带数据的情况下不消耗序号**。\n\n### 传输数据\n图 3 中 P17～P20 与 P72～P74 分别展示了两次交互过程。以第二次交互为例：\n1. P72 中，客户端将想要回显字符串发送给服务端，告知服务器这个报文段的数据首字节序号为 8，并且希望从服务端收到的下一个序号是 8。\n2. 服务端将回显的字符串与对 P72 的确认一起发送给客户端。P72 的长度为 9，因此报文段中数据的序号范围为 [8,17)，因此在 P73 中 Ack 为 17。\n3. 客户端确认 P73。\n\n需要注意的是，这两次交互有所区别：第一次交互时，服务端先返回了一个确认给客户端，然后再额外发送一条携带回显内容的报文段。但是第二次交互时省略了单独的确认。\n### 终止连接\n根据“广大博主”写作的文章与[问答网站的讨论](https://www.zhihu.com/question/50646354)以及各种面经，基本一致认为，终止连接通常被成为**四次挥手（4-way termination）**，即通信双方会有四次交互，但是如图 2 所示，也存在**三次挥手**的可能性，且我本地的多次抓包也如图 3 一致——均为三次挥手，且无一例外。下面对四次挥手进行分析，三次挥手可以被其概括：\n1. 客户端发起终止连接，发出一个 **FIN** 报文给服务端，假设该报文的 Seq 为 X，Ack 为 Y。然后客户端进入 ***FIN_WAIT1*** 状态，除重传 FIN 报文与发送 ACK 确认之外，不再发送应用数据给服务端。\n2. 服务端收到 FIN 报文段后先回复一个 **ACK** 报文，进入 ***CLOSE_WAIT*** 状态，该报文的 Seq 为 Y，Ack 为 X+1。\n3. 客户端在收到 FIN 的 ACK 之后进入 ***FIN_WAIT2*** 状态。此时服务端还可以继续将未发送完的应用数据发送给客户端。\n4. 服务端发送完数据后发送一条 **FIN** 报文，进入 ***LAST_ACK*** 状态，该报文的 Seq 为 Y+K，Ack 为 X+1。\n5. 客户端收到服务端的 FIN 后，发送最后的 **ACK** 报文给服务器，然后进入 ***TIME_WAIT*** 状态。如果在 2MSL（最大报文段寿命，通常为30～60s）后客户端没再次收到 FIN 报文，则进入 ***CLOSED*** 状态，否则重发 ACK 报文进行重试。\n6. 服务端在收到 ACK 报文后进入 ***CLOSED*** 状态。\n\n三次挥手表现为步骤 2～4 合并为一步，即同时发送对客户端 FIN 的 ACK 报文与 服务端自己的 FIN 报文。这条 **FIN+ACK** 报文的 Seq 为 Y，Ack 为 X+1。\n\n至于在什么情景下出现三次握手或者四次握手，大多数的观点认为先收到 FIN 报文的一方还需要向上层应用询问是否仍然有数据需要发送，因为要等待上层的回复，所以“为何不早点把对 FIN 的 ACK 发出去呢？！”而且立即 Ack 能防止对方重传 FIN。但是有没有存在不需要询问上层或者不需要立即回复 Ack 的可能，就如同传输数据出现的情况一样，这些应该与 TCP 的具体实现相关，目前能力与精力有限，还有待对 [Linux TCP 实现源码](https://github.com/torvalds/linux/blob/master/net/ipv4/tcp_output.c)进行阅读。\n## 滑动窗口\n滑动窗口是 TCP 中用于实现诸如 ACK 确认、流量控制、拥塞控制的承载结构。如图所示:\n![图 4 滑动窗口](sliding_window.png)\n先将 TCP 看作是简单的单向通信，则发送方有一个发送窗口，接收方有一个接收窗口。正如图中所示，传输的是报文段，窗口大小的单位是字节。两个窗口中**白色区域**为空白位置，等待被应用层或者网络层填满；**灰色区域**是已经发送但是还没有接受到确认的字节；**粉色区域**在发送窗口中表示等待被发送的字节，在接收窗口汇总表示等待交付的字节。\n发送窗口的大小为接受方通过首部中窗口大小字段告知的接收窗口大小 rwnd 和之后会讲到的拥塞窗口的大小 cwnd 两者中的较小值，即 `min(rwnd , cwnd)`。接收窗口大小是接收方可用缓存空间大小，为 `rwnd = 缓存大小 - 准备交付的字节数`。\n\n## 流量控制\n流量控制用于平衡生产者产生数据与消费者消耗数据的速度。TCP 中的流量控制实现的主要途径是不断调整发送窗口的大小实现。发送 TCP 一旦发现发送发送窗口满了就会对发送进程进行反馈。接受方根据之前从发送方收到的数据量和服务器已经消耗的数据量得到自身接收窗口的大小，将这个值告知发送方，发送方根据收到的窗口大小调整自身窗口大小。\n还有正对通信双方产生数据小或者消费数据慢产生糊涂窗口综合征时，有其他方面的流量控制。当发送方数据量相对于首部小很多的报文很多时，可以使用 **Nagle 算法**减少这种小报文量。当接受方消耗数据很慢时，每次告知发送方的窗口大小会比较小，也可能产生很多小报文，此时可以使用 **Clark 解决方法**或者进行**推迟确认**。关于这几种方案的分析及具体的使用情景可以参考 dog520 大神的这篇文章——[再次谈谈 TCP 的 Nagle 算法与 TCP_CORK 选项](https://blog.csdn.net/dog250/article/details/21303679)。\n## 差错控制\n差错控制用于描述 TCP 在发送或者接受到报文段发生异常时的行为，其主要表现在如下几个方面：\n1. **校验和**：在接受方，如果收到的报文段未通过校验和校验，则立即丢弃，反之，则通过**确认规则**（下面马上提及）进行确认；\n2. **重传**：在发送方，如果一个报文段重传超时计时器（RTO）超时，即在 RTO 时间之后仍然未收到 ACK，则立即重传未被确认的最小的报文段；如果收到四个相同的的 ACK ，则立即重传下一个报文段；\n\n### 确认规则\n1. 当接受方向发送方发送数据报文段时，必须**捎带** ACK；\n2. 当接受方没有数据要发送时，但是收到一个**按序到达**的报文，同时前一个报文段也已经确认过了，那么接收方就推迟发送确认报文段，直到另一个报文段到达或者延迟一段时间以减少 ACK 报文量；\n3. 当所期望的报文段到达，且前一个**按序到达**的报文还未被确认，则立即 ACK（ACK 的序号仍然是下一个正常期望的序号，下同）；\n4. 当序号比期望的大的报文段（**失序**报文段）到达，则立即 ACK，且存储该报文段；\n5. 当**丢失**的报文段到达时，则立即 ACK；\n6. 当**重复**的报文段到达时，则丢弃，且立即 ACK；\n\n## 拥塞控制\n拥塞控制是为了避免因为网络受限导致网络不能按照发送方产生的数据的速度将报文段交付给接受方。与流量控制考察的对象是通信双方不同，拥塞控制的考察对象是通信双方间的网络。拥塞控制的方式表现在发送方的拥塞窗口的变化，从而控制发送方的数据发送快慢。TCP 最初使用的拥塞策略称为 **TCP Tahoe and Reno**。\n### Tahoe and Reno\n这个拥塞策略主要分为慢启动、拥塞避免、拥塞检测三个阶段。\n#### 慢启动\n假设接收窗口大小远大于拥塞窗口，且不考虑延迟确认。拥塞窗口大小从一个最大报文长度 MSS （连接建立时通过 TCP 选项告知）开始，之后每当有一个报文段被确认，拥塞窗口就增大一个 MSS。在这样的策略下，慢启动阶段的拥塞窗口大小呈指数增长。即从 `1 -> 2 -> 4 -> 8`。当到达慢启动门限时，就进入拥塞避免阶段。\n#### 拥塞避免\n拥塞避免阶段拥塞窗口大小继续增加，但是速度放慢，改成当整个窗口大小的报文段都被确认后，窗口大小才增加一个 MSS。表现为 `8 -> 9 -> 10 -> 11`，呈现线性增长。\n#### 拥塞检测\n如果拥塞发生了，因为发生在网络中路由器出现丢包现象，在接受方处的表现为出现以下两种情况，并做出对应的反应：\n1. RTO 计时器超时。这说明网络拥塞的可能性较大，TCP 做出较强烈的反应：\n    a. 把慢启动门限值调整为当前窗口大小的一半；\n    b. 把 cwnd 重新设置为 1 MSS；\n    c. 重新进入慢启动阶段；\n\n2. 收到四个相同的 ACK；说明出现拥塞的可能性较小，但是出现了丢包，TCP 做出较弱的反应，Reno 算法表现为快恢复（Fast recovery）：\n    a. 把慢启动门限值调整为当前窗口大小的一半；\n    b. 把 cwnd 重新设置为慢启动门限值；\n    c. 重新进入拥塞避免阶段；\n\n图示如下：\n![拥塞控制示例](congestion_control_example.png)\nTahoe 算法与 Reno （Tahoe 的改进版本）的区别在于收到四个相同 ACK 时，Tahoe 算法的策略和 RTO 计时器超时时一致。\n### 其他拥塞策略\n拥塞控制策略只需要在发送方实现即可，不需要接受方的参与，因此可以仅在发送方部署一套算法。现在 TCP 网络上的算法也在不断[改进](https://en.wikipedia.org/wiki/TCP_congestion_control)，涌现出诸如 [**TCP CUBIC**](http://www4.ncsu.edu/~rhee/export/bitcp/cubic-paper.pdf)、[**TCP BBR**](https://ai.google/research/pubs/pub45646) 这样的算法。\n\n## TCP 中的计时器\n### 重传计时器\n重传计时器的超时时间为 RTO，RTO 主要根据测量所得的报文段往返时间 RTTm计算而来，计算过程如下：\n\n首先计算平滑 RTT，即RTTs：\n```\nRTTs = RTTm // 第一次测量\nRTTs = (1 - α)RTTs + αRTTm // 随后的测量\n```\n然后计算 RTT 的偏差 RTTd：\n```\nRTTd = RTTm / 2 // 第一次测量\nRTTd = (1 - β)RTTd + β|RTTs - RTTm| // 随后的测量\n```\n重传超时 RTO 的计算如下：\n```\nRTO = 6s // 原始值\nRTO = RTTs + 4RTTd // 第一次测量后\n```\n任意时刻只有一个 RTT 在进行测量，当重传发生时会影响 RTT 的测量，根据 **Karn 算法**，TCP 忽略重传报文的 RTT，而对于重传的报文，RTO 值为原报文的两倍，如果发生第二次重传，则为四倍，以此类推。\n### 持续计时器\n当接受方发送窗口值为 0 的报文段之后，后来因为接收窗口增加需要通告接窗口为非 0，但是通告的 ACK 丢失，这会导致发送方一直等待非 0 窗口通告，导致死锁。持续计时器就是接受方在收到 0 窗口通告后启用，如果超时则发送探测报文，促使接受方重传 ACK。\n### Keep-Alive 计时器\nKeep-Alive 计时器用于防止 TCP 连接长时间空闲，每当收到对方的报文段，这个计时器就复位。这个计时器的超时时间通常可以通过接口进行设定。\n### Time-Wait 计时器\nTime-Wait 计时器对最后的 FIN 进行确认时启动的超时计时器。如果在时常为 2MSL 的计时器超时前再次收到 FIN，则重传 ACK，否则连接彻底关闭。\n\n## 传输层的[未来](https://blog.apnic.net/2017/12/12/internet-protocols-changing/)\n[QIUC](https://www.chromium.org/quic) 了解一下下？\n\n## 参考资料\n1. [TCP/IP 协议族 第四版](https://book.douban.com/subject/5386194/)\n2. [Andrew S.Tanenbaum - Computer Networks 5th](https://book.douban.com/subject/5344443/)\n3. [WikiPedia - Transmission Control Protocol](https://en.wikipedia.org/wiki/Transmission_Control_Protocol)\n4. [WikiPedia - TCP congestion control](https://en.wikipedia.org/wiki/TCP_congestion_contro)\n5. [TCP Flags: PSH and URG](http://packetlife.net/blog/2011/mar/2/tcp-flags-psh-and-urg/)\n6. [KTH - Internetworking Lecture 4](https://www.nada.kth.se/kurser/kth/2D1392/05/lectures/lecture_4.pdf)\n7. [一个 TCP FIN_WAIT2 状态细节引发的感慨](https://blog.csdn.net/dog250/article/details/81256550)","slug":"tcp","published":1,"updated":"2018-08-10T08:22:40.596Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjknq4rfq00092ofnwap3aifd","content":"<p>生产环境遇到些网络问题，知对 TCP 协议还是有些生疏，在此复习记录。<br><a id=\"more\"></a></p>\n<h2 id=\"协议\"><a href=\"#协议\" class=\"headerlink\" title=\"协议\"></a>协议</h2><h3 id=\"报文段格式\"><a href=\"#报文段格式\" class=\"headerlink\" title=\"报文段格式\"></a>报文段格式</h3><p>TCP 协议报文段主要由<strong>首部（Header）</strong> 与<strong>数据（Data）</strong> 两部分组成。在计算校验和是还会加上虚拟的伪首部。此处主要说明首部的组成。<br><img src=\"tcp_header.png\" alt=\"图 1 TCP Header (From: WikiPedia)\"><br>TCP 在网络模型中属于运输层，用于提供进程与进程间的字节流通信服务，因此需要<strong>源 / 目端口（Source / Destination port）</strong> 以确定通信双方进程。使用<strong>序号（Sequence number，seq）</strong> 表明本报文段第一个数据字节的编号，初始序号由双方在 TCP 连接建立时随机生成。使用<strong>确认号（Acknowledgment number，ack）</strong> 表示接受方期望从发送方接受的字节编号。<strong>数据偏移量（Data Offset）</strong> 顾名思义报文段数据开始字节处的偏移量，即 TCP header 的长度，由于选项的存在，首部长度的范围是 20～60 Bytes，但是该字段只有 4 Bits，因此该字段指出首部长度有多少个 4 Bytes。接下来的 3 Bits 被<strong>保留（Reserved）</strong> 。随后会讨论 9 个<strong>标志位（Flags）</strong>。<strong>窗口大小（Window Size）</strong> 定义了接受方的接受窗口大小，由接受方决定，然后告知发送方。在计算<strong>校验和（Checksum）</strong> 时需要加上伪首部，伪首部的内容包括源目 IP 地址，TCP 报文段长度等。如果 URG 标志位被设定了，那<strong>紧急指针（Urgent pointer）</strong> 用于指示紧急数据最后一个字节在报文段数据部分中的偏移量。最后的 40 Bytes 留给<strong>选项（Options）</strong>。</p>\n<h3 id=\"Flags\"><a href=\"#Flags\" class=\"headerlink\" title=\"Flags\"></a>Flags</h3><ul>\n<li><strong>URG</strong>：为 1 表示数据中有紧急数据。这个标记比较少见，可以找到的一些应用有：<a href=\"https://stackoverflow.com/questions/24476458/understanding-tcp-urg-flag\" target=\"_blank\" rel=\"noopener\">FTP</a>，<a href=\"http://packetlife.net/blog/2011/mar/2/tcp-flags-psh-and-urg/\" target=\"_blank\" rel=\"noopener\">Telnet</a>；</li>\n<li><strong>ACK</strong>：为 1 表示确认号字段有效；</li>\n<li><strong>PSH</strong>：为 1 表示有推送数据，这个字段主要完成<a href=\"http://packetlife.net/blog/2011/mar/2/tcp-flags-psh-and-urg/\" target=\"_blank\" rel=\"noopener\">两个功能</a>：发送方应用层提醒 TCP 需要立即发送数据；接受方 TCP 需要将收到的数据立即提交给应用层；</li>\n<li><strong>RST</strong>：为 1 表示出现严重差错。可能需要重现创建 TCP 连接。还可以用于拒绝非法的报文段和拒绝连接请求；</li>\n<li><strong>SYN</strong>：为 1 表示这是连接请求或是连接接受请求，用于创建连接和使顺序号同步；</li>\n<li><strong>FIN</strong>：为 1 表示发送方没有数据要传输了，要求释放连接；</li>\n</ul>\n<h2 id=\"阶段\"><a href=\"#阶段\" class=\"headerlink\" title=\"阶段\"></a>阶段</h2><p>TCP 连接可以分为三个阶段：建立连接，传输数据，终止连接。可以用一个有限状态机表示：<br><img src=\"tcp_connection.png\" alt=\"图 2 TCP 连接 (From: Computer Networks)&lt;br&gt;图中（A/B）这样的文字表示“收到A后执行B，A与B可以是标志位或者指令”&lt;br&gt;深实线表示 Client 的行为，深虚线表示 Server 的行为，浅色线表示特殊行为\"><br>下面结合一个用 Rust 写的 Echo Server 与抓包工具 Wireshark 来演示这三个过程。代码如下：<br><figure class=\"highlight rust\"><figcaption><span>Echo Server</span><a href=\"/downloads/code/echo_server.rs\">view raw</a></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">use</span> std::net::{TcpListener, TcpStream};</span><br><span class=\"line\"><span class=\"keyword\">use</span> std::thread;</span><br><span class=\"line\"><span class=\"keyword\">use</span> std::io::Read;</span><br><span class=\"line\"><span class=\"keyword\">use</span> std::io::Write;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">pub</span> <span class=\"function\"><span class=\"keyword\">fn</span> <span class=\"title\">main</span></span>() {</span><br><span class=\"line\">    <span class=\"keyword\">let</span> listener = TcpListener::bind(<span class=\"string\">\"::1:9999\"</span>).unwrap();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> stream <span class=\"keyword\">in</span> listener.incoming() {</span><br><span class=\"line\">        <span class=\"keyword\">match</span> stream {</span><br><span class=\"line\">            <span class=\"literal\">Ok</span>(stream) =&gt; {</span><br><span class=\"line\">                thread::spawn(|| {</span><br><span class=\"line\">                    handle_client(stream);</span><br><span class=\"line\">                });</span><br><span class=\"line\">            }</span><br><span class=\"line\">            <span class=\"literal\">Err</span>(_) =&gt; {</span><br><span class=\"line\">                <span class=\"built_in\">println!</span>(<span class=\"string\">\"Error\"</span>);</span><br><span class=\"line\">            }</span><br><span class=\"line\">        }</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">fn</span> <span class=\"title\">handle_client</span></span>(<span class=\"keyword\">mut</span> stream: TcpStream) {</span><br><span class=\"line\">    <span class=\"keyword\">loop</span> {</span><br><span class=\"line\">        <span class=\"keyword\">let</span> <span class=\"keyword\">mut</span> read = [<span class=\"number\">0</span>; <span class=\"number\">1024</span>];</span><br><span class=\"line\">        <span class=\"keyword\">match</span> stream.read(&amp;<span class=\"keyword\">mut</span> read) {</span><br><span class=\"line\">            <span class=\"literal\">Ok</span>(n) =&gt; {</span><br><span class=\"line\">                <span class=\"keyword\">if</span> n == <span class=\"number\">0</span> {</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                }</span><br><span class=\"line\">                stream.write(&amp;read[<span class=\"number\">0</span>..n]).unwrap();</span><br><span class=\"line\">            }</span><br><span class=\"line\">            <span class=\"literal\">Err</span>(err) =&gt; {</span><br><span class=\"line\">                <span class=\"built_in\">panic!</span>(err);</span><br><span class=\"line\">            }</span><br><span class=\"line\">        }</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></table></figure><br>Echo Server 启动之后使用 telnet 工具连接至服务器，与服务器交互两次，即回显两次字符串，然后从退出 telnet。抓到的包截图如下：<br><img src=\"wireshark.png\" alt=\"图 3 Wireshark 抓包\"></p>\n<p>在下面的表述中，客户端表示在这一阶段先发起请求的一方，服务端表示在这一阶段先接受请求的一方。在 TCP 中，服务端和客户端之间可以进行双向通信，他们可以理解为对等的，在连接建立后，实际上没有服务端和客户端的区别。</p>\n<h3 id=\"建立连接\"><a href=\"#建立连接\" class=\"headerlink\" title=\"建立连接\"></a>建立连接</h3><p>前三个包代表了建立连接的过程，分为三步，大多数情况下就如同抓包所示，称为<strong>三次握手（3-way handshake）</strong>。图 2 中还画出了双方同时打开连接与连接复位这两种比较少见的情景。</p>\n<ol>\n<li>客户端发送给服务端一个 <strong>SYN</strong> 报文，用以告知服务端初始序号为 0（此处的 Seq 经过 Wireshark 的处理，变成了相对值），然后客户端进入 <strong><em>SYN_SENT</em></strong> 状态。</li>\n<li>服务器收到 1 中报文后，发给客户端一个 <strong>SYN + ACK</strong> 报文，告知客户端初始序号为 0，且接下来期望从客户端收到的序号 Ack 为 1。服务端进入 <strong><em>SYN_RCVD</em></strong> 状态。可见 <strong>SYN 报文消耗了一个序号</strong>。</li>\n<li>客户端给服务端回复 <strong>ACK</strong> 报文，进入 <strong><em>ESTABLISHED</em></strong> 状态，服务端在收到这个报文连接建立完成。可见 <strong>ACK 报文在不携带数据的情况下不消耗序号</strong>。</li>\n</ol>\n<h3 id=\"传输数据\"><a href=\"#传输数据\" class=\"headerlink\" title=\"传输数据\"></a>传输数据</h3><p>图 3 中 P17～P20 与 P72～P74 分别展示了两次交互过程。以第二次交互为例：</p>\n<ol>\n<li>P72 中，客户端将想要回显字符串发送给服务端，告知服务器这个报文段的数据首字节序号为 8，并且希望从服务端收到的下一个序号是 8。</li>\n<li>服务端将回显的字符串与对 P72 的确认一起发送给客户端。P72 的长度为 9，因此报文段中数据的序号范围为 [8,17)，因此在 P73 中 Ack 为 17。</li>\n<li>客户端确认 P73。</li>\n</ol>\n<p>需要注意的是，这两次交互有所区别：第一次交互时，服务端先返回了一个确认给客户端，然后再额外发送一条携带回显内容的报文段。但是第二次交互时省略了单独的确认。</p>\n<h3 id=\"终止连接\"><a href=\"#终止连接\" class=\"headerlink\" title=\"终止连接\"></a>终止连接</h3><p>根据“广大博主”写作的文章与<a href=\"https://www.zhihu.com/question/50646354\" target=\"_blank\" rel=\"noopener\">问答网站的讨论</a>以及各种面经，基本一致认为，终止连接通常被成为<strong>四次挥手（4-way termination）</strong>，即通信双方会有四次交互，但是如图 2 所示，也存在<strong>三次挥手</strong>的可能性，且我本地的多次抓包也如图 3 一致——均为三次挥手，且无一例外。下面对四次挥手进行分析，三次挥手可以被其概括：</p>\n<ol>\n<li>客户端发起终止连接，发出一个 <strong>FIN</strong> 报文给服务端，假设该报文的 Seq 为 X，Ack 为 Y。然后客户端进入 <strong><em>FIN_WAIT1</em></strong> 状态，除重传 FIN 报文与发送 ACK 确认之外，不再发送应用数据给服务端。</li>\n<li>服务端收到 FIN 报文段后先回复一个 <strong>ACK</strong> 报文，进入 <strong><em>CLOSE_WAIT</em></strong> 状态，该报文的 Seq 为 Y，Ack 为 X+1。</li>\n<li>客户端在收到 FIN 的 ACK 之后进入 <strong><em>FIN_WAIT2</em></strong> 状态。此时服务端还可以继续将未发送完的应用数据发送给客户端。</li>\n<li>服务端发送完数据后发送一条 <strong>FIN</strong> 报文，进入 <strong><em>LAST_ACK</em></strong> 状态，该报文的 Seq 为 Y+K，Ack 为 X+1。</li>\n<li>客户端收到服务端的 FIN 后，发送最后的 <strong>ACK</strong> 报文给服务器，然后进入 <strong><em>TIME_WAIT</em></strong> 状态。如果在 2MSL（最大报文段寿命，通常为30～60s）后客户端没再次收到 FIN 报文，则进入 <strong><em>CLOSED</em></strong> 状态，否则重发 ACK 报文进行重试。</li>\n<li>服务端在收到 ACK 报文后进入 <strong><em>CLOSED</em></strong> 状态。</li>\n</ol>\n<p>三次挥手表现为步骤 2～4 合并为一步，即同时发送对客户端 FIN 的 ACK 报文与 服务端自己的 FIN 报文。这条 <strong>FIN+ACK</strong> 报文的 Seq 为 Y，Ack 为 X+1。</p>\n<p>至于在什么情景下出现三次握手或者四次握手，大多数的观点认为先收到 FIN 报文的一方还需要向上层应用询问是否仍然有数据需要发送，因为要等待上层的回复，所以“为何不早点把对 FIN 的 ACK 发出去呢？！”而且立即 Ack 能防止对方重传 FIN。但是有没有存在不需要询问上层或者不需要立即回复 Ack 的可能，就如同传输数据出现的情况一样，这些应该与 TCP 的具体实现相关，目前能力与精力有限，还有待对 <a href=\"https://github.com/torvalds/linux/blob/master/net/ipv4/tcp_output.c\" target=\"_blank\" rel=\"noopener\">Linux TCP 实现源码</a>进行阅读。</p>\n<h2 id=\"滑动窗口\"><a href=\"#滑动窗口\" class=\"headerlink\" title=\"滑动窗口\"></a>滑动窗口</h2><p>滑动窗口是 TCP 中用于实现诸如 ACK 确认、流量控制、拥塞控制的承载结构。如图所示:<br><img src=\"sliding_window.png\" alt=\"图 4 滑动窗口\"><br>先将 TCP 看作是简单的单向通信，则发送方有一个发送窗口，接收方有一个接收窗口。正如图中所示，传输的是报文段，窗口大小的单位是字节。两个窗口中<strong>白色区域</strong>为空白位置，等待被应用层或者网络层填满；<strong>灰色区域</strong>是已经发送但是还没有接受到确认的字节；<strong>粉色区域</strong>在发送窗口中表示等待被发送的字节，在接收窗口汇总表示等待交付的字节。<br>发送窗口的大小为接受方通过首部中窗口大小字段告知的接收窗口大小 rwnd 和之后会讲到的拥塞窗口的大小 cwnd 两者中的较小值，即 <code>min(rwnd , cwnd)</code>。接收窗口大小是接收方可用缓存空间大小，为 <code>rwnd = 缓存大小 - 准备交付的字节数</code>。</p>\n<h2 id=\"流量控制\"><a href=\"#流量控制\" class=\"headerlink\" title=\"流量控制\"></a>流量控制</h2><p>流量控制用于平衡生产者产生数据与消费者消耗数据的速度。TCP 中的流量控制实现的主要途径是不断调整发送窗口的大小实现。发送 TCP 一旦发现发送发送窗口满了就会对发送进程进行反馈。接受方根据之前从发送方收到的数据量和服务器已经消耗的数据量得到自身接收窗口的大小，将这个值告知发送方，发送方根据收到的窗口大小调整自身窗口大小。<br>还有正对通信双方产生数据小或者消费数据慢产生糊涂窗口综合征时，有其他方面的流量控制。当发送方数据量相对于首部小很多的报文很多时，可以使用 <strong>Nagle 算法</strong>减少这种小报文量。当接受方消耗数据很慢时，每次告知发送方的窗口大小会比较小，也可能产生很多小报文，此时可以使用 <strong>Clark 解决方法</strong>或者进行<strong>推迟确认</strong>。关于这几种方案的分析及具体的使用情景可以参考 dog520 大神的这篇文章——<a href=\"https://blog.csdn.net/dog250/article/details/21303679\" target=\"_blank\" rel=\"noopener\">再次谈谈 TCP 的 Nagle 算法与 TCP_CORK 选项</a>。</p>\n<h2 id=\"差错控制\"><a href=\"#差错控制\" class=\"headerlink\" title=\"差错控制\"></a>差错控制</h2><p>差错控制用于描述 TCP 在发送或者接受到报文段发生异常时的行为，其主要表现在如下几个方面：</p>\n<ol>\n<li><strong>校验和</strong>：在接受方，如果收到的报文段未通过校验和校验，则立即丢弃，反之，则通过<strong>确认规则</strong>（下面马上提及）进行确认；</li>\n<li><strong>重传</strong>：在发送方，如果一个报文段重传超时计时器（RTO）超时，即在 RTO 时间之后仍然未收到 ACK，则立即重传未被确认的最小的报文段；如果收到四个相同的的 ACK ，则立即重传下一个报文段；</li>\n</ol>\n<h3 id=\"确认规则\"><a href=\"#确认规则\" class=\"headerlink\" title=\"确认规则\"></a>确认规则</h3><ol>\n<li>当接受方向发送方发送数据报文段时，必须<strong>捎带</strong> ACK；</li>\n<li>当接受方没有数据要发送时，但是收到一个<strong>按序到达</strong>的报文，同时前一个报文段也已经确认过了，那么接收方就推迟发送确认报文段，直到另一个报文段到达或者延迟一段时间以减少 ACK 报文量；</li>\n<li>当所期望的报文段到达，且前一个<strong>按序到达</strong>的报文还未被确认，则立即 ACK（ACK 的序号仍然是下一个正常期望的序号，下同）；</li>\n<li>当序号比期望的大的报文段（<strong>失序</strong>报文段）到达，则立即 ACK，且存储该报文段；</li>\n<li>当<strong>丢失</strong>的报文段到达时，则立即 ACK；</li>\n<li>当<strong>重复</strong>的报文段到达时，则丢弃，且立即 ACK；</li>\n</ol>\n<h2 id=\"拥塞控制\"><a href=\"#拥塞控制\" class=\"headerlink\" title=\"拥塞控制\"></a>拥塞控制</h2><p>拥塞控制是为了避免因为网络受限导致网络不能按照发送方产生的数据的速度将报文段交付给接受方。与流量控制考察的对象是通信双方不同，拥塞控制的考察对象是通信双方间的网络。拥塞控制的方式表现在发送方的拥塞窗口的变化，从而控制发送方的数据发送快慢。TCP 最初使用的拥塞策略称为 <strong>TCP Tahoe and Reno</strong>。</p>\n<h3 id=\"Tahoe-and-Reno\"><a href=\"#Tahoe-and-Reno\" class=\"headerlink\" title=\"Tahoe and Reno\"></a>Tahoe and Reno</h3><p>这个拥塞策略主要分为慢启动、拥塞避免、拥塞检测三个阶段。</p>\n<h4 id=\"慢启动\"><a href=\"#慢启动\" class=\"headerlink\" title=\"慢启动\"></a>慢启动</h4><p>假设接收窗口大小远大于拥塞窗口，且不考虑延迟确认。拥塞窗口大小从一个最大报文长度 MSS （连接建立时通过 TCP 选项告知）开始，之后每当有一个报文段被确认，拥塞窗口就增大一个 MSS。在这样的策略下，慢启动阶段的拥塞窗口大小呈指数增长。即从 <code>1 -&gt; 2 -&gt; 4 -&gt; 8</code>。当到达慢启动门限时，就进入拥塞避免阶段。</p>\n<h4 id=\"拥塞避免\"><a href=\"#拥塞避免\" class=\"headerlink\" title=\"拥塞避免\"></a>拥塞避免</h4><p>拥塞避免阶段拥塞窗口大小继续增加，但是速度放慢，改成当整个窗口大小的报文段都被确认后，窗口大小才增加一个 MSS。表现为 <code>8 -&gt; 9 -&gt; 10 -&gt; 11</code>，呈现线性增长。</p>\n<h4 id=\"拥塞检测\"><a href=\"#拥塞检测\" class=\"headerlink\" title=\"拥塞检测\"></a>拥塞检测</h4><p>如果拥塞发生了，因为发生在网络中路由器出现丢包现象，在接受方处的表现为出现以下两种情况，并做出对应的反应：</p>\n<ol>\n<li><p>RTO 计时器超时。这说明网络拥塞的可能性较大，TCP 做出较强烈的反应：<br> a. 把慢启动门限值调整为当前窗口大小的一半；<br> b. 把 cwnd 重新设置为 1 MSS；<br> c. 重新进入慢启动阶段；</p>\n</li>\n<li><p>收到四个相同的 ACK；说明出现拥塞的可能性较小，但是出现了丢包，TCP 做出较弱的反应，Reno 算法表现为快恢复（Fast recovery）：<br> a. 把慢启动门限值调整为当前窗口大小的一半；<br> b. 把 cwnd 重新设置为慢启动门限值；<br> c. 重新进入拥塞避免阶段；</p>\n</li>\n</ol>\n<p>图示如下：<br><img src=\"congestion_control_example.png\" alt=\"拥塞控制示例\"><br>Tahoe 算法与 Reno （Tahoe 的改进版本）的区别在于收到四个相同 ACK 时，Tahoe 算法的策略和 RTO 计时器超时时一致。</p>\n<h3 id=\"其他拥塞策略\"><a href=\"#其他拥塞策略\" class=\"headerlink\" title=\"其他拥塞策略\"></a>其他拥塞策略</h3><p>拥塞控制策略只需要在发送方实现即可，不需要接受方的参与，因此可以仅在发送方部署一套算法。现在 TCP 网络上的算法也在不断<a href=\"https://en.wikipedia.org/wiki/TCP_congestion_control\" target=\"_blank\" rel=\"noopener\">改进</a>，涌现出诸如 <a href=\"http://www4.ncsu.edu/~rhee/export/bitcp/cubic-paper.pdf\" target=\"_blank\" rel=\"noopener\"><strong>TCP CUBIC</strong></a>、<a href=\"https://ai.google/research/pubs/pub45646\" target=\"_blank\" rel=\"noopener\"><strong>TCP BBR</strong></a> 这样的算法。</p>\n<h2 id=\"TCP-中的计时器\"><a href=\"#TCP-中的计时器\" class=\"headerlink\" title=\"TCP 中的计时器\"></a>TCP 中的计时器</h2><h3 id=\"重传计时器\"><a href=\"#重传计时器\" class=\"headerlink\" title=\"重传计时器\"></a>重传计时器</h3><p>重传计时器的超时时间为 RTO，RTO 主要根据测量所得的报文段往返时间 RTTm计算而来，计算过程如下：</p>\n<p>首先计算平滑 RTT，即RTTs：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">RTTs = RTTm // 第一次测量</span><br><span class=\"line\">RTTs = (1 - α)RTTs + αRTTm // 随后的测量</span><br></pre></td></tr></table></figure></p>\n<p>然后计算 RTT 的偏差 RTTd：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">RTTd = RTTm / 2 // 第一次测量</span><br><span class=\"line\">RTTd = (1 - β)RTTd + β|RTTs - RTTm| // 随后的测量</span><br></pre></td></tr></table></figure></p>\n<p>重传超时 RTO 的计算如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">RTO = 6s // 原始值</span><br><span class=\"line\">RTO = RTTs + 4RTTd // 第一次测量后</span><br></pre></td></tr></table></figure></p>\n<p>任意时刻只有一个 RTT 在进行测量，当重传发生时会影响 RTT 的测量，根据 <strong>Karn 算法</strong>，TCP 忽略重传报文的 RTT，而对于重传的报文，RTO 值为原报文的两倍，如果发生第二次重传，则为四倍，以此类推。</p>\n<h3 id=\"持续计时器\"><a href=\"#持续计时器\" class=\"headerlink\" title=\"持续计时器\"></a>持续计时器</h3><p>当接受方发送窗口值为 0 的报文段之后，后来因为接收窗口增加需要通告接窗口为非 0，但是通告的 ACK 丢失，这会导致发送方一直等待非 0 窗口通告，导致死锁。持续计时器就是接受方在收到 0 窗口通告后启用，如果超时则发送探测报文，促使接受方重传 ACK。</p>\n<h3 id=\"Keep-Alive-计时器\"><a href=\"#Keep-Alive-计时器\" class=\"headerlink\" title=\"Keep-Alive 计时器\"></a>Keep-Alive 计时器</h3><p>Keep-Alive 计时器用于防止 TCP 连接长时间空闲，每当收到对方的报文段，这个计时器就复位。这个计时器的超时时间通常可以通过接口进行设定。</p>\n<h3 id=\"Time-Wait-计时器\"><a href=\"#Time-Wait-计时器\" class=\"headerlink\" title=\"Time-Wait 计时器\"></a>Time-Wait 计时器</h3><p>Time-Wait 计时器对最后的 FIN 进行确认时启动的超时计时器。如果在时常为 2MSL 的计时器超时前再次收到 FIN，则重传 ACK，否则连接彻底关闭。</p>\n<h2 id=\"传输层的未来\"><a href=\"#传输层的未来\" class=\"headerlink\" title=\"传输层的未来\"></a>传输层的<a href=\"https://blog.apnic.net/2017/12/12/internet-protocols-changing/\" target=\"_blank\" rel=\"noopener\">未来</a></h2><p><a href=\"https://www.chromium.org/quic\" target=\"_blank\" rel=\"noopener\">QIUC</a> 了解一下下？</p>\n<h2 id=\"参考资料\"><a href=\"#参考资料\" class=\"headerlink\" title=\"参考资料\"></a>参考资料</h2><ol>\n<li><a href=\"https://book.douban.com/subject/5386194/\" target=\"_blank\" rel=\"noopener\">TCP/IP 协议族 第四版</a></li>\n<li><a href=\"https://book.douban.com/subject/5344443/\" target=\"_blank\" rel=\"noopener\">Andrew S.Tanenbaum - Computer Networks 5th</a></li>\n<li><a href=\"https://en.wikipedia.org/wiki/Transmission_Control_Protocol\" target=\"_blank\" rel=\"noopener\">WikiPedia - Transmission Control Protocol</a></li>\n<li><a href=\"https://en.wikipedia.org/wiki/TCP_congestion_contro\" target=\"_blank\" rel=\"noopener\">WikiPedia - TCP congestion control</a></li>\n<li><a href=\"http://packetlife.net/blog/2011/mar/2/tcp-flags-psh-and-urg/\" target=\"_blank\" rel=\"noopener\">TCP Flags: PSH and URG</a></li>\n<li><a href=\"https://www.nada.kth.se/kurser/kth/2D1392/05/lectures/lecture_4.pdf\" target=\"_blank\" rel=\"noopener\">KTH - Internetworking Lecture 4</a></li>\n<li><a href=\"https://blog.csdn.net/dog250/article/details/81256550\" target=\"_blank\" rel=\"noopener\">一个 TCP FIN_WAIT2 状态细节引发的感慨</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"<p>生产环境遇到些网络问题，知对 TCP 协议还是有些生疏，在此复习记录。<br>","more":"</p>\n<h2 id=\"协议\"><a href=\"#协议\" class=\"headerlink\" title=\"协议\"></a>协议</h2><h3 id=\"报文段格式\"><a href=\"#报文段格式\" class=\"headerlink\" title=\"报文段格式\"></a>报文段格式</h3><p>TCP 协议报文段主要由<strong>首部（Header）</strong> 与<strong>数据（Data）</strong> 两部分组成。在计算校验和是还会加上虚拟的伪首部。此处主要说明首部的组成。<br><img src=\"tcp_header.png\" alt=\"图 1 TCP Header (From: WikiPedia)\"><br>TCP 在网络模型中属于运输层，用于提供进程与进程间的字节流通信服务，因此需要<strong>源 / 目端口（Source / Destination port）</strong> 以确定通信双方进程。使用<strong>序号（Sequence number，seq）</strong> 表明本报文段第一个数据字节的编号，初始序号由双方在 TCP 连接建立时随机生成。使用<strong>确认号（Acknowledgment number，ack）</strong> 表示接受方期望从发送方接受的字节编号。<strong>数据偏移量（Data Offset）</strong> 顾名思义报文段数据开始字节处的偏移量，即 TCP header 的长度，由于选项的存在，首部长度的范围是 20～60 Bytes，但是该字段只有 4 Bits，因此该字段指出首部长度有多少个 4 Bytes。接下来的 3 Bits 被<strong>保留（Reserved）</strong> 。随后会讨论 9 个<strong>标志位（Flags）</strong>。<strong>窗口大小（Window Size）</strong> 定义了接受方的接受窗口大小，由接受方决定，然后告知发送方。在计算<strong>校验和（Checksum）</strong> 时需要加上伪首部，伪首部的内容包括源目 IP 地址，TCP 报文段长度等。如果 URG 标志位被设定了，那<strong>紧急指针（Urgent pointer）</strong> 用于指示紧急数据最后一个字节在报文段数据部分中的偏移量。最后的 40 Bytes 留给<strong>选项（Options）</strong>。</p>\n<h3 id=\"Flags\"><a href=\"#Flags\" class=\"headerlink\" title=\"Flags\"></a>Flags</h3><ul>\n<li><strong>URG</strong>：为 1 表示数据中有紧急数据。这个标记比较少见，可以找到的一些应用有：<a href=\"https://stackoverflow.com/questions/24476458/understanding-tcp-urg-flag\" target=\"_blank\" rel=\"noopener\">FTP</a>，<a href=\"http://packetlife.net/blog/2011/mar/2/tcp-flags-psh-and-urg/\" target=\"_blank\" rel=\"noopener\">Telnet</a>；</li>\n<li><strong>ACK</strong>：为 1 表示确认号字段有效；</li>\n<li><strong>PSH</strong>：为 1 表示有推送数据，这个字段主要完成<a href=\"http://packetlife.net/blog/2011/mar/2/tcp-flags-psh-and-urg/\" target=\"_blank\" rel=\"noopener\">两个功能</a>：发送方应用层提醒 TCP 需要立即发送数据；接受方 TCP 需要将收到的数据立即提交给应用层；</li>\n<li><strong>RST</strong>：为 1 表示出现严重差错。可能需要重现创建 TCP 连接。还可以用于拒绝非法的报文段和拒绝连接请求；</li>\n<li><strong>SYN</strong>：为 1 表示这是连接请求或是连接接受请求，用于创建连接和使顺序号同步；</li>\n<li><strong>FIN</strong>：为 1 表示发送方没有数据要传输了，要求释放连接；</li>\n</ul>\n<h2 id=\"阶段\"><a href=\"#阶段\" class=\"headerlink\" title=\"阶段\"></a>阶段</h2><p>TCP 连接可以分为三个阶段：建立连接，传输数据，终止连接。可以用一个有限状态机表示：<br><img src=\"tcp_connection.png\" alt=\"图 2 TCP 连接 (From: Computer Networks)&lt;br&gt;图中（A/B）这样的文字表示“收到A后执行B，A与B可以是标志位或者指令”&lt;br&gt;深实线表示 Client 的行为，深虚线表示 Server 的行为，浅色线表示特殊行为\"><br>下面结合一个用 Rust 写的 Echo Server 与抓包工具 Wireshark 来演示这三个过程。代码如下：<br><figure class=\"highlight rust\"><figcaption><span>Echo Server</span><a href=\"/downloads/code/echo_server.rs\">view raw</a></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">use</span> std::net::{TcpListener, TcpStream};</span><br><span class=\"line\"><span class=\"keyword\">use</span> std::thread;</span><br><span class=\"line\"><span class=\"keyword\">use</span> std::io::Read;</span><br><span class=\"line\"><span class=\"keyword\">use</span> std::io::Write;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">pub</span> <span class=\"function\"><span class=\"keyword\">fn</span> <span class=\"title\">main</span></span>() {</span><br><span class=\"line\">    <span class=\"keyword\">let</span> listener = TcpListener::bind(<span class=\"string\">\"::1:9999\"</span>).unwrap();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> stream <span class=\"keyword\">in</span> listener.incoming() {</span><br><span class=\"line\">        <span class=\"keyword\">match</span> stream {</span><br><span class=\"line\">            <span class=\"literal\">Ok</span>(stream) =&gt; {</span><br><span class=\"line\">                thread::spawn(|| {</span><br><span class=\"line\">                    handle_client(stream);</span><br><span class=\"line\">                });</span><br><span class=\"line\">            }</span><br><span class=\"line\">            <span class=\"literal\">Err</span>(_) =&gt; {</span><br><span class=\"line\">                <span class=\"built_in\">println!</span>(<span class=\"string\">\"Error\"</span>);</span><br><span class=\"line\">            }</span><br><span class=\"line\">        }</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">fn</span> <span class=\"title\">handle_client</span></span>(<span class=\"keyword\">mut</span> stream: TcpStream) {</span><br><span class=\"line\">    <span class=\"keyword\">loop</span> {</span><br><span class=\"line\">        <span class=\"keyword\">let</span> <span class=\"keyword\">mut</span> read = [<span class=\"number\">0</span>; <span class=\"number\">1024</span>];</span><br><span class=\"line\">        <span class=\"keyword\">match</span> stream.read(&amp;<span class=\"keyword\">mut</span> read) {</span><br><span class=\"line\">            <span class=\"literal\">Ok</span>(n) =&gt; {</span><br><span class=\"line\">                <span class=\"keyword\">if</span> n == <span class=\"number\">0</span> {</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                }</span><br><span class=\"line\">                stream.write(&amp;read[<span class=\"number\">0</span>..n]).unwrap();</span><br><span class=\"line\">            }</span><br><span class=\"line\">            <span class=\"literal\">Err</span>(err) =&gt; {</span><br><span class=\"line\">                <span class=\"built_in\">panic!</span>(err);</span><br><span class=\"line\">            }</span><br><span class=\"line\">        }</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></table></figure><br>Echo Server 启动之后使用 telnet 工具连接至服务器，与服务器交互两次，即回显两次字符串，然后从退出 telnet。抓到的包截图如下：<br><img src=\"wireshark.png\" alt=\"图 3 Wireshark 抓包\"></p>\n<p>在下面的表述中，客户端表示在这一阶段先发起请求的一方，服务端表示在这一阶段先接受请求的一方。在 TCP 中，服务端和客户端之间可以进行双向通信，他们可以理解为对等的，在连接建立后，实际上没有服务端和客户端的区别。</p>\n<h3 id=\"建立连接\"><a href=\"#建立连接\" class=\"headerlink\" title=\"建立连接\"></a>建立连接</h3><p>前三个包代表了建立连接的过程，分为三步，大多数情况下就如同抓包所示，称为<strong>三次握手（3-way handshake）</strong>。图 2 中还画出了双方同时打开连接与连接复位这两种比较少见的情景。</p>\n<ol>\n<li>客户端发送给服务端一个 <strong>SYN</strong> 报文，用以告知服务端初始序号为 0（此处的 Seq 经过 Wireshark 的处理，变成了相对值），然后客户端进入 <strong><em>SYN_SENT</em></strong> 状态。</li>\n<li>服务器收到 1 中报文后，发给客户端一个 <strong>SYN + ACK</strong> 报文，告知客户端初始序号为 0，且接下来期望从客户端收到的序号 Ack 为 1。服务端进入 <strong><em>SYN_RCVD</em></strong> 状态。可见 <strong>SYN 报文消耗了一个序号</strong>。</li>\n<li>客户端给服务端回复 <strong>ACK</strong> 报文，进入 <strong><em>ESTABLISHED</em></strong> 状态，服务端在收到这个报文连接建立完成。可见 <strong>ACK 报文在不携带数据的情况下不消耗序号</strong>。</li>\n</ol>\n<h3 id=\"传输数据\"><a href=\"#传输数据\" class=\"headerlink\" title=\"传输数据\"></a>传输数据</h3><p>图 3 中 P17～P20 与 P72～P74 分别展示了两次交互过程。以第二次交互为例：</p>\n<ol>\n<li>P72 中，客户端将想要回显字符串发送给服务端，告知服务器这个报文段的数据首字节序号为 8，并且希望从服务端收到的下一个序号是 8。</li>\n<li>服务端将回显的字符串与对 P72 的确认一起发送给客户端。P72 的长度为 9，因此报文段中数据的序号范围为 [8,17)，因此在 P73 中 Ack 为 17。</li>\n<li>客户端确认 P73。</li>\n</ol>\n<p>需要注意的是，这两次交互有所区别：第一次交互时，服务端先返回了一个确认给客户端，然后再额外发送一条携带回显内容的报文段。但是第二次交互时省略了单独的确认。</p>\n<h3 id=\"终止连接\"><a href=\"#终止连接\" class=\"headerlink\" title=\"终止连接\"></a>终止连接</h3><p>根据“广大博主”写作的文章与<a href=\"https://www.zhihu.com/question/50646354\" target=\"_blank\" rel=\"noopener\">问答网站的讨论</a>以及各种面经，基本一致认为，终止连接通常被成为<strong>四次挥手（4-way termination）</strong>，即通信双方会有四次交互，但是如图 2 所示，也存在<strong>三次挥手</strong>的可能性，且我本地的多次抓包也如图 3 一致——均为三次挥手，且无一例外。下面对四次挥手进行分析，三次挥手可以被其概括：</p>\n<ol>\n<li>客户端发起终止连接，发出一个 <strong>FIN</strong> 报文给服务端，假设该报文的 Seq 为 X，Ack 为 Y。然后客户端进入 <strong><em>FIN_WAIT1</em></strong> 状态，除重传 FIN 报文与发送 ACK 确认之外，不再发送应用数据给服务端。</li>\n<li>服务端收到 FIN 报文段后先回复一个 <strong>ACK</strong> 报文，进入 <strong><em>CLOSE_WAIT</em></strong> 状态，该报文的 Seq 为 Y，Ack 为 X+1。</li>\n<li>客户端在收到 FIN 的 ACK 之后进入 <strong><em>FIN_WAIT2</em></strong> 状态。此时服务端还可以继续将未发送完的应用数据发送给客户端。</li>\n<li>服务端发送完数据后发送一条 <strong>FIN</strong> 报文，进入 <strong><em>LAST_ACK</em></strong> 状态，该报文的 Seq 为 Y+K，Ack 为 X+1。</li>\n<li>客户端收到服务端的 FIN 后，发送最后的 <strong>ACK</strong> 报文给服务器，然后进入 <strong><em>TIME_WAIT</em></strong> 状态。如果在 2MSL（最大报文段寿命，通常为30～60s）后客户端没再次收到 FIN 报文，则进入 <strong><em>CLOSED</em></strong> 状态，否则重发 ACK 报文进行重试。</li>\n<li>服务端在收到 ACK 报文后进入 <strong><em>CLOSED</em></strong> 状态。</li>\n</ol>\n<p>三次挥手表现为步骤 2～4 合并为一步，即同时发送对客户端 FIN 的 ACK 报文与 服务端自己的 FIN 报文。这条 <strong>FIN+ACK</strong> 报文的 Seq 为 Y，Ack 为 X+1。</p>\n<p>至于在什么情景下出现三次握手或者四次握手，大多数的观点认为先收到 FIN 报文的一方还需要向上层应用询问是否仍然有数据需要发送，因为要等待上层的回复，所以“为何不早点把对 FIN 的 ACK 发出去呢？！”而且立即 Ack 能防止对方重传 FIN。但是有没有存在不需要询问上层或者不需要立即回复 Ack 的可能，就如同传输数据出现的情况一样，这些应该与 TCP 的具体实现相关，目前能力与精力有限，还有待对 <a href=\"https://github.com/torvalds/linux/blob/master/net/ipv4/tcp_output.c\" target=\"_blank\" rel=\"noopener\">Linux TCP 实现源码</a>进行阅读。</p>\n<h2 id=\"滑动窗口\"><a href=\"#滑动窗口\" class=\"headerlink\" title=\"滑动窗口\"></a>滑动窗口</h2><p>滑动窗口是 TCP 中用于实现诸如 ACK 确认、流量控制、拥塞控制的承载结构。如图所示:<br><img src=\"sliding_window.png\" alt=\"图 4 滑动窗口\"><br>先将 TCP 看作是简单的单向通信，则发送方有一个发送窗口，接收方有一个接收窗口。正如图中所示，传输的是报文段，窗口大小的单位是字节。两个窗口中<strong>白色区域</strong>为空白位置，等待被应用层或者网络层填满；<strong>灰色区域</strong>是已经发送但是还没有接受到确认的字节；<strong>粉色区域</strong>在发送窗口中表示等待被发送的字节，在接收窗口汇总表示等待交付的字节。<br>发送窗口的大小为接受方通过首部中窗口大小字段告知的接收窗口大小 rwnd 和之后会讲到的拥塞窗口的大小 cwnd 两者中的较小值，即 <code>min(rwnd , cwnd)</code>。接收窗口大小是接收方可用缓存空间大小，为 <code>rwnd = 缓存大小 - 准备交付的字节数</code>。</p>\n<h2 id=\"流量控制\"><a href=\"#流量控制\" class=\"headerlink\" title=\"流量控制\"></a>流量控制</h2><p>流量控制用于平衡生产者产生数据与消费者消耗数据的速度。TCP 中的流量控制实现的主要途径是不断调整发送窗口的大小实现。发送 TCP 一旦发现发送发送窗口满了就会对发送进程进行反馈。接受方根据之前从发送方收到的数据量和服务器已经消耗的数据量得到自身接收窗口的大小，将这个值告知发送方，发送方根据收到的窗口大小调整自身窗口大小。<br>还有正对通信双方产生数据小或者消费数据慢产生糊涂窗口综合征时，有其他方面的流量控制。当发送方数据量相对于首部小很多的报文很多时，可以使用 <strong>Nagle 算法</strong>减少这种小报文量。当接受方消耗数据很慢时，每次告知发送方的窗口大小会比较小，也可能产生很多小报文，此时可以使用 <strong>Clark 解决方法</strong>或者进行<strong>推迟确认</strong>。关于这几种方案的分析及具体的使用情景可以参考 dog520 大神的这篇文章——<a href=\"https://blog.csdn.net/dog250/article/details/21303679\" target=\"_blank\" rel=\"noopener\">再次谈谈 TCP 的 Nagle 算法与 TCP_CORK 选项</a>。</p>\n<h2 id=\"差错控制\"><a href=\"#差错控制\" class=\"headerlink\" title=\"差错控制\"></a>差错控制</h2><p>差错控制用于描述 TCP 在发送或者接受到报文段发生异常时的行为，其主要表现在如下几个方面：</p>\n<ol>\n<li><strong>校验和</strong>：在接受方，如果收到的报文段未通过校验和校验，则立即丢弃，反之，则通过<strong>确认规则</strong>（下面马上提及）进行确认；</li>\n<li><strong>重传</strong>：在发送方，如果一个报文段重传超时计时器（RTO）超时，即在 RTO 时间之后仍然未收到 ACK，则立即重传未被确认的最小的报文段；如果收到四个相同的的 ACK ，则立即重传下一个报文段；</li>\n</ol>\n<h3 id=\"确认规则\"><a href=\"#确认规则\" class=\"headerlink\" title=\"确认规则\"></a>确认规则</h3><ol>\n<li>当接受方向发送方发送数据报文段时，必须<strong>捎带</strong> ACK；</li>\n<li>当接受方没有数据要发送时，但是收到一个<strong>按序到达</strong>的报文，同时前一个报文段也已经确认过了，那么接收方就推迟发送确认报文段，直到另一个报文段到达或者延迟一段时间以减少 ACK 报文量；</li>\n<li>当所期望的报文段到达，且前一个<strong>按序到达</strong>的报文还未被确认，则立即 ACK（ACK 的序号仍然是下一个正常期望的序号，下同）；</li>\n<li>当序号比期望的大的报文段（<strong>失序</strong>报文段）到达，则立即 ACK，且存储该报文段；</li>\n<li>当<strong>丢失</strong>的报文段到达时，则立即 ACK；</li>\n<li>当<strong>重复</strong>的报文段到达时，则丢弃，且立即 ACK；</li>\n</ol>\n<h2 id=\"拥塞控制\"><a href=\"#拥塞控制\" class=\"headerlink\" title=\"拥塞控制\"></a>拥塞控制</h2><p>拥塞控制是为了避免因为网络受限导致网络不能按照发送方产生的数据的速度将报文段交付给接受方。与流量控制考察的对象是通信双方不同，拥塞控制的考察对象是通信双方间的网络。拥塞控制的方式表现在发送方的拥塞窗口的变化，从而控制发送方的数据发送快慢。TCP 最初使用的拥塞策略称为 <strong>TCP Tahoe and Reno</strong>。</p>\n<h3 id=\"Tahoe-and-Reno\"><a href=\"#Tahoe-and-Reno\" class=\"headerlink\" title=\"Tahoe and Reno\"></a>Tahoe and Reno</h3><p>这个拥塞策略主要分为慢启动、拥塞避免、拥塞检测三个阶段。</p>\n<h4 id=\"慢启动\"><a href=\"#慢启动\" class=\"headerlink\" title=\"慢启动\"></a>慢启动</h4><p>假设接收窗口大小远大于拥塞窗口，且不考虑延迟确认。拥塞窗口大小从一个最大报文长度 MSS （连接建立时通过 TCP 选项告知）开始，之后每当有一个报文段被确认，拥塞窗口就增大一个 MSS。在这样的策略下，慢启动阶段的拥塞窗口大小呈指数增长。即从 <code>1 -&gt; 2 -&gt; 4 -&gt; 8</code>。当到达慢启动门限时，就进入拥塞避免阶段。</p>\n<h4 id=\"拥塞避免\"><a href=\"#拥塞避免\" class=\"headerlink\" title=\"拥塞避免\"></a>拥塞避免</h4><p>拥塞避免阶段拥塞窗口大小继续增加，但是速度放慢，改成当整个窗口大小的报文段都被确认后，窗口大小才增加一个 MSS。表现为 <code>8 -&gt; 9 -&gt; 10 -&gt; 11</code>，呈现线性增长。</p>\n<h4 id=\"拥塞检测\"><a href=\"#拥塞检测\" class=\"headerlink\" title=\"拥塞检测\"></a>拥塞检测</h4><p>如果拥塞发生了，因为发生在网络中路由器出现丢包现象，在接受方处的表现为出现以下两种情况，并做出对应的反应：</p>\n<ol>\n<li><p>RTO 计时器超时。这说明网络拥塞的可能性较大，TCP 做出较强烈的反应：<br> a. 把慢启动门限值调整为当前窗口大小的一半；<br> b. 把 cwnd 重新设置为 1 MSS；<br> c. 重新进入慢启动阶段；</p>\n</li>\n<li><p>收到四个相同的 ACK；说明出现拥塞的可能性较小，但是出现了丢包，TCP 做出较弱的反应，Reno 算法表现为快恢复（Fast recovery）：<br> a. 把慢启动门限值调整为当前窗口大小的一半；<br> b. 把 cwnd 重新设置为慢启动门限值；<br> c. 重新进入拥塞避免阶段；</p>\n</li>\n</ol>\n<p>图示如下：<br><img src=\"congestion_control_example.png\" alt=\"拥塞控制示例\"><br>Tahoe 算法与 Reno （Tahoe 的改进版本）的区别在于收到四个相同 ACK 时，Tahoe 算法的策略和 RTO 计时器超时时一致。</p>\n<h3 id=\"其他拥塞策略\"><a href=\"#其他拥塞策略\" class=\"headerlink\" title=\"其他拥塞策略\"></a>其他拥塞策略</h3><p>拥塞控制策略只需要在发送方实现即可，不需要接受方的参与，因此可以仅在发送方部署一套算法。现在 TCP 网络上的算法也在不断<a href=\"https://en.wikipedia.org/wiki/TCP_congestion_control\" target=\"_blank\" rel=\"noopener\">改进</a>，涌现出诸如 <a href=\"http://www4.ncsu.edu/~rhee/export/bitcp/cubic-paper.pdf\" target=\"_blank\" rel=\"noopener\"><strong>TCP CUBIC</strong></a>、<a href=\"https://ai.google/research/pubs/pub45646\" target=\"_blank\" rel=\"noopener\"><strong>TCP BBR</strong></a> 这样的算法。</p>\n<h2 id=\"TCP-中的计时器\"><a href=\"#TCP-中的计时器\" class=\"headerlink\" title=\"TCP 中的计时器\"></a>TCP 中的计时器</h2><h3 id=\"重传计时器\"><a href=\"#重传计时器\" class=\"headerlink\" title=\"重传计时器\"></a>重传计时器</h3><p>重传计时器的超时时间为 RTO，RTO 主要根据测量所得的报文段往返时间 RTTm计算而来，计算过程如下：</p>\n<p>首先计算平滑 RTT，即RTTs：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">RTTs = RTTm // 第一次测量</span><br><span class=\"line\">RTTs = (1 - α)RTTs + αRTTm // 随后的测量</span><br></pre></td></tr></table></figure></p>\n<p>然后计算 RTT 的偏差 RTTd：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">RTTd = RTTm / 2 // 第一次测量</span><br><span class=\"line\">RTTd = (1 - β)RTTd + β|RTTs - RTTm| // 随后的测量</span><br></pre></td></tr></table></figure></p>\n<p>重传超时 RTO 的计算如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">RTO = 6s // 原始值</span><br><span class=\"line\">RTO = RTTs + 4RTTd // 第一次测量后</span><br></pre></td></tr></table></figure></p>\n<p>任意时刻只有一个 RTT 在进行测量，当重传发生时会影响 RTT 的测量，根据 <strong>Karn 算法</strong>，TCP 忽略重传报文的 RTT，而对于重传的报文，RTO 值为原报文的两倍，如果发生第二次重传，则为四倍，以此类推。</p>\n<h3 id=\"持续计时器\"><a href=\"#持续计时器\" class=\"headerlink\" title=\"持续计时器\"></a>持续计时器</h3><p>当接受方发送窗口值为 0 的报文段之后，后来因为接收窗口增加需要通告接窗口为非 0，但是通告的 ACK 丢失，这会导致发送方一直等待非 0 窗口通告，导致死锁。持续计时器就是接受方在收到 0 窗口通告后启用，如果超时则发送探测报文，促使接受方重传 ACK。</p>\n<h3 id=\"Keep-Alive-计时器\"><a href=\"#Keep-Alive-计时器\" class=\"headerlink\" title=\"Keep-Alive 计时器\"></a>Keep-Alive 计时器</h3><p>Keep-Alive 计时器用于防止 TCP 连接长时间空闲，每当收到对方的报文段，这个计时器就复位。这个计时器的超时时间通常可以通过接口进行设定。</p>\n<h3 id=\"Time-Wait-计时器\"><a href=\"#Time-Wait-计时器\" class=\"headerlink\" title=\"Time-Wait 计时器\"></a>Time-Wait 计时器</h3><p>Time-Wait 计时器对最后的 FIN 进行确认时启动的超时计时器。如果在时常为 2MSL 的计时器超时前再次收到 FIN，则重传 ACK，否则连接彻底关闭。</p>\n<h2 id=\"传输层的未来\"><a href=\"#传输层的未来\" class=\"headerlink\" title=\"传输层的未来\"></a>传输层的<a href=\"https://blog.apnic.net/2017/12/12/internet-protocols-changing/\" target=\"_blank\" rel=\"noopener\">未来</a></h2><p><a href=\"https://www.chromium.org/quic\" target=\"_blank\" rel=\"noopener\">QIUC</a> 了解一下下？</p>\n<h2 id=\"参考资料\"><a href=\"#参考资料\" class=\"headerlink\" title=\"参考资料\"></a>参考资料</h2><ol>\n<li><a href=\"https://book.douban.com/subject/5386194/\" target=\"_blank\" rel=\"noopener\">TCP/IP 协议族 第四版</a></li>\n<li><a href=\"https://book.douban.com/subject/5344443/\" target=\"_blank\" rel=\"noopener\">Andrew S.Tanenbaum - Computer Networks 5th</a></li>\n<li><a href=\"https://en.wikipedia.org/wiki/Transmission_Control_Protocol\" target=\"_blank\" rel=\"noopener\">WikiPedia - Transmission Control Protocol</a></li>\n<li><a href=\"https://en.wikipedia.org/wiki/TCP_congestion_contro\" target=\"_blank\" rel=\"noopener\">WikiPedia - TCP congestion control</a></li>\n<li><a href=\"http://packetlife.net/blog/2011/mar/2/tcp-flags-psh-and-urg/\" target=\"_blank\" rel=\"noopener\">TCP Flags: PSH and URG</a></li>\n<li><a href=\"https://www.nada.kth.se/kurser/kth/2D1392/05/lectures/lecture_4.pdf\" target=\"_blank\" rel=\"noopener\">KTH - Internetworking Lecture 4</a></li>\n<li><a href=\"https://blog.csdn.net/dog250/article/details/81256550\" target=\"_blank\" rel=\"noopener\">一个 TCP FIN_WAIT2 状态细节引发的感慨</a></li>\n</ol>"},{"title":"µTP 协议 —— 对 BEP29 的简要理解","keywords":[],"date":"2018-08-04T09:05:00.000Z","_content":"在 {% post_link tcp %}中回顾了 TCP，而这篇文章主要讲用于 BT 网络的基于 UDP 的运输层协议 µTP，同时顺便回顾 UDP。下面的内容更多是基于对 [BEP29](http://www.bittorrent.org/beps/bep_0029.html) （BitTorrent 的 29 号提案，或者直翻为增强建议，类似的有 JEP，PEP）的理解。\n## 名字探究\n  µTP 的主要文档 BEP29 的创建于 2009 年，姑且认为这也是设计完成的大致时间，µTP 在 uTorrent 的 1.8 中首次加入（2009 年）这个事实也佐证了这点。它的设计者包括：\n - [Ludvig Strigeus](https://en.wikipedia.org/wiki/Ludvig_Strigeus)（μTorrent 作者，BitTorrent 公司 2006 年收购 μTorrent，目前在 Spotify 工作）\n - Greg Hazel\n - [Stanislav Shalunov](https://www.linkedin.com/in/shalunov)（µTP 中的拥塞算法 [LEDBAT](https://tools.ietf.org/html/rfc6817) 主要作者，后来还创造了可以脱离现有蜂窝网络使用的 IM 应用 [FireChat](https://www.opengarden.com/firechat.html) —— 它被多次用到”占中”这样的公民运动中）\n - Arvid Norberg（libtorrent 开发者，目前在 [Blockstream](https://blockstream.com/) 工作）\n - Bram Cohen（BitTorrent 作者）\n\n## 设计原因\n  在过去多年前，如果使用 BT 进行下载热门资源的话可以感受到到速度飞快，但是同时带来的问题就是如果想要同时看在线视频就会带来卡顿。问题在于 DSL 和 modem 的往往有一个和它们的发送速率不成比例的发送缓冲区，不成比例到可以容纳几秒钟的数据量。而 BT 往往会与许多 peer 建立 TCP 连接，在 TCP 将带宽均匀地分配到每个连接的前提下，BT 就占用了较多的带宽，但是其他诸如浏览网页、即时通讯这些场景的优先级实际上应该要比 BT 传输更高些，但是因为 BT 和 物理层的这种特性导致了其他服务有延迟，影响了使用 BT 时其他服务的体验。\n  µTP 通过将 modem 的缓冲队列的大小作为一个控制因子来调整发送速率，当队列过大时，将会放慢发送速度。这种策略使得 BT 在没有竞争的情况下可以充分利用上传带宽，在有大量其他流量的情况下则放慢发送速率。\n  上述时 Bittorrent 文档中的说法，但是实际上 µTP 是基于包的延时的，而不是基于队列大小的。而且 µTP 具体对拥塞算法 LEDBAT 的实现有与在 IETF 互联网草案 [RFC 6817](https://tools.ietf.org/html/rfc6817) 中的描述有所区别（这里的实现指 C++ 版本的 [libutp](https://github.com/bittorrent/libutp)，各个版本的实现不完全一致）。\n\n## UDP 和 µTP 首部\n  为了方便与 TCP 做简单的对比，把 UDP 的首部（前四个字节）与 µTP 的首部（剩余部分）放在了一个图中示意。从 UDP 首部字段数量皆可以发现 UDP 协议相对 TCP 协议是如此简单，以至于我们w可以将 TCP 协议看成是类似 µTP 协议一样的基于 UDP 协议的运输层协议。\n![UDP Header And µTP Header](udp_utp_header.png)\n\n### UDP 首部\n - **源 / 目端口（Source / Destination port）**：用于确认通信进程双方。源端口是可选的，如果设置了源端口，则接收方将其视为回复端口。如果不需要回复就不需要设置；\n - **总长度（Length）**：定义了 UDP 用户数据报的总长度，包括首部和数据。TCP 首部中是没有所谓“报文段总长度”的字段的，长度可以通过 IP 层的长度减去 IP 首部长度计算所得，所以一定程度上时冗余的，可以参考 Stack OverFlow 上的[相关讨论](https://stackoverflow.com/a/16748680/5091903)；\n - **校验和（Checksum）**：用于对整个用户数据报的校验，通过 IP 位首部与和用户数据报计算得到；\n\n  可见 UDP 首部的这些字段在理论上可以是 TCP 首部字段的子集。因此我们可以粗略地讲 **TCP 是基于 UDP 的传输层协议。**\n  UDP 服务是一个“尽力而为”的服务，它**没有流量控制**，**只能通过校验和进行差错控制，丢包不会知晓，也不会重传**，也**没有拥塞控制**。\n### µTP 首部\n - **version**：版本号，现在为 1，[还有一个原始版本号 0 存在](https://github.com/boundary/wireshark/blob/master/epan/dissectors/packet-bt-utp.c)\n - **connection_id**：用于标记连接。[这个字段是必须的么?](http://www.calvinneo.com/2017/12/05/libutp%E6%BA%90%E7%A0%81%E7%AE%80%E6%9E%90/#utp-context%E7%9A%84%E6%88%90%E5%91%98)；\n - **timestamp_microseconds**：发送数据包的时间，和计算延迟时间，rtt 相关；\n - **timestamp_difference_microseconds**：当前时间和上一次收到的包中的 timestamp_microseconds 之差；\n - **wnd_size**：表示另一端建议的窗口大小，相当于 TCP 中的接收窗口；\n - **extension**：代表第一个扩展的类型，0 表示没有扩展，1 表示 Selective ACKs（选择确认扩展）。\n - **type**：数据包的类型。可以有：\n     - ST_DATA  = 0：承载有效数据的数据包；\n     - ST_FIN   = 1：终止连接。是通信单方发送的最后一个包，类似于 TCP 的 FIN 标记。但是发送 ST_FIN 的一方还是会等待可能丢失或者失序到达的包，即使收到了对方的 ST_FIN 包；\n     - ST_STATE = 2：用于报告状态，传输一个没有数据的 ACK。和 TCP 中未携带数据的 ACK 包一样，它不消耗序号；\n     - ST_RESET = 3：强制重置连接。类似 TCP 的 RST 标记。\n     - ST_SYN   = 4：发起连接。类似 TCP 的 SYN 标记。发起方会随机一个 connection_id ID 用于给接收方后续的回复使用。然后发起方之后的包中传输的 connection_id 为 ID + 1；\n - **seq_nr**：表示这个数据包的序号。注意和 TCP 中代表字号号的序号有所不同。初始序号同样也是随机生成。\n - **ack_nr**：表示最后收到的数据包的seq_nr；\n\n## 连接过程\n  图示为一次在 qBittorrent 中对一个种子开始 BT 下载二十秒左右后停止下载时，与其中一个 peer 的交互过程。\n![连接过程（以 connection_id 为 8671 和 8672 的这一个过程为例）](wireshark.png)\n\n## 丢包\n和丢包处理有一个和窗口相关的变量需要先进行说明：\n - ***max_window***：定义了未被确认的字节的上限，相当与 TCP 中的拥塞窗口；\n - ***wnd_size***：同首部中的 wnd_size，和 TCP 中相同，实际的发送窗口大小为 `min(max_windows, wnd_size)`；\n - ***cur_window***：表示当前未被确认的字节的数量；\n\n当需要发送数据包时，仅当 `cur_window + packet_size <= min(max_windows, wnd_size)` 成立，这个数据包才能被发送。\n\n - 当序号为 `seq_nr - cur_window` 的数据包（发送队列中年龄最大的未被确认的数据包，下一个理论上需要被确认的就是它）没有被确认，但是已经有至少三个序号大于它的数据包通过 Selective ACK 被确认，那么这个数据包被认为是丢失了。\n - 如果 `ack_nr + 1` 这个包已经发送了，而收到三个重复的 `ack_nr` 的 ACK，那么 `ack_nr + 1`这个包被认为是丢失了。\n\n如果检测到丢包，那么拥塞窗口 **max_window** 大小减半。\n## 超时\nµTP 的超时计时和 TCP 中 RTO 计时器不太一样，RTO 计时器主要用于对 ACK 的计时，但是　µTP 的计时器则是指接收任何数据包超时时间，如果超时时间内没有任何数据包到达则超时，如果超时，则 **packet_size** 和 **max_window** 将都会被设置为最小数据包大小（150 字节）。 **（疑问？：packet_size 的调整策略是什么）**\n\n### 超时时间的计算\n每当收到一个数据包的 ACK，就会更新往返时间（不考虑重传的包），往返时间用于计算超时时间。先说明下相关的变量：\n - ***rtt***：往返时间；\n - ***rtt_var***：往返时间差异；\n - ***packet_rtt***：当前收到 ACK 对应的包的往返时间，即当前时间减去这个包发送时的时间，即首部中的 timestamp 字段记录的值。\n - ***timeout***：超时时间；\n\n通过以下公式更新 rtt：\n```\ndelta = rtt - packet_rtt\nrtt_var += (abs(delta) - rtt_var) / 4;\nrtt += (packet_rtt - rtt) / 8;\n```\n正常情况下通过 rtt 计算得到 timeout（第一次由于没有 rtt，timeout 使用初始值 1000 ms，）：\n```\ntimeout = max(rtt + rtt_var * 4, 500);\n```\n如果遇到超时，则 timeout 翻倍。\n\n## 拥塞控制\n在**丢包**和**超时**部分已经涉及到拥塞窗口的调整了。µTP 的拥塞控制可以理解为一种基于延迟的负反馈拥塞控制，通过延迟的变化控制窗口大小的变化，达到拥塞控制目的。计算窗口大小过程中的相关常量和变量的定义如下：\n - ***CONTROL_TARGET***：µTP 所能接收的上行缓冲延迟，现在是 100 ms；\n - ***base_delay***：两分钟内的收到的数据包的最低延迟；\n - ***our_delay***：当前的数据包延迟；\n - ***off_target***：实际延迟和目标延迟的差距。即`CONTROL_TARGET - our_delay`；\n - ***outstanding_packet***：已经被发送但是未被确认的数据包；\n\n具体计算过程如下：\n```\ndelay_factor = off_target / CCONTROL_TARGET;\nwindow_factor = outstanding_packet / max_window;\nscaled_gain = MAX_CWND_INCREASE_PACKETS_PER_RTT * delay_factor * window_factor;\n\nmax_window += scaled_gain;\n```\n当 `off_target > 0` 时，当前包的延迟时间比设定的还小一些，那么窗口会缩小，发送速率就会放慢；反之，窗口增加，速率加快。\n\n\n## 参考资料\n1. [BitTorrent Enhancement Proposal 29 - µTorrent transport protocol](http://www.bittorrent.org/beps/bep_0029.html)\n2. [RFC 6817 - Low Extra Delay Background Transport (LEDBAT)](https://tools.ietf.org/html/rfc6817)\n3. [Calvin's Marbles - libutp源码简析](http://www.calvinneo.com/2017/12/05/libutp%E6%BA%90%E7%A0%81%E7%AE%80%E6%9E%90/)","source":"_posts/µtp.md","raw":"---\ntitle: µTP 协议 —— 对 BEP29 的简要理解\nkeywords: []\ndate: 2018/08/04 17:05:00\ntags: [Network, BT]\ncategories:\n---\n在 {% post_link tcp %}中回顾了 TCP，而这篇文章主要讲用于 BT 网络的基于 UDP 的运输层协议 µTP，同时顺便回顾 UDP。下面的内容更多是基于对 [BEP29](http://www.bittorrent.org/beps/bep_0029.html) （BitTorrent 的 29 号提案，或者直翻为增强建议，类似的有 JEP，PEP）的理解。\n## 名字探究\n  µTP 的主要文档 BEP29 的创建于 2009 年，姑且认为这也是设计完成的大致时间，µTP 在 uTorrent 的 1.8 中首次加入（2009 年）这个事实也佐证了这点。它的设计者包括：\n - [Ludvig Strigeus](https://en.wikipedia.org/wiki/Ludvig_Strigeus)（μTorrent 作者，BitTorrent 公司 2006 年收购 μTorrent，目前在 Spotify 工作）\n - Greg Hazel\n - [Stanislav Shalunov](https://www.linkedin.com/in/shalunov)（µTP 中的拥塞算法 [LEDBAT](https://tools.ietf.org/html/rfc6817) 主要作者，后来还创造了可以脱离现有蜂窝网络使用的 IM 应用 [FireChat](https://www.opengarden.com/firechat.html) —— 它被多次用到”占中”这样的公民运动中）\n - Arvid Norberg（libtorrent 开发者，目前在 [Blockstream](https://blockstream.com/) 工作）\n - Bram Cohen（BitTorrent 作者）\n\n## 设计原因\n  在过去多年前，如果使用 BT 进行下载热门资源的话可以感受到到速度飞快，但是同时带来的问题就是如果想要同时看在线视频就会带来卡顿。问题在于 DSL 和 modem 的往往有一个和它们的发送速率不成比例的发送缓冲区，不成比例到可以容纳几秒钟的数据量。而 BT 往往会与许多 peer 建立 TCP 连接，在 TCP 将带宽均匀地分配到每个连接的前提下，BT 就占用了较多的带宽，但是其他诸如浏览网页、即时通讯这些场景的优先级实际上应该要比 BT 传输更高些，但是因为 BT 和 物理层的这种特性导致了其他服务有延迟，影响了使用 BT 时其他服务的体验。\n  µTP 通过将 modem 的缓冲队列的大小作为一个控制因子来调整发送速率，当队列过大时，将会放慢发送速度。这种策略使得 BT 在没有竞争的情况下可以充分利用上传带宽，在有大量其他流量的情况下则放慢发送速率。\n  上述时 Bittorrent 文档中的说法，但是实际上 µTP 是基于包的延时的，而不是基于队列大小的。而且 µTP 具体对拥塞算法 LEDBAT 的实现有与在 IETF 互联网草案 [RFC 6817](https://tools.ietf.org/html/rfc6817) 中的描述有所区别（这里的实现指 C++ 版本的 [libutp](https://github.com/bittorrent/libutp)，各个版本的实现不完全一致）。\n\n## UDP 和 µTP 首部\n  为了方便与 TCP 做简单的对比，把 UDP 的首部（前四个字节）与 µTP 的首部（剩余部分）放在了一个图中示意。从 UDP 首部字段数量皆可以发现 UDP 协议相对 TCP 协议是如此简单，以至于我们w可以将 TCP 协议看成是类似 µTP 协议一样的基于 UDP 协议的运输层协议。\n![UDP Header And µTP Header](udp_utp_header.png)\n\n### UDP 首部\n - **源 / 目端口（Source / Destination port）**：用于确认通信进程双方。源端口是可选的，如果设置了源端口，则接收方将其视为回复端口。如果不需要回复就不需要设置；\n - **总长度（Length）**：定义了 UDP 用户数据报的总长度，包括首部和数据。TCP 首部中是没有所谓“报文段总长度”的字段的，长度可以通过 IP 层的长度减去 IP 首部长度计算所得，所以一定程度上时冗余的，可以参考 Stack OverFlow 上的[相关讨论](https://stackoverflow.com/a/16748680/5091903)；\n - **校验和（Checksum）**：用于对整个用户数据报的校验，通过 IP 位首部与和用户数据报计算得到；\n\n  可见 UDP 首部的这些字段在理论上可以是 TCP 首部字段的子集。因此我们可以粗略地讲 **TCP 是基于 UDP 的传输层协议。**\n  UDP 服务是一个“尽力而为”的服务，它**没有流量控制**，**只能通过校验和进行差错控制，丢包不会知晓，也不会重传**，也**没有拥塞控制**。\n### µTP 首部\n - **version**：版本号，现在为 1，[还有一个原始版本号 0 存在](https://github.com/boundary/wireshark/blob/master/epan/dissectors/packet-bt-utp.c)\n - **connection_id**：用于标记连接。[这个字段是必须的么?](http://www.calvinneo.com/2017/12/05/libutp%E6%BA%90%E7%A0%81%E7%AE%80%E6%9E%90/#utp-context%E7%9A%84%E6%88%90%E5%91%98)；\n - **timestamp_microseconds**：发送数据包的时间，和计算延迟时间，rtt 相关；\n - **timestamp_difference_microseconds**：当前时间和上一次收到的包中的 timestamp_microseconds 之差；\n - **wnd_size**：表示另一端建议的窗口大小，相当于 TCP 中的接收窗口；\n - **extension**：代表第一个扩展的类型，0 表示没有扩展，1 表示 Selective ACKs（选择确认扩展）。\n - **type**：数据包的类型。可以有：\n     - ST_DATA  = 0：承载有效数据的数据包；\n     - ST_FIN   = 1：终止连接。是通信单方发送的最后一个包，类似于 TCP 的 FIN 标记。但是发送 ST_FIN 的一方还是会等待可能丢失或者失序到达的包，即使收到了对方的 ST_FIN 包；\n     - ST_STATE = 2：用于报告状态，传输一个没有数据的 ACK。和 TCP 中未携带数据的 ACK 包一样，它不消耗序号；\n     - ST_RESET = 3：强制重置连接。类似 TCP 的 RST 标记。\n     - ST_SYN   = 4：发起连接。类似 TCP 的 SYN 标记。发起方会随机一个 connection_id ID 用于给接收方后续的回复使用。然后发起方之后的包中传输的 connection_id 为 ID + 1；\n - **seq_nr**：表示这个数据包的序号。注意和 TCP 中代表字号号的序号有所不同。初始序号同样也是随机生成。\n - **ack_nr**：表示最后收到的数据包的seq_nr；\n\n## 连接过程\n  图示为一次在 qBittorrent 中对一个种子开始 BT 下载二十秒左右后停止下载时，与其中一个 peer 的交互过程。\n![连接过程（以 connection_id 为 8671 和 8672 的这一个过程为例）](wireshark.png)\n\n## 丢包\n和丢包处理有一个和窗口相关的变量需要先进行说明：\n - ***max_window***：定义了未被确认的字节的上限，相当与 TCP 中的拥塞窗口；\n - ***wnd_size***：同首部中的 wnd_size，和 TCP 中相同，实际的发送窗口大小为 `min(max_windows, wnd_size)`；\n - ***cur_window***：表示当前未被确认的字节的数量；\n\n当需要发送数据包时，仅当 `cur_window + packet_size <= min(max_windows, wnd_size)` 成立，这个数据包才能被发送。\n\n - 当序号为 `seq_nr - cur_window` 的数据包（发送队列中年龄最大的未被确认的数据包，下一个理论上需要被确认的就是它）没有被确认，但是已经有至少三个序号大于它的数据包通过 Selective ACK 被确认，那么这个数据包被认为是丢失了。\n - 如果 `ack_nr + 1` 这个包已经发送了，而收到三个重复的 `ack_nr` 的 ACK，那么 `ack_nr + 1`这个包被认为是丢失了。\n\n如果检测到丢包，那么拥塞窗口 **max_window** 大小减半。\n## 超时\nµTP 的超时计时和 TCP 中 RTO 计时器不太一样，RTO 计时器主要用于对 ACK 的计时，但是　µTP 的计时器则是指接收任何数据包超时时间，如果超时时间内没有任何数据包到达则超时，如果超时，则 **packet_size** 和 **max_window** 将都会被设置为最小数据包大小（150 字节）。 **（疑问？：packet_size 的调整策略是什么）**\n\n### 超时时间的计算\n每当收到一个数据包的 ACK，就会更新往返时间（不考虑重传的包），往返时间用于计算超时时间。先说明下相关的变量：\n - ***rtt***：往返时间；\n - ***rtt_var***：往返时间差异；\n - ***packet_rtt***：当前收到 ACK 对应的包的往返时间，即当前时间减去这个包发送时的时间，即首部中的 timestamp 字段记录的值。\n - ***timeout***：超时时间；\n\n通过以下公式更新 rtt：\n```\ndelta = rtt - packet_rtt\nrtt_var += (abs(delta) - rtt_var) / 4;\nrtt += (packet_rtt - rtt) / 8;\n```\n正常情况下通过 rtt 计算得到 timeout（第一次由于没有 rtt，timeout 使用初始值 1000 ms，）：\n```\ntimeout = max(rtt + rtt_var * 4, 500);\n```\n如果遇到超时，则 timeout 翻倍。\n\n## 拥塞控制\n在**丢包**和**超时**部分已经涉及到拥塞窗口的调整了。µTP 的拥塞控制可以理解为一种基于延迟的负反馈拥塞控制，通过延迟的变化控制窗口大小的变化，达到拥塞控制目的。计算窗口大小过程中的相关常量和变量的定义如下：\n - ***CONTROL_TARGET***：µTP 所能接收的上行缓冲延迟，现在是 100 ms；\n - ***base_delay***：两分钟内的收到的数据包的最低延迟；\n - ***our_delay***：当前的数据包延迟；\n - ***off_target***：实际延迟和目标延迟的差距。即`CONTROL_TARGET - our_delay`；\n - ***outstanding_packet***：已经被发送但是未被确认的数据包；\n\n具体计算过程如下：\n```\ndelay_factor = off_target / CCONTROL_TARGET;\nwindow_factor = outstanding_packet / max_window;\nscaled_gain = MAX_CWND_INCREASE_PACKETS_PER_RTT * delay_factor * window_factor;\n\nmax_window += scaled_gain;\n```\n当 `off_target > 0` 时，当前包的延迟时间比设定的还小一些，那么窗口会缩小，发送速率就会放慢；反之，窗口增加，速率加快。\n\n\n## 参考资料\n1. [BitTorrent Enhancement Proposal 29 - µTorrent transport protocol](http://www.bittorrent.org/beps/bep_0029.html)\n2. [RFC 6817 - Low Extra Delay Background Transport (LEDBAT)](https://tools.ietf.org/html/rfc6817)\n3. [Calvin's Marbles - libutp源码简析](http://www.calvinneo.com/2017/12/05/libutp%E6%BA%90%E7%A0%81%E7%AE%80%E6%9E%90/)","slug":"µtp","published":1,"updated":"2018-08-10T08:21:14.033Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjknq4rfr000a2ofnm2u6ykix","content":"<p>在 <a href=\"/2018/07/20/tcp/\" title=\"TCP 温故知新\">TCP 温故知新</a>中回顾了 TCP，而这篇文章主要讲用于 BT 网络的基于 UDP 的运输层协议 µTP，同时顺便回顾 UDP。下面的内容更多是基于对 <a href=\"http://www.bittorrent.org/beps/bep_0029.html\" target=\"_blank\" rel=\"noopener\">BEP29</a> （BitTorrent 的 29 号提案，或者直翻为增强建议，类似的有 JEP，PEP）的理解。</p>\n<h2 id=\"名字探究\"><a href=\"#名字探究\" class=\"headerlink\" title=\"名字探究\"></a>名字探究</h2><p>  µTP 的主要文档 BEP29 的创建于 2009 年，姑且认为这也是设计完成的大致时间，µTP 在 uTorrent 的 1.8 中首次加入（2009 年）这个事实也佐证了这点。它的设计者包括：</p>\n<ul>\n<li><a href=\"https://en.wikipedia.org/wiki/Ludvig_Strigeus\" target=\"_blank\" rel=\"noopener\">Ludvig Strigeus</a>（μTorrent 作者，BitTorrent 公司 2006 年收购 μTorrent，目前在 Spotify 工作）</li>\n<li>Greg Hazel</li>\n<li><a href=\"https://www.linkedin.com/in/shalunov\" target=\"_blank\" rel=\"noopener\">Stanislav Shalunov</a>（µTP 中的拥塞算法 <a href=\"https://tools.ietf.org/html/rfc6817\" target=\"_blank\" rel=\"noopener\">LEDBAT</a> 主要作者，后来还创造了可以脱离现有蜂窝网络使用的 IM 应用 <a href=\"https://www.opengarden.com/firechat.html\" target=\"_blank\" rel=\"noopener\">FireChat</a> —— 它被多次用到”占中”这样的公民运动中）</li>\n<li>Arvid Norberg（libtorrent 开发者，目前在 <a href=\"https://blockstream.com/\" target=\"_blank\" rel=\"noopener\">Blockstream</a> 工作）</li>\n<li>Bram Cohen（BitTorrent 作者）</li>\n</ul>\n<h2 id=\"设计原因\"><a href=\"#设计原因\" class=\"headerlink\" title=\"设计原因\"></a>设计原因</h2><p>  在过去多年前，如果使用 BT 进行下载热门资源的话可以感受到到速度飞快，但是同时带来的问题就是如果想要同时看在线视频就会带来卡顿。问题在于 DSL 和 modem 的往往有一个和它们的发送速率不成比例的发送缓冲区，不成比例到可以容纳几秒钟的数据量。而 BT 往往会与许多 peer 建立 TCP 连接，在 TCP 将带宽均匀地分配到每个连接的前提下，BT 就占用了较多的带宽，但是其他诸如浏览网页、即时通讯这些场景的优先级实际上应该要比 BT 传输更高些，但是因为 BT 和 物理层的这种特性导致了其他服务有延迟，影响了使用 BT 时其他服务的体验。<br>  µTP 通过将 modem 的缓冲队列的大小作为一个控制因子来调整发送速率，当队列过大时，将会放慢发送速度。这种策略使得 BT 在没有竞争的情况下可以充分利用上传带宽，在有大量其他流量的情况下则放慢发送速率。<br>  上述时 Bittorrent 文档中的说法，但是实际上 µTP 是基于包的延时的，而不是基于队列大小的。而且 µTP 具体对拥塞算法 LEDBAT 的实现有与在 IETF 互联网草案 <a href=\"https://tools.ietf.org/html/rfc6817\" target=\"_blank\" rel=\"noopener\">RFC 6817</a> 中的描述有所区别（这里的实现指 C++ 版本的 <a href=\"https://github.com/bittorrent/libutp\" target=\"_blank\" rel=\"noopener\">libutp</a>，各个版本的实现不完全一致）。</p>\n<h2 id=\"UDP-和-µTP-首部\"><a href=\"#UDP-和-µTP-首部\" class=\"headerlink\" title=\"UDP 和 µTP 首部\"></a>UDP 和 µTP 首部</h2><p>  为了方便与 TCP 做简单的对比，把 UDP 的首部（前四个字节）与 µTP 的首部（剩余部分）放在了一个图中示意。从 UDP 首部字段数量皆可以发现 UDP 协议相对 TCP 协议是如此简单，以至于我们w可以将 TCP 协议看成是类似 µTP 协议一样的基于 UDP 协议的运输层协议。<br><img src=\"udp_utp_header.png\" alt=\"UDP Header And µTP Header\"></p>\n<h3 id=\"UDP-首部\"><a href=\"#UDP-首部\" class=\"headerlink\" title=\"UDP 首部\"></a>UDP 首部</h3><ul>\n<li><strong>源 / 目端口（Source / Destination port）</strong>：用于确认通信进程双方。源端口是可选的，如果设置了源端口，则接收方将其视为回复端口。如果不需要回复就不需要设置；</li>\n<li><strong>总长度（Length）</strong>：定义了 UDP 用户数据报的总长度，包括首部和数据。TCP 首部中是没有所谓“报文段总长度”的字段的，长度可以通过 IP 层的长度减去 IP 首部长度计算所得，所以一定程度上时冗余的，可以参考 Stack OverFlow 上的<a href=\"https://stackoverflow.com/a/16748680/5091903\" target=\"_blank\" rel=\"noopener\">相关讨论</a>；</li>\n<li><strong>校验和（Checksum）</strong>：用于对整个用户数据报的校验，通过 IP 位首部与和用户数据报计算得到；</li>\n</ul>\n<p>  可见 UDP 首部的这些字段在理论上可以是 TCP 首部字段的子集。因此我们可以粗略地讲 <strong>TCP 是基于 UDP 的传输层协议。</strong><br>  UDP 服务是一个“尽力而为”的服务，它<strong>没有流量控制</strong>，<strong>只能通过校验和进行差错控制，丢包不会知晓，也不会重传</strong>，也<strong>没有拥塞控制</strong>。</p>\n<h3 id=\"µTP-首部\"><a href=\"#µTP-首部\" class=\"headerlink\" title=\"µTP 首部\"></a>µTP 首部</h3><ul>\n<li><strong>version</strong>：版本号，现在为 1，<a href=\"https://github.com/boundary/wireshark/blob/master/epan/dissectors/packet-bt-utp.c\" target=\"_blank\" rel=\"noopener\">还有一个原始版本号 0 存在</a></li>\n<li><strong>connection_id</strong>：用于标记连接。<a href=\"http://www.calvinneo.com/2017/12/05/libutp%E6%BA%90%E7%A0%81%E7%AE%80%E6%9E%90/#utp-context%E7%9A%84%E6%88%90%E5%91%98\" target=\"_blank\" rel=\"noopener\">这个字段是必须的么?</a>；</li>\n<li><strong>timestamp_microseconds</strong>：发送数据包的时间，和计算延迟时间，rtt 相关；</li>\n<li><strong>timestamp_difference_microseconds</strong>：当前时间和上一次收到的包中的 timestamp_microseconds 之差；</li>\n<li><strong>wnd_size</strong>：表示另一端建议的窗口大小，相当于 TCP 中的接收窗口；</li>\n<li><strong>extension</strong>：代表第一个扩展的类型，0 表示没有扩展，1 表示 Selective ACKs（选择确认扩展）。</li>\n<li><strong>type</strong>：数据包的类型。可以有：<ul>\n<li>ST_DATA  = 0：承载有效数据的数据包；</li>\n<li>ST_FIN   = 1：终止连接。是通信单方发送的最后一个包，类似于 TCP 的 FIN 标记。但是发送 ST_FIN 的一方还是会等待可能丢失或者失序到达的包，即使收到了对方的 ST_FIN 包；</li>\n<li>ST_STATE = 2：用于报告状态，传输一个没有数据的 ACK。和 TCP 中未携带数据的 ACK 包一样，它不消耗序号；</li>\n<li>ST_RESET = 3：强制重置连接。类似 TCP 的 RST 标记。</li>\n<li>ST_SYN   = 4：发起连接。类似 TCP 的 SYN 标记。发起方会随机一个 connection_id ID 用于给接收方后续的回复使用。然后发起方之后的包中传输的 connection_id 为 ID + 1；</li>\n</ul>\n</li>\n<li><strong>seq_nr</strong>：表示这个数据包的序号。注意和 TCP 中代表字号号的序号有所不同。初始序号同样也是随机生成。</li>\n<li><strong>ack_nr</strong>：表示最后收到的数据包的seq_nr；</li>\n</ul>\n<h2 id=\"连接过程\"><a href=\"#连接过程\" class=\"headerlink\" title=\"连接过程\"></a>连接过程</h2><p>  图示为一次在 qBittorrent 中对一个种子开始 BT 下载二十秒左右后停止下载时，与其中一个 peer 的交互过程。<br><img src=\"wireshark.png\" alt=\"连接过程（以 connection_id 为 8671 和 8672 的这一个过程为例）\"></p>\n<h2 id=\"丢包\"><a href=\"#丢包\" class=\"headerlink\" title=\"丢包\"></a>丢包</h2><p>和丢包处理有一个和窗口相关的变量需要先进行说明：</p>\n<ul>\n<li><strong><em>max_window</em></strong>：定义了未被确认的字节的上限，相当与 TCP 中的拥塞窗口；</li>\n<li><strong><em>wnd_size</em></strong>：同首部中的 wnd_size，和 TCP 中相同，实际的发送窗口大小为 <code>min(max_windows, wnd_size)</code>；</li>\n<li><strong><em>cur_window</em></strong>：表示当前未被确认的字节的数量；</li>\n</ul>\n<p>当需要发送数据包时，仅当 <code>cur_window + packet_size &lt;= min(max_windows, wnd_size)</code> 成立，这个数据包才能被发送。</p>\n<ul>\n<li>当序号为 <code>seq_nr - cur_window</code> 的数据包（发送队列中年龄最大的未被确认的数据包，下一个理论上需要被确认的就是它）没有被确认，但是已经有至少三个序号大于它的数据包通过 Selective ACK 被确认，那么这个数据包被认为是丢失了。</li>\n<li>如果 <code>ack_nr + 1</code> 这个包已经发送了，而收到三个重复的 <code>ack_nr</code> 的 ACK，那么 <code>ack_nr + 1</code>这个包被认为是丢失了。</li>\n</ul>\n<p>如果检测到丢包，那么拥塞窗口 <strong>max_window</strong> 大小减半。</p>\n<h2 id=\"超时\"><a href=\"#超时\" class=\"headerlink\" title=\"超时\"></a>超时</h2><p>µTP 的超时计时和 TCP 中 RTO 计时器不太一样，RTO 计时器主要用于对 ACK 的计时，但是　µTP 的计时器则是指接收任何数据包超时时间，如果超时时间内没有任何数据包到达则超时，如果超时，则 <strong>packet_size</strong> 和 <strong>max_window</strong> 将都会被设置为最小数据包大小（150 字节）。 <strong>（疑问？：packet_size 的调整策略是什么）</strong></p>\n<h3 id=\"超时时间的计算\"><a href=\"#超时时间的计算\" class=\"headerlink\" title=\"超时时间的计算\"></a>超时时间的计算</h3><p>每当收到一个数据包的 ACK，就会更新往返时间（不考虑重传的包），往返时间用于计算超时时间。先说明下相关的变量：</p>\n<ul>\n<li><strong><em>rtt</em></strong>：往返时间；</li>\n<li><strong><em>rtt_var</em></strong>：往返时间差异；</li>\n<li><strong><em>packet_rtt</em></strong>：当前收到 ACK 对应的包的往返时间，即当前时间减去这个包发送时的时间，即首部中的 timestamp 字段记录的值。</li>\n<li><strong><em>timeout</em></strong>：超时时间；</li>\n</ul>\n<p>通过以下公式更新 rtt：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">delta = rtt - packet_rtt</span><br><span class=\"line\">rtt_var += (abs(delta) - rtt_var) / 4;</span><br><span class=\"line\">rtt += (packet_rtt - rtt) / 8;</span><br></pre></td></tr></table></figure></p>\n<p>正常情况下通过 rtt 计算得到 timeout（第一次由于没有 rtt，timeout 使用初始值 1000 ms，）：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">timeout = max(rtt + rtt_var * 4, 500);</span><br></pre></td></tr></table></figure></p>\n<p>如果遇到超时，则 timeout 翻倍。</p>\n<h2 id=\"拥塞控制\"><a href=\"#拥塞控制\" class=\"headerlink\" title=\"拥塞控制\"></a>拥塞控制</h2><p>在<strong>丢包</strong>和<strong>超时</strong>部分已经涉及到拥塞窗口的调整了。µTP 的拥塞控制可以理解为一种基于延迟的负反馈拥塞控制，通过延迟的变化控制窗口大小的变化，达到拥塞控制目的。计算窗口大小过程中的相关常量和变量的定义如下：</p>\n<ul>\n<li><strong><em>CONTROL_TARGET</em></strong>：µTP 所能接收的上行缓冲延迟，现在是 100 ms；</li>\n<li><strong><em>base_delay</em></strong>：两分钟内的收到的数据包的最低延迟；</li>\n<li><strong><em>our_delay</em></strong>：当前的数据包延迟；</li>\n<li><strong><em>off_target</em></strong>：实际延迟和目标延迟的差距。即<code>CONTROL_TARGET - our_delay</code>；</li>\n<li><strong><em>outstanding_packet</em></strong>：已经被发送但是未被确认的数据包；</li>\n</ul>\n<p>具体计算过程如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">delay_factor = off_target / CCONTROL_TARGET;</span><br><span class=\"line\">window_factor = outstanding_packet / max_window;</span><br><span class=\"line\">scaled_gain = MAX_CWND_INCREASE_PACKETS_PER_RTT * delay_factor * window_factor;</span><br><span class=\"line\"></span><br><span class=\"line\">max_window += scaled_gain;</span><br></pre></td></tr></table></figure></p>\n<p>当 <code>off_target &gt; 0</code> 时，当前包的延迟时间比设定的还小一些，那么窗口会缩小，发送速率就会放慢；反之，窗口增加，速率加快。</p>\n<h2 id=\"参考资料\"><a href=\"#参考资料\" class=\"headerlink\" title=\"参考资料\"></a>参考资料</h2><ol>\n<li><a href=\"http://www.bittorrent.org/beps/bep_0029.html\" target=\"_blank\" rel=\"noopener\">BitTorrent Enhancement Proposal 29 - µTorrent transport protocol</a></li>\n<li><a href=\"https://tools.ietf.org/html/rfc6817\" target=\"_blank\" rel=\"noopener\">RFC 6817 - Low Extra Delay Background Transport (LEDBAT)</a></li>\n<li><a href=\"http://www.calvinneo.com/2017/12/05/libutp%E6%BA%90%E7%A0%81%E7%AE%80%E6%9E%90/\" target=\"_blank\" rel=\"noopener\">Calvin’s Marbles - libutp源码简析</a></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<p>在 <a href=\"/2018/07/20/tcp/\" title=\"TCP 温故知新\">TCP 温故知新</a>中回顾了 TCP，而这篇文章主要讲用于 BT 网络的基于 UDP 的运输层协议 µTP，同时顺便回顾 UDP。下面的内容更多是基于对 <a href=\"http://www.bittorrent.org/beps/bep_0029.html\" target=\"_blank\" rel=\"noopener\">BEP29</a> （BitTorrent 的 29 号提案，或者直翻为增强建议，类似的有 JEP，PEP）的理解。</p>\n<h2 id=\"名字探究\"><a href=\"#名字探究\" class=\"headerlink\" title=\"名字探究\"></a>名字探究</h2><p>  µTP 的主要文档 BEP29 的创建于 2009 年，姑且认为这也是设计完成的大致时间，µTP 在 uTorrent 的 1.8 中首次加入（2009 年）这个事实也佐证了这点。它的设计者包括：</p>\n<ul>\n<li><a href=\"https://en.wikipedia.org/wiki/Ludvig_Strigeus\" target=\"_blank\" rel=\"noopener\">Ludvig Strigeus</a>（μTorrent 作者，BitTorrent 公司 2006 年收购 μTorrent，目前在 Spotify 工作）</li>\n<li>Greg Hazel</li>\n<li><a href=\"https://www.linkedin.com/in/shalunov\" target=\"_blank\" rel=\"noopener\">Stanislav Shalunov</a>（µTP 中的拥塞算法 <a href=\"https://tools.ietf.org/html/rfc6817\" target=\"_blank\" rel=\"noopener\">LEDBAT</a> 主要作者，后来还创造了可以脱离现有蜂窝网络使用的 IM 应用 <a href=\"https://www.opengarden.com/firechat.html\" target=\"_blank\" rel=\"noopener\">FireChat</a> —— 它被多次用到”占中”这样的公民运动中）</li>\n<li>Arvid Norberg（libtorrent 开发者，目前在 <a href=\"https://blockstream.com/\" target=\"_blank\" rel=\"noopener\">Blockstream</a> 工作）</li>\n<li>Bram Cohen（BitTorrent 作者）</li>\n</ul>\n<h2 id=\"设计原因\"><a href=\"#设计原因\" class=\"headerlink\" title=\"设计原因\"></a>设计原因</h2><p>  在过去多年前，如果使用 BT 进行下载热门资源的话可以感受到到速度飞快，但是同时带来的问题就是如果想要同时看在线视频就会带来卡顿。问题在于 DSL 和 modem 的往往有一个和它们的发送速率不成比例的发送缓冲区，不成比例到可以容纳几秒钟的数据量。而 BT 往往会与许多 peer 建立 TCP 连接，在 TCP 将带宽均匀地分配到每个连接的前提下，BT 就占用了较多的带宽，但是其他诸如浏览网页、即时通讯这些场景的优先级实际上应该要比 BT 传输更高些，但是因为 BT 和 物理层的这种特性导致了其他服务有延迟，影响了使用 BT 时其他服务的体验。<br>  µTP 通过将 modem 的缓冲队列的大小作为一个控制因子来调整发送速率，当队列过大时，将会放慢发送速度。这种策略使得 BT 在没有竞争的情况下可以充分利用上传带宽，在有大量其他流量的情况下则放慢发送速率。<br>  上述时 Bittorrent 文档中的说法，但是实际上 µTP 是基于包的延时的，而不是基于队列大小的。而且 µTP 具体对拥塞算法 LEDBAT 的实现有与在 IETF 互联网草案 <a href=\"https://tools.ietf.org/html/rfc6817\" target=\"_blank\" rel=\"noopener\">RFC 6817</a> 中的描述有所区别（这里的实现指 C++ 版本的 <a href=\"https://github.com/bittorrent/libutp\" target=\"_blank\" rel=\"noopener\">libutp</a>，各个版本的实现不完全一致）。</p>\n<h2 id=\"UDP-和-µTP-首部\"><a href=\"#UDP-和-µTP-首部\" class=\"headerlink\" title=\"UDP 和 µTP 首部\"></a>UDP 和 µTP 首部</h2><p>  为了方便与 TCP 做简单的对比，把 UDP 的首部（前四个字节）与 µTP 的首部（剩余部分）放在了一个图中示意。从 UDP 首部字段数量皆可以发现 UDP 协议相对 TCP 协议是如此简单，以至于我们w可以将 TCP 协议看成是类似 µTP 协议一样的基于 UDP 协议的运输层协议。<br><img src=\"udp_utp_header.png\" alt=\"UDP Header And µTP Header\"></p>\n<h3 id=\"UDP-首部\"><a href=\"#UDP-首部\" class=\"headerlink\" title=\"UDP 首部\"></a>UDP 首部</h3><ul>\n<li><strong>源 / 目端口（Source / Destination port）</strong>：用于确认通信进程双方。源端口是可选的，如果设置了源端口，则接收方将其视为回复端口。如果不需要回复就不需要设置；</li>\n<li><strong>总长度（Length）</strong>：定义了 UDP 用户数据报的总长度，包括首部和数据。TCP 首部中是没有所谓“报文段总长度”的字段的，长度可以通过 IP 层的长度减去 IP 首部长度计算所得，所以一定程度上时冗余的，可以参考 Stack OverFlow 上的<a href=\"https://stackoverflow.com/a/16748680/5091903\" target=\"_blank\" rel=\"noopener\">相关讨论</a>；</li>\n<li><strong>校验和（Checksum）</strong>：用于对整个用户数据报的校验，通过 IP 位首部与和用户数据报计算得到；</li>\n</ul>\n<p>  可见 UDP 首部的这些字段在理论上可以是 TCP 首部字段的子集。因此我们可以粗略地讲 <strong>TCP 是基于 UDP 的传输层协议。</strong><br>  UDP 服务是一个“尽力而为”的服务，它<strong>没有流量控制</strong>，<strong>只能通过校验和进行差错控制，丢包不会知晓，也不会重传</strong>，也<strong>没有拥塞控制</strong>。</p>\n<h3 id=\"µTP-首部\"><a href=\"#µTP-首部\" class=\"headerlink\" title=\"µTP 首部\"></a>µTP 首部</h3><ul>\n<li><strong>version</strong>：版本号，现在为 1，<a href=\"https://github.com/boundary/wireshark/blob/master/epan/dissectors/packet-bt-utp.c\" target=\"_blank\" rel=\"noopener\">还有一个原始版本号 0 存在</a></li>\n<li><strong>connection_id</strong>：用于标记连接。<a href=\"http://www.calvinneo.com/2017/12/05/libutp%E6%BA%90%E7%A0%81%E7%AE%80%E6%9E%90/#utp-context%E7%9A%84%E6%88%90%E5%91%98\" target=\"_blank\" rel=\"noopener\">这个字段是必须的么?</a>；</li>\n<li><strong>timestamp_microseconds</strong>：发送数据包的时间，和计算延迟时间，rtt 相关；</li>\n<li><strong>timestamp_difference_microseconds</strong>：当前时间和上一次收到的包中的 timestamp_microseconds 之差；</li>\n<li><strong>wnd_size</strong>：表示另一端建议的窗口大小，相当于 TCP 中的接收窗口；</li>\n<li><strong>extension</strong>：代表第一个扩展的类型，0 表示没有扩展，1 表示 Selective ACKs（选择确认扩展）。</li>\n<li><strong>type</strong>：数据包的类型。可以有：<ul>\n<li>ST_DATA  = 0：承载有效数据的数据包；</li>\n<li>ST_FIN   = 1：终止连接。是通信单方发送的最后一个包，类似于 TCP 的 FIN 标记。但是发送 ST_FIN 的一方还是会等待可能丢失或者失序到达的包，即使收到了对方的 ST_FIN 包；</li>\n<li>ST_STATE = 2：用于报告状态，传输一个没有数据的 ACK。和 TCP 中未携带数据的 ACK 包一样，它不消耗序号；</li>\n<li>ST_RESET = 3：强制重置连接。类似 TCP 的 RST 标记。</li>\n<li>ST_SYN   = 4：发起连接。类似 TCP 的 SYN 标记。发起方会随机一个 connection_id ID 用于给接收方后续的回复使用。然后发起方之后的包中传输的 connection_id 为 ID + 1；</li>\n</ul>\n</li>\n<li><strong>seq_nr</strong>：表示这个数据包的序号。注意和 TCP 中代表字号号的序号有所不同。初始序号同样也是随机生成。</li>\n<li><strong>ack_nr</strong>：表示最后收到的数据包的seq_nr；</li>\n</ul>\n<h2 id=\"连接过程\"><a href=\"#连接过程\" class=\"headerlink\" title=\"连接过程\"></a>连接过程</h2><p>  图示为一次在 qBittorrent 中对一个种子开始 BT 下载二十秒左右后停止下载时，与其中一个 peer 的交互过程。<br><img src=\"wireshark.png\" alt=\"连接过程（以 connection_id 为 8671 和 8672 的这一个过程为例）\"></p>\n<h2 id=\"丢包\"><a href=\"#丢包\" class=\"headerlink\" title=\"丢包\"></a>丢包</h2><p>和丢包处理有一个和窗口相关的变量需要先进行说明：</p>\n<ul>\n<li><strong><em>max_window</em></strong>：定义了未被确认的字节的上限，相当与 TCP 中的拥塞窗口；</li>\n<li><strong><em>wnd_size</em></strong>：同首部中的 wnd_size，和 TCP 中相同，实际的发送窗口大小为 <code>min(max_windows, wnd_size)</code>；</li>\n<li><strong><em>cur_window</em></strong>：表示当前未被确认的字节的数量；</li>\n</ul>\n<p>当需要发送数据包时，仅当 <code>cur_window + packet_size &lt;= min(max_windows, wnd_size)</code> 成立，这个数据包才能被发送。</p>\n<ul>\n<li>当序号为 <code>seq_nr - cur_window</code> 的数据包（发送队列中年龄最大的未被确认的数据包，下一个理论上需要被确认的就是它）没有被确认，但是已经有至少三个序号大于它的数据包通过 Selective ACK 被确认，那么这个数据包被认为是丢失了。</li>\n<li>如果 <code>ack_nr + 1</code> 这个包已经发送了，而收到三个重复的 <code>ack_nr</code> 的 ACK，那么 <code>ack_nr + 1</code>这个包被认为是丢失了。</li>\n</ul>\n<p>如果检测到丢包，那么拥塞窗口 <strong>max_window</strong> 大小减半。</p>\n<h2 id=\"超时\"><a href=\"#超时\" class=\"headerlink\" title=\"超时\"></a>超时</h2><p>µTP 的超时计时和 TCP 中 RTO 计时器不太一样，RTO 计时器主要用于对 ACK 的计时，但是　µTP 的计时器则是指接收任何数据包超时时间，如果超时时间内没有任何数据包到达则超时，如果超时，则 <strong>packet_size</strong> 和 <strong>max_window</strong> 将都会被设置为最小数据包大小（150 字节）。 <strong>（疑问？：packet_size 的调整策略是什么）</strong></p>\n<h3 id=\"超时时间的计算\"><a href=\"#超时时间的计算\" class=\"headerlink\" title=\"超时时间的计算\"></a>超时时间的计算</h3><p>每当收到一个数据包的 ACK，就会更新往返时间（不考虑重传的包），往返时间用于计算超时时间。先说明下相关的变量：</p>\n<ul>\n<li><strong><em>rtt</em></strong>：往返时间；</li>\n<li><strong><em>rtt_var</em></strong>：往返时间差异；</li>\n<li><strong><em>packet_rtt</em></strong>：当前收到 ACK 对应的包的往返时间，即当前时间减去这个包发送时的时间，即首部中的 timestamp 字段记录的值。</li>\n<li><strong><em>timeout</em></strong>：超时时间；</li>\n</ul>\n<p>通过以下公式更新 rtt：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">delta = rtt - packet_rtt</span><br><span class=\"line\">rtt_var += (abs(delta) - rtt_var) / 4;</span><br><span class=\"line\">rtt += (packet_rtt - rtt) / 8;</span><br></pre></td></tr></table></figure></p>\n<p>正常情况下通过 rtt 计算得到 timeout（第一次由于没有 rtt，timeout 使用初始值 1000 ms，）：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">timeout = max(rtt + rtt_var * 4, 500);</span><br></pre></td></tr></table></figure></p>\n<p>如果遇到超时，则 timeout 翻倍。</p>\n<h2 id=\"拥塞控制\"><a href=\"#拥塞控制\" class=\"headerlink\" title=\"拥塞控制\"></a>拥塞控制</h2><p>在<strong>丢包</strong>和<strong>超时</strong>部分已经涉及到拥塞窗口的调整了。µTP 的拥塞控制可以理解为一种基于延迟的负反馈拥塞控制，通过延迟的变化控制窗口大小的变化，达到拥塞控制目的。计算窗口大小过程中的相关常量和变量的定义如下：</p>\n<ul>\n<li><strong><em>CONTROL_TARGET</em></strong>：µTP 所能接收的上行缓冲延迟，现在是 100 ms；</li>\n<li><strong><em>base_delay</em></strong>：两分钟内的收到的数据包的最低延迟；</li>\n<li><strong><em>our_delay</em></strong>：当前的数据包延迟；</li>\n<li><strong><em>off_target</em></strong>：实际延迟和目标延迟的差距。即<code>CONTROL_TARGET - our_delay</code>；</li>\n<li><strong><em>outstanding_packet</em></strong>：已经被发送但是未被确认的数据包；</li>\n</ul>\n<p>具体计算过程如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">delay_factor = off_target / CCONTROL_TARGET;</span><br><span class=\"line\">window_factor = outstanding_packet / max_window;</span><br><span class=\"line\">scaled_gain = MAX_CWND_INCREASE_PACKETS_PER_RTT * delay_factor * window_factor;</span><br><span class=\"line\"></span><br><span class=\"line\">max_window += scaled_gain;</span><br></pre></td></tr></table></figure></p>\n<p>当 <code>off_target &gt; 0</code> 时，当前包的延迟时间比设定的还小一些，那么窗口会缩小，发送速率就会放慢；反之，窗口增加，速率加快。</p>\n<h2 id=\"参考资料\"><a href=\"#参考资料\" class=\"headerlink\" title=\"参考资料\"></a>参考资料</h2><ol>\n<li><a href=\"http://www.bittorrent.org/beps/bep_0029.html\" target=\"_blank\" rel=\"noopener\">BitTorrent Enhancement Proposal 29 - µTorrent transport protocol</a></li>\n<li><a href=\"https://tools.ietf.org/html/rfc6817\" target=\"_blank\" rel=\"noopener\">RFC 6817 - Low Extra Delay Background Transport (LEDBAT)</a></li>\n<li><a href=\"http://www.calvinneo.com/2017/12/05/libutp%E6%BA%90%E7%A0%81%E7%AE%80%E6%9E%90/\" target=\"_blank\" rel=\"noopener\">Calvin’s Marbles - libutp源码简析</a></li>\n</ol>\n"}],"PostAsset":[{"_id":"source/_posts/tcp/wireshark.png","slug":"wireshark.png","post":"cjknq4rfq00092ofnwap3aifd","modified":0,"renderable":0},{"_id":"source/_posts/µtp/udp_utp_header.png","slug":"udp_utp_header.png","post":"cjknq4rfr000a2ofnm2u6ykix","modified":0,"renderable":0},{"_id":"source/_posts/µtp/wireshark.png","slug":"wireshark.png","post":"cjknq4rfr000a2ofnm2u6ykix","modified":0,"renderable":0},{"_id":"source/_posts/tcp/congestion_control_example.png","slug":"congestion_control_example.png","post":"cjknq4rfq00092ofnwap3aifd","modified":0,"renderable":0},{"_id":"source/_posts/tcp/sliding_window.png","slug":"sliding_window.png","post":"cjknq4rfq00092ofnwap3aifd","modified":0,"renderable":0},{"_id":"source/_posts/tcp/tcp_connection.png","slug":"tcp_connection.png","post":"cjknq4rfq00092ofnwap3aifd","modified":0,"renderable":0},{"_id":"source/_posts/tcp/tcp_header.png","slug":"tcp_header.png","post":"cjknq4rfq00092ofnwap3aifd","modified":0,"renderable":0},{"_id":"source/_posts/tcp/todo.mdx","slug":"todo.mdx","post":"cjknq4rfq00092ofnwap3aifd","modified":0,"renderable":0}],"PostCategory":[],"PostTag":[{"post_id":"cjknq4rf600022ofns11gjbgw","tag_id":"cjknq4rfa00052ofnslxxuhux","_id":"cjknq4rfd00072ofnsu3vysa2"},{"post_id":"cjknq4rf800042ofnduiqlpkx","tag_id":"cjknq4rfc00062ofnksz4270w","_id":"cjknq4rfh00082ofnh42u6dpp"},{"post_id":"cjknq4rfq00092ofnwap3aifd","tag_id":"cjknq4rfs000b2ofntq5mo0ql","_id":"cjknq4rfu000d2ofntmn4gglk"},{"post_id":"cjknq4rfr000a2ofnm2u6ykix","tag_id":"cjknq4rfs000b2ofntq5mo0ql","_id":"cjknq4rfv000f2ofn62byqmcl"},{"post_id":"cjknq4rfr000a2ofnm2u6ykix","tag_id":"cjknq4rfu000e2ofn1vz70ew1","_id":"cjknq4rfv000g2ofnjsrrz4kk"}],"Tag":[{"name":"BlockChain","_id":"cjknq4rfa00052ofnslxxuhux"},{"name":"Essay","_id":"cjknq4rfc00062ofnksz4270w"},{"name":"Network","_id":"cjknq4rfs000b2ofntq5mo0ql"},{"name":"BT","_id":"cjknq4rfu000e2ofn1vz70ew1"}]}}